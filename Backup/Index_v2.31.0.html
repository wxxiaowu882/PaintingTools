<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç«¥ç”»å¸ˆå´æ™“çš„ç»˜ç”»å·¥ä½œå° v2.18</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #e67e22;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --paper-ratio: 0.716; /* ç«–å‘æ¯”ä¾‹ï¼š265mm / 370mm */
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            text-align: center; 
            padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            overflow-x: hidden;
        }
        
        .container { 
            max-width: 100%; margin: 0 auto; background: var(--card-bg); padding: 0; box-shadow: none;
        }
        
        header { padding: 10px 15px 0 15px; }
        h1 { margin: 0 0 5px 0; color: #333; letter-spacing: -0.5px; font-size: 1.2rem; }
        
        .tabs { display: flex; justify-content: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding: 0 10px; }
        .tab-btn { flex: 1; max-width: 150px; padding: 12px 0; border: none; background: none; font-size: 16px; font-weight: 600; color: #888; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); color: #333; }
        .tab-content { display: none; animation: fadeIn 0.4s ease; padding-bottom: 40px; }
        .tab-content.active { display: block; }

        .controls { background: #f9f9f9; padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; }
        .control-row { display: flex; flex-wrap: wrap; gap: 8px; justify-content: space-between; align-items: center; width: 100%; }
        .control-group { display: flex; flex-direction: column; align-items: flex-start; gap: 5px; }
        .control-group.full-width { width: 100%; max-width: 100%; }
        
        .btn { padding: 8px 0; width: 100%; background-color: var(--primary-color); color: #ffffff !important; border: none; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 5px; white-space: nowrap; height: 40px; }
        .btn:active { opacity: 0.8; }
        .btn-orange { background-color: var(--secondary-color); }
        .btn-outline { background-color: #fff; border: 1px solid #ddd; color: #555 !important; box-shadow: none; }
        .btn-outline-orange { border-color: var(--secondary-color); color: var(--secondary-color) !important; }
        
        .btn-sm { padding: 0 12px; height: 32px; font-size: 13px; border-radius: 4px; width: auto; background: #eee; color: #333 !important; }
        .btn-micro { width: 36px; height: 36px; padding: 0; border-radius: 50%; background: #fff; border: 1px solid #ddd; color: #555; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }

        input[type="file"] { display: none; }
        
        .color-picker-wrapper { width: 36px; height: 36px; border-radius: 50%; overflow: hidden; border: 2px solid #fff; box-shadow: 0 0 0 1px #ddd; position: relative; flex-shrink: 0; }
        input[type="color"] { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; padding: 0; margin: 0; border: none; cursor: pointer; }

        .slider-container { display: flex; align-items: center; gap: 8px; flex: 1; background: #fff; padding: 0 10px; border-radius: 20px; border: 1px solid #eee; height: 36px; }
        input[type="range"] { flex: 1; accent-color: var(--primary-color); cursor: pointer; height: 100%; width: 100%; margin: 0; }

        /* ç”»å¸ƒè§†çª—å®¹å™¨ */
        .canvas-window { 
            position: relative; 
            width: 100vw; 
            height: calc(100vw / var(--paper-ratio)); 
            max-height: 75vh; 
            background: #eef2f5; 
            overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
            user-select: none; cursor: default;
            margin: 0 auto;
            border-top: 1px solid #eee; border-bottom: 1px solid #eee;
        }
        
        .canvas-window.has-image { background: #333; }
        
        canvas { 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            background: #fff; 
            transform-origin: center center; 
        }

        .bottom-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: #fff; border-top: 1px solid #eee; width: 100%;
        }
        .zoom-controls { display: flex; align-items: center; gap: 10px; flex: 1; justify-content: center; }
        .zoom-display { font-size: 12px; color: #999; width: 40px; text-align: center; }

        .mode-switch {
            display: flex; gap: 0; border: 1px solid var(--primary-color); border-radius: 6px; overflow: hidden; width: 100%;
        }
        .mode-btn {
            padding: 8px; border: none; background: #fff; color: var(--primary-color); cursor: pointer; font-size: 13px; font-weight: 600; flex: 1; margin: 0; height: auto; border-radius: 0;
        }
        .mode-btn.active { background: var(--primary-color); color: #fff; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ç«¥ç”»å¸ˆå´æ™“çš„ç»˜ç”»å·¥ä½œå°</h1>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('grid')">ğŸ“ ç½‘æ ¼èµ·å‹</button>
            <button class="tab-btn" onclick="switchTab('poster')">ğŸ¨ è‰²é˜¶æ¦‚æ‹¬</button>
        </div>
    </header>

    <!-- åŠŸèƒ½åŒº1ï¼šç½‘æ ¼å·¥å…· -->
    <div id="grid-content" class="tab-content active">
        <div class="controls">
            <!-- 1. æ–‡ä»¶ä¸Šä¼  -->
            <div class="control-row">
                <label class="btn btn-upload">
                    ğŸ“‚ æ‰“å¼€ç›¸å†Œå›¾ç‰‡
                    <input type="file" id="gridImageInput" accept="image/*">
                </label>
            </div>

            <!-- 2. ç½‘æ ¼è°ƒæ•´ (Max 15, Default 3) -->
            <div class="control-row">
                 <div class="control-group full-width" style="flex-direction: row; align-items: center;">
                     <!-- å–è‰²æŒ‰é’®å·²ç»ç§»åˆ°ä¸‹é¢ä¸€è¡Œï¼Œè¿™é‡Œç§»é™¤ -->
                     <div class="slider-container">
                        <button class="btn-micro" onclick="adjustGridSize(-0.1)">-</button>
                        <input type="range" id="gridSize" min="2" max="15" value="3" step="0.05" oninput="drawGrid()">
                        <button class="btn-micro" onclick="adjustGridSize(0.1)">+</button>
                    </div>
                    <span id="gridSizeVal" style="font-size:12px; color:#999; width: 30px;">3.0</span>
                </div>
            </div>
            
            <!-- å–è‰²æŒ‰é’®å’Œæ–¹æ ¼å¤é€‰æ¡† -->
            <div class="control-row">
                <div class="control-group full-width" style="flex-direction: row; align-items: center; justify-content: center; gap: 15px;">
                    <!-- æ­£æ–¹å½¢å–è‰²æŒ‰é’® -->
                    <div class="color-picker-wrapper" title="ç½‘æ ¼é¢œè‰²" style="border-radius: 8px;">
                        <input type="color" id="gridColor" value="#ff0000" oninput="drawGrid()">
                    </div>
                    <!-- æ–¹æ ¼å¤é€‰æ¡† -->
                    <label style="display: flex; align-items: center; justify-content:center; padding:0 10px; background:#fff; border-radius:20px; height: 36px; border:1px solid #eee; flex-shrink: 0;">
                        <input type="checkbox" id="squareGridCheck" onchange="toggleSquareGrid()" style="width: 20px; height:20px; margin-right: 5px;"> 
                        <span style="font-size:12px; color:#555">æ–¹æ ¼</span>
                    </label>
                </div>
            </div>
            
            <!-- 3. æ¨¡å¼åˆ‡æ¢ -->
            <div class="control-row">
                <div class="mode-switch">
                    <button class="mode-btn active" id="modeMove" onclick="setGridMode('move')">âœ‹ åŒæŒ‡ç§»åŠ¨è§†å›¾</button>
                    <button class="mode-btn" id="modeGrid" onclick="setGridMode('grid')">ğŸ“ åŒæŒ‡è°ƒæ•´ç½‘æ ¼</button>
                </div>
            </div>
        </div>
        
        <!-- è§†çª— -->
        <div class="canvas-window" id="gridWindow">
            <div style="color:#999; font-size: 0.9rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;" 
                 id="gridPlaceholder" 
                 onclick="document.getElementById('gridImageInput').click()">
                <div style="font-size: 60px; color: #4a90e2; margin-bottom: 15px; line-height: 1;">+</div>
                <div>è¯·é€‰æ‹©å›¾ç‰‡</div>
                <div style="font-size: 0.8rem; margin-top: 5px;">åŒæŒ‡æ“ä½œ</div>
            </div>
            <canvas id="gridCanvas" style="display:none;"></canvas>
        </div>

        <!-- åº•éƒ¨å·¥å…· -->
        <div class="bottom-toolbar">
            <button class="btn-sm" onclick="resetGridOffset()">é‡ç½®ç½‘æ ¼</button>
            <div class="zoom-controls">
                <button class="btn-micro" onclick="updateZoom('grid', -0.1)">-</button>
                <span class="zoom-display" id="gridZoomVal">100%</span>
                <button class="btn-micro" onclick="updateZoom('grid', 0.1)">+</button>
            </div>
            <div style="display: flex; gap: 5px;">
                <button class="btn-sm" onclick="fitView('grid')">é€‚åº”</button>
            </div>
        </div>
        
        <div style="padding: 10px;">
            <button class="btn btn-outline" style="color:var(--primary-color)!important; background:#fff;" onclick="downloadCanvas('gridCanvas', 'ç½‘æ ¼å‚è€ƒå›¾.jpg')">â¬‡ï¸ ä¿å­˜ç»“æœå›¾</button>
        </div>
    </div>

    <!-- åŠŸèƒ½åŒº2ï¼šè‰²é˜¶å·¥å…· -->
    <div id="poster-content" class="tab-content">
        <div class="controls">
            <div class="control-row">
                <label class="btn btn-orange">
                    ğŸ“‚ æ‰“å¼€ç›¸å†Œå›¾ç‰‡
                    <input type="file" id="posterImageInput" accept="image/*">
                </label>
            </div>
            
            <div class="control-row">
                <div class="control-group full-width" style="flex-direction: row; align-items: center;">
                    <label style="display: flex; align-items: center; justify-content:center; padding:0 10px; background:#fff; border-radius:20px; height: 36px; border:1px solid #eee; flex-shrink: 0;">
                        <input type="checkbox" id="grayscaleCheck" onchange="processPoster()" style="width: 20px; height:20px; margin-right: 5px;"> 
                        <span style="font-size:12px; color:#555">é»‘ç™½</span>
                    </label>
                    
                    <div class="slider-container" style="border-color: #fce5cd;">
                        <button class="btn-micro" onclick="adjustPosterLevel(-1)">-</button>
                        <input type="range" id="posterLevel" min="2" max="20" value="12" step="1" oninput="processPoster()" style="accent-color: var(--secondary-color);">
                        <button class="btn-micro" onclick="adjustPosterLevel(1)">+</button>
                    </div>
                    <span id="posterLevelVal" style="font-size:12px; color:#e67e22; width: 20px;">12</span>
                </div>
            </div>
        </div>

        <div class="canvas-window" id="posterWindow">
            <div style="color:#999; font-size: 0.9rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;" 
                 id="posterPlaceholder" 
                 onclick="document.getElementById('posterImageInput').click()">
                <div style="font-size: 60px; color: #e67e22; margin-bottom: 15px; line-height: 1;">+</div>
                <div>è¯·é€‰æ‹©å›¾ç‰‡</div>
            </div>
            <canvas id="posterCanvas" style="display:none;"></canvas>
        </div>

        <div class="bottom-toolbar">
            <div style="width: 60px;"></div>
            <div class="zoom-controls">
                <button class="btn-micro" onclick="updateZoom('poster', -0.1)">-</button>
                <span class="zoom-display" id="posterZoomVal">100%</span>
                <button class="btn-micro" onclick="updateZoom('poster', 0.1)">+</button>
            </div>
            <div style="display: flex; gap: 5px;">
                <button class="btn-sm" onclick="fitView('poster')">é€‚åº”</button>
            </div>
        </div>

        <div style="padding: 10px; display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-outline" style="color:var(--secondary-color)!important; border-color:var(--secondary-color); background:#fff; flex: 1;" onclick="saveFourPanelComparison()">ğŸ“Š ä¿å­˜4è”å¯¹æ¯”å›¾</button>
            <button class="btn btn-outline" style="color:var(--secondary-color)!important; border-color:var(--secondary-color); background:#fff; flex: 1;" onclick="downloadCanvas('posterCanvas', 'è‰²å—æ¦‚æ‹¬å›¾.jpg')">â¬‡ï¸ ä¿å­˜ç»“æœå›¾</button>
        </div>
    </div>

</div>

<script>
    // === çŠ¶æ€ç®¡ç† ===
    const state = {
        currentGridMode: 'move', // 'move' (default) or 'grid'
        grid: { scale: 1, panX: 0, panY: 0, isDraggingImg: false, isDraggingGrid: false, startX: 0, startY: 0, minScale: 1, lastDist: 0, lastCenter: {x:0, y:0}, density: 3.0, isSquareGrid: false },
        poster: { scale: 1, panX: 0, panY: 0, isDraggingImg: false, startX: 0, startY: 0, minScale: 1, lastDist: 0, lastCenter: {x:0, y:0} }
    };

    function setGridMode(mode) {
        state.currentGridMode = mode;
        document.getElementById('modeMove').className = mode === 'move' ? 'mode-btn active' : 'mode-btn';
        document.getElementById('modeGrid').className = mode === 'grid' ? 'mode-btn active' : 'mode-btn';
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if(tabId === 'grid') {
            document.querySelector('.tabs button:nth-child(1)').classList.add('active');
            document.getElementById('grid-content').classList.add('active');
        } else {
            document.querySelector('.tabs button:nth-child(2)').classList.add('active');
            document.getElementById('poster-content').classList.add('active');
        }
    }

    // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
    function generateTimestampFilename(baseName) {
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„.jpgæ‰©å±•å
        if (baseName.endsWith('.jpg')) {
            baseName = baseName.slice(0, -4);
        }
        
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0');      // æœˆä»½ (01-12)
        const day = String(now.getDate()).padStart(2, '0');            // æ—¥æœŸ (01-31)
        const hours = String(now.getHours()).padStart(2, '0');         // å°æ—¶ (00-23)
        const minutes = String(now.getMinutes()).padStart(2, '0');     // åˆ†é’Ÿ (00-59)
        const seconds = String(now.getSeconds()).padStart(2, '0');     // ç§’ (00-59)
        
        // æ ¼å¼ï¼šåŸºç¡€åç§°_æœˆæ—¥_æ—¶_åˆ†_ç§’.jpg
        return `${baseName}_${month}${day}_${hours}_${minutes}_${seconds}.jpg`;
    }

    // é™åˆ¶Canvaså°ºå¯¸ï¼Œé¿å…è¶…å‡ºæµè§ˆå™¨é™åˆ¶ï¼ˆç‰¹åˆ«æ˜¯iOSè®¾å¤‡ï¼‰
    function limitCanvasSize(canvas, maxWidth = 2560, maxHeight = 2560) {
        const width = canvas.width;
        const height = canvas.height;
        
        // å¦‚æœå°ºå¯¸å·²ç»åœ¨é™åˆ¶å†…ï¼Œç›´æ¥è¿”å›
        if (width <= maxWidth && height <= maxHeight) {
            return canvas;
        }
        
        // è®¡ç®—ç­‰æ¯”ä¾‹ç¼©æ”¾å°ºå¯¸
        const ratio = Math.min(maxWidth / width, maxHeight / height);
        const newWidth = Math.floor(width * ratio);
        const newHeight = Math.floor(height * ratio);
        
        // åˆ›å»ºæ–°Canvaså¹¶ç»˜åˆ¶ç¼©æ”¾åçš„å›¾åƒ
        const newCanvas = document.createElement('canvas');
        newCanvas.width = newWidth;
        newCanvas.height = newHeight;
        const ctx = newCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, 0, width, height, 0, 0, newWidth, newHeight);
        
        return newCanvas;
    }

    // === æ ¸å¿ƒä¿®å¤ï¼šä¸‹è½½åŠŸèƒ½ (æ‰€è§å³æ‰€å¾—) ===
    function downloadCanvas(canvasId, baseName) {
        const type = canvasId === 'gridCanvas' ? 'grid' : 'poster';
        // å…³é”®ä¿®å¤ï¼šä»å…¨å±€å˜é‡è·å–æºå›¾ç‰‡ï¼Œè€Œä¸æ˜¯state
        const sourceImg = type === 'grid' ? gridOriginalImg : posterOriginalImg;
        
        if (!sourceImg) { alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼'); return; }
        
        const stage = document.getElementById(type + 'Window');
        const sourceCanvas = document.getElementById(canvasId);
        const s = state[type];
        
        // åˆ¤æ–­å›¾ç‰‡æ˜¯å¦å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´
        const scaledWidth = sourceCanvas.width * s.scale;
        const scaledHeight = sourceCanvas.height * s.scale;
        const imgLeft = (stage.clientWidth / 2) - (scaledWidth / 2) + s.panX;
        const imgTop = (stage.clientHeight / 2) - (scaledHeight / 2) + s.panY;
        
        const isFullyCovered = imgLeft <= 0 && imgTop <= 0 && 
                               imgLeft + scaledWidth >= stage.clientWidth && 
                               imgTop + scaledHeight >= stage.clientHeight;
        
        // åˆ›å»ºå¯¼å‡º Canvas
        const exportCanvas = document.createElement('canvas');
        
        if (isFullyCovered) {
            // å›¾ç‰‡å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜æ‰€è§å³æ‰€å¾—ï¼ˆå½“å‰è§†çª—å†…å®¹ï¼‰
            exportCanvas.width = stage.clientWidth;
            exportCanvas.height = stage.clientHeight;
            const ctx = exportCanvas.getContext('2d');
            
            // å¡«å……ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            ctx.save();
            
            // 1. ç§»åŠ¨åˆ°ä¸­å¿ƒ
            ctx.translate(exportCanvas.width / 2, exportCanvas.height / 2);
            
            // 2. åº”ç”¨å˜æ¢
            ctx.translate(s.panX, s.panY);
            ctx.scale(s.scale, s.scale);
            
            // 3. ç»˜åˆ¶æºå†…å®¹ (å›åˆ°å·¦ä¸Šè§’)
            ctx.translate(-sourceCanvas.width / 2, -sourceCanvas.height / 2);
            ctx.drawImage(sourceCanvas, 0, 0);
            
            ctx.restore();
        } else {
            // å›¾ç‰‡æœªå®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜å®é™…å›¾ç‰‡ï¼ˆä¸è£å‰ªï¼‰
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;
            const ctx = exportCanvas.getContext('2d');
            
            // ç›´æ¥ç»˜åˆ¶æºç”»å¸ƒå†…å®¹ï¼ˆä¸åº”ç”¨å˜æ¢ï¼‰
            ctx.drawImage(sourceCanvas, 0, 0);
        }
        
        // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
        const filename = generateTimestampFilename(baseName);
        
        const link = document.createElement('a');
        link.download = filename;
        link.href = exportCanvas.toDataURL('image/jpeg', 0.95);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // === ç¼©æ”¾ä¸è§†å›¾æ§åˆ¶ç³»ç»Ÿ ===
    function calculateMinScale(type) {
        const win = document.getElementById(type + 'Window');
        const canvas = document.getElementById(type + 'Canvas');
        if(canvas.width === 0) return 1;
        return Math.min(win.clientWidth / canvas.width, win.clientHeight / canvas.height);
    }

    function updateCanvasTransform(type) {
        const s = state[type];
        const canvas = document.getElementById(type + 'Canvas');
        const zoomVal = document.getElementById(type + 'ZoomVal');
        canvas.style.transform = `translate3d(${s.panX}px, ${s.panY}px, 0) scale(${s.scale})`;
        zoomVal.innerText = Math.round(s.scale / s.minScale * 100) + '%';
    }

    function updateZoom(type, delta, isAbsolute = false) {
        const s = state[type];
        if (!s.minScale || s.minScale === 1) s.minScale = calculateMinScale(type);
        
        let newScale;
        if (isAbsolute) newScale = delta;
        else newScale = s.scale + (delta * s.minScale);

        if(newScale < s.minScale) newScale = s.minScale; 
        if(newScale > s.minScale * 10) newScale = s.minScale * 10;
        
        s.scale = newScale;
        if (Math.abs(s.scale - s.minScale) < 0.001) { s.panX = 0; s.panY = 0; }
        updateCanvasTransform(type);
    }

    function fitView(type) {
        const s = state[type];
        s.minScale = calculateMinScale(type);
        s.scale = s.minScale;
        s.panX = 0; s.panY = 0;
        updateCanvasTransform(type);
    }
    
    document.addEventListener('fullscreenchange', handleFsChange);
    document.addEventListener('webkitfullscreenchange', handleFsChange);
    function handleFsChange() {
        setTimeout(() => {
            if(state.grid.minScale) fitView('grid');
            if(state.poster.minScale) fitView('poster');
        }, 200);
    }

    // === æ ¸å¿ƒé€»è¾‘ ===
    const gridInput = document.getElementById('gridImageInput');
    const gridCanvas = document.getElementById('gridCanvas');
    const gridCtx = gridCanvas.getContext('2d');
    let gridOriginalImg = null; let gridOffsetX = 0; let gridOffsetY = 0;

    gridInput.addEventListener('change', (e) => handleImageUpload(e, 'grid'));

    function handleImageUpload(e, type) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                if(type === 'grid') {
                    gridOriginalImg = img;
                    document.getElementById('gridPlaceholder').style.display = 'none';
                    gridCanvas.style.display = 'block';
                    document.getElementById('gridWindow').classList.add('has-image');
                    gridOffsetX = 0; gridOffsetY = 0;
                    drawGrid(); setTimeout(() => fitView('grid'), 50); 
                } else {
                    posterOriginalImg = img;
                    document.getElementById('posterPlaceholder').style.display = 'none';
                    posterCanvas.style.display = 'block';
                    document.getElementById('posterWindow').classList.add('has-image');
                    processPoster(); setTimeout(() => fitView('poster'), 50);
                }
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    function adjustGridSize(delta) {
        const slider = document.getElementById('gridSize');
        let newVal = parseFloat(slider.value) + delta;
        if(newVal < 2) newVal = 2; if(newVal > 15) newVal = 15;
        slider.value = newVal; drawGrid();
    }

    function resetGridOffset() { 
        gridOffsetX = 0; gridOffsetY = 0; 
        document.getElementById('gridSize').value = 3;
        drawGrid(); 
    }

    function drawGrid() {
        if (!gridOriginalImg) return;
        const size = parseFloat(document.getElementById('gridSize').value);
        const color = document.getElementById('gridColor').value;
        document.getElementById('gridSizeVal').textContent = size.toFixed(1);
        gridCanvas.width = gridOriginalImg.width;
        gridCanvas.height = gridOriginalImg.height;
        gridCtx.drawImage(gridOriginalImg, 0, 0);
        gridCtx.strokeStyle = color;
        gridCtx.lineWidth = Math.max(1.5, gridOriginalImg.width / 800);
        gridCtx.beginPath();
        
        if (state.grid.isSquareGrid) {
            // æ­£æ–¹å½¢ç½‘æ ¼æ¨¡å¼
            const shortSide = Math.min(gridCanvas.width, gridCanvas.height);
            const squareSize = shortSide / size; // æ­£æ–¹å½¢è¾¹é•¿
            // ç¡®å®šçŸ­è¾¹æ˜¯å®½åº¦è¿˜æ˜¯é«˜åº¦
            const isWidthShort = gridCanvas.width <= gridCanvas.height;
            
            if (isWidthShort) {
                // å®½åº¦æ˜¯çŸ­è¾¹ï¼Œä¿æŒæ¨ªå‘çº¿æ¡æ•°é‡ä¸å˜ï¼Œè°ƒæ•´çºµå‘çº¿æ¡
                const stepX = gridCanvas.width / size;
                const stepY = squareSize; // çºµå‘æ­¥é•¿ä¸ºæ­£æ–¹å½¢è¾¹é•¿
                // æ¨ªå‘çº¿æ¡ï¼ˆçŸ­è¾¹æ–¹å‘ï¼‰
                let startX = gridOffsetX % stepX; if (startX > 0) startX -= stepX;
                for (let x = startX; x < gridCanvas.width; x += stepX) {
                    gridCtx.moveTo(x, 0);
                    gridCtx.lineTo(x, gridCanvas.height);
                }
                // çºµå‘çº¿æ¡ï¼ˆé•¿è¾¹æ–¹å‘ï¼‰
                let startY = gridOffsetY % stepY; if (startY > 0) startY -= stepY;
                for (let y = startY; y < gridCanvas.height; y += stepY) {
                    gridCtx.moveTo(0, y);
                    gridCtx.lineTo(gridCanvas.width, y);
                }
            } else {
                // é«˜åº¦æ˜¯çŸ­è¾¹ï¼Œä¿æŒçºµå‘çº¿æ¡æ•°é‡ä¸å˜ï¼Œè°ƒæ•´æ¨ªå‘çº¿æ¡
                const stepX = squareSize; // æ¨ªå‘æ­¥é•¿ä¸ºæ­£æ–¹å½¢è¾¹é•¿
                const stepY = gridCanvas.height / size;
                // æ¨ªå‘çº¿æ¡ï¼ˆé•¿è¾¹æ–¹å‘ï¼‰
                let startX = gridOffsetX % stepX; if (startX > 0) startX -= stepX;
                for (let x = startX; x < gridCanvas.width; x += stepX) {
                    gridCtx.moveTo(x, 0);
                    gridCtx.lineTo(x, gridCanvas.height);
                }
                // çºµå‘çº¿æ¡ï¼ˆçŸ­è¾¹æ–¹å‘ï¼‰
                let startY = gridOffsetY % stepY; if (startY > 0) startY -= stepY;
                for (let y = startY; y < gridCanvas.height; y += stepY) {
                    gridCtx.moveTo(0, y);
                    gridCtx.lineTo(gridCanvas.width, y);
                }
            }
        } else {
            // é•¿æ–¹å½¢ç½‘æ ¼æ¨¡å¼ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
            const stepX = gridCanvas.width / size;
            const stepY = gridCanvas.height / size;
            let startX = gridOffsetX % stepX; if (startX > 0) startX -= stepX;
            for (let x = startX; x < gridCanvas.width; x += stepX) { gridCtx.moveTo(x, 0); gridCtx.lineTo(x, gridCanvas.height); }
            let startY = gridOffsetY % stepY; if (startY > 0) startY -= stepY;
            for (let y = startY; y < gridCanvas.height; y += stepY) { gridCtx.moveTo(0, y); gridCtx.lineTo(gridCanvas.width, y); }
        }
        gridCtx.stroke();
    }

    function toggleSquareGrid() {
        // åˆ‡æ¢æ­£æ–¹å½¢ç½‘æ ¼çŠ¶æ€
        const checkbox = document.getElementById('squareGridCheck');
        state.grid.isSquareGrid = checkbox.checked;
        // é‡æ–°ç»˜åˆ¶ç½‘æ ¼
        drawGrid();
    }

    // === æ‰‹åŠ¿æ§åˆ¶æ ¸å¿ƒ ===
    
    function getCenter(touches) {
        return {
            x: (touches[0].clientX + touches[1].clientX) / 2,
            y: (touches[0].clientY + touches[1].clientY) / 2
        };
    }
    
    function getDistance(touches) {
        return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
    }

    function handleStart(e, type) {
        if (!e.touches) {
            if (type === 'grid' && !gridOriginalImg) return;
            if (type === 'poster' && !posterOriginalImg) return;
            state[type].startX = e.clientX;
            state[type].startY = e.clientY;
            state[type].isDraggingImg = (type === 'poster' || state.currentGridMode === 'move');
            state[type].isDraggingGrid = (type === 'grid' && state.currentGridMode === 'grid');
            return;
        }

        if (e.touches.length === 2) {
            if (type === 'grid' && !gridOriginalImg) return;
            if (type === 'poster' && !posterOriginalImg) return;
            
            const s = state[type];
            s.lastDist = getDistance(e.touches);
            s.lastCenter = getCenter(e.touches);
            
            s.isDraggingImg = (type === 'poster' || state.currentGridMode === 'move');
            s.isDraggingGrid = (type === 'grid' && state.currentGridMode === 'grid');
        }
    }

    function handleMove(e, type) {
        if (!e.touches) {
            const s = state[type];
            if (s.isDraggingGrid) {
                updateGridOffset(e.clientX - s.startX, e.clientY - s.startY);
                s.startX = e.clientX; s.startY = e.clientY;
            } else if (s.isDraggingImg) {
                updateImgPan(type, e.clientX - s.startX, e.clientY - s.startY);
                s.startX = e.clientX; s.startY = e.clientY;
            }
            return;
        }

        if (e.touches.length === 2) {
            e.preventDefault(); 
            const s = state[type];
            
            // 1. å¦‚æœæ˜¯ç½‘æ ¼æ¨¡å¼ï¼Œåªç§»åŠ¨ç½‘æ ¼ (ä¿®æ­£: ç¦æ­¢ç¼©æ”¾)
            if (s.isDraggingGrid) {
                const currentCenter = getCenter(e.touches);
                const deltaX = currentCenter.x - s.lastCenter.x;
                const deltaY = currentCenter.y - s.lastCenter.y;
                updateGridOffset(deltaX, deltaY);
                s.lastCenter = currentCenter;
                return; // å…³é”®ï¼šç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œç¼©æ”¾
            }

            // 2. æ­£å¸¸ç§»åŠ¨è§†å›¾æ¨¡å¼ (ç¼©æ”¾+ç§»åŠ¨)
            const currentDist = getDistance(e.touches);
            const scaleRatio = currentDist / s.lastDist;
            const newScale = s.scale * scaleRatio;
            updateZoom(type, newScale, true);
            s.lastDist = currentDist;

            const currentCenter = getCenter(e.touches);
            const deltaX = currentCenter.x - s.lastCenter.x;
            const deltaY = currentCenter.y - s.lastCenter.y;
            
            if (s.isDraggingImg) {
                updateImgPan(type, deltaX, deltaY);
            }
            s.lastCenter = currentCenter;
        }
    }

    function updateGridOffset(dx, dy) {
        const rect = gridCanvas.getBoundingClientRect();
        const scaleX = gridCanvas.width / rect.width;
        const scaleY = gridCanvas.height / rect.height;
        gridOffsetX += dx * scaleX;
        gridOffsetY += dy * scaleY;
        drawGrid();
    }

    function updateImgPan(type, dx, dy) {
        const s = state[type];
        s.panX += dx;
        s.panY += dy;
        updateCanvasTransform(type);
    }

    function handleEnd(e) {
        state.grid.isDraggingImg = false;
        state.grid.isDraggingGrid = false;
        state.poster.isDraggingImg = false;
    }

    // ç»‘å®šäº‹ä»¶
    const gridWin = document.getElementById('gridWindow');
    const posterWin = document.getElementById('posterWindow');

    gridWin.addEventListener('mousedown', (e) => handleStart(e, 'grid'));
    gridWin.addEventListener('mousemove', (e) => handleMove(e, 'grid'));
    gridWin.addEventListener('touchstart', (e) => handleStart(e, 'grid'), {passive: false});
    gridWin.addEventListener('touchmove', (e) => handleMove(e, 'grid'), {passive: false});

    posterWin.addEventListener('mousedown', (e) => handleStart(e, 'poster'));
    posterWin.addEventListener('mousemove', (e) => handleMove(e, 'poster'));
    posterWin.addEventListener('touchstart', (e) => handleStart(e, 'poster'), {passive: false});
    posterWin.addEventListener('touchmove', (e) => handleMove(e, 'poster'), {passive: false});

    window.addEventListener('mouseup', handleEnd);
    window.addEventListener('touchend', handleEnd);


    // === è‰²é˜¶å·¥å…·é€»è¾‘ ===
    const posterInput = document.getElementById('posterImageInput');
    const posterCanvas = document.getElementById('posterCanvas');
    const posterCtx = posterCanvas.getContext('2d');
    let posterOriginalImg = null;

    posterInput.addEventListener('change', (e) => handleImageUpload(e, 'poster'));

    function adjustPosterLevel(delta) {
        const slider = document.getElementById('posterLevel');
        let val = parseInt(slider.value) + delta;
        if(val < 2) val = 2; if(val > 20) val = 20;
        slider.value = val; processPoster();
    }

    function processPoster() {
        if (!posterOriginalImg) return;
        const levels = parseInt(document.getElementById('posterLevel').value);
        const isGray = document.getElementById('grayscaleCheck').checked;
        document.getElementById('posterLevelVal').textContent = levels;
        posterCanvas.width = posterOriginalImg.width;
        posterCanvas.height = posterOriginalImg.height;
        posterCtx.drawImage(posterOriginalImg, 0, 0);
        const imageData = posterCtx.getImageData(0, 0, posterCanvas.width, posterCanvas.height);
        const data = imageData.data;
        const step = 255 / (levels - 1);
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i], g = data[i+1], b = data[i+2];
            if (isGray) {
                const avg = 0.299*r + 0.587*g + 0.114*b;
                r=g=b=avg;
            }
            r = Math.floor(r / step) * step;
            g = Math.floor(g / step) * step;
            b = Math.floor(b / step) * step;
            data[i] = r; data[i+1] = g; data[i+2] = b;
        }
        posterCtx.putImageData(imageData, 0, 0);
    }

    // === 4è”å¯¹æ¯”å›¾åŠŸèƒ½ ===
    // åŠ è½½æç¤ºæ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 16px;
            color: #333;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);

    // æ˜¾ç¤º/éšè—åŠ è½½æç¤º
    function showLoading(message = 'æ­£åœ¨ç”Ÿæˆ4è”å¯¹æ¯”å›¾...') {
        let overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner"></div>
                <div>${message}</div>
            `;
            document.body.appendChild(overlay);
        }
        overlay.style.display = 'flex';
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
    }

    // å¯æŒ‡å®šè‰²é˜¶å€¼çš„å¤„ç†å‡½æ•°
    function processWithLevel(sourceCanvas, level, isGray) {
        const canvas = document.createElement('canvas');
        canvas.width = sourceCanvas.width;
        canvas.height = sourceCanvas.height;
        const ctx = canvas.getContext('2d');
        
        // ç»˜åˆ¶åŸå§‹å›¾ç‰‡
        ctx.drawImage(sourceCanvas, 0, 0);
        
        // å¦‚æœlevelä¸º0ï¼Œè¡¨ç¤ºä¸è¿›è¡Œè‰²é˜¶å¤„ç†ï¼ˆä½†åº”ç”¨é»‘ç™½æ¨¡å¼ï¼‰
        if (level === 0) {
            if (isGray) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    const avg = 0.299*r + 0.587*g + 0.114*b;
                    data[i] = data[i+1] = data[i+2] = avg;
                }
                ctx.putImageData(imageData, 0, 0);
            }
            return canvas;
        }
        
        // è‰²é˜¶å¤„ç†
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const step = 255 / (level - 1);
        
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i], g = data[i+1], b = data[i+2];
            if (isGray) {
                const avg = 0.299*r + 0.587*g + 0.114*b;
                r = g = b = avg;
            }
            r = Math.floor(r / step) * step;
            g = Math.floor(g / step) * step;
            b = Math.floor(b / step) * step;
            data[i] = r; data[i+1] = g; data[i+2] = b;
        }
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }

    // è·å–å¯¼å‡ºCanvasï¼ˆå¤ç”¨downloadCanvasçš„é€»è¾‘ï¼‰
    function getExportCanvas(sourceCanvas, type) {
        const stage = document.getElementById(type + 'Window');
        const s = state[type];
        
        // åˆ¤æ–­å›¾ç‰‡æ˜¯å¦å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´
        const scaledWidth = sourceCanvas.width * s.scale;
        const scaledHeight = sourceCanvas.height * s.scale;
        const imgLeft = (stage.clientWidth / 2) - (scaledWidth / 2) + s.panX;
        const imgTop = (stage.clientHeight / 2) - (scaledHeight / 2) + s.panY;
        
        const isFullyCovered = imgLeft <= 0 && imgTop <= 0 && 
                               imgLeft + scaledWidth >= stage.clientWidth && 
                               imgTop + scaledHeight >= stage.clientHeight;
        
        const exportCanvas = document.createElement('canvas');
        
        if (isFullyCovered) {
            // å›¾ç‰‡å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜æ‰€è§å³æ‰€å¾—ï¼ˆå½“å‰è§†çª—å†…å®¹ï¼‰
            exportCanvas.width = stage.clientWidth;
            exportCanvas.height = stage.clientHeight;
            const ctx = exportCanvas.getContext('2d');
            
            // å¡«å……ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            ctx.save();
            
            // 1. ç§»åŠ¨åˆ°ä¸­å¿ƒ
            ctx.translate(exportCanvas.width / 2, exportCanvas.height / 2);
            
            // 2. åº”ç”¨å˜æ¢
            ctx.translate(s.panX, s.panY);
            ctx.scale(s.scale, s.scale);
            
            // 3. ç»˜åˆ¶æºå†…å®¹ (å›åˆ°å·¦ä¸Šè§’)
            ctx.translate(-sourceCanvas.width / 2, -sourceCanvas.height / 2);
            ctx.drawImage(sourceCanvas, 0, 0);
            
            ctx.restore();
        } else {
            // å›¾ç‰‡æœªå®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜å®é™…å›¾ç‰‡ï¼ˆä¸è£å‰ªï¼‰
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;
            const ctx = exportCanvas.getContext('2d');
            
            // ç›´æ¥ç»˜åˆ¶æºç”»å¸ƒå†…å®¹ï¼ˆä¸åº”ç”¨å˜æ¢ï¼‰
            ctx.drawImage(sourceCanvas, 0, 0);
        }
        
        // é™åˆ¶Canvaså°ºå¯¸ï¼Œé¿å…iOSè®¾å¤‡ä¸Šçš„å†…å­˜é—®é¢˜
        return limitCanvasSize(exportCanvas);
    }

    // ç”Ÿæˆ4è”å¯¹æ¯”å›¾
    function generateFourPanelComparison() {
        if (!posterOriginalImg) {
            alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
            return null;
        }
        
        // è·å–å½“å‰é»‘ç™½æ¨¡å¼çŠ¶æ€
        const isGray = document.getElementById('grayscaleCheck').checked;
        
        // åˆ›å»ºåŸå§‹Canvas
        const originalCanvas = document.createElement('canvas');
        originalCanvas.width = posterOriginalImg.width;
        originalCanvas.height = posterOriginalImg.height;
        const originalCtx = originalCanvas.getContext('2d');
        originalCtx.drawImage(posterOriginalImg, 0, 0);
        
        // å¤„ç†4ç§è‰²é˜¶
        const levels = [0, 12, 9, 15]; // 0è¡¨ç¤ºåŸå§‹å›¾ç‰‡ï¼ˆä½†åº”ç”¨é»‘ç™½æ¨¡å¼ï¼‰
        const processedCanvases = [];
        
        for (let i = 0; i < 4; i++) {
            const processedCanvas = processWithLevel(originalCanvas, levels[i], isGray);
            const exportCanvas = getExportCanvas(processedCanvas, 'poster');
            processedCanvases.push(exportCanvas);
        }
        
        // ç¡®å®šå•å¼ å›¾ç‰‡å°ºå¯¸ï¼ˆæ‰€æœ‰å›¾ç‰‡ä½¿ç”¨ç›¸åŒçš„å°ºå¯¸åˆ¤æ–­é€»è¾‘ï¼Œæ‰€ä»¥å°ºå¯¸åº”è¯¥ç›¸åŒï¼‰
        const singleWidth = processedCanvases[0].width;
        const singleHeight = processedCanvases[0].height;
        
        // åˆ›å»º4è”å›¾Canvas
        const fourPanelCanvas = document.createElement('canvas');
        fourPanelCanvas.width = singleWidth * 2;
        fourPanelCanvas.height = singleHeight * 2;
        const fourPanelCtx = fourPanelCanvas.getContext('2d');
        
        // å¡«å……ç™½è‰²èƒŒæ™¯
        fourPanelCtx.fillStyle = '#ffffff';
        fourPanelCtx.fillRect(0, 0, fourPanelCanvas.width, fourPanelCanvas.height);
        
        // ç»˜åˆ¶4å¼ å›¾ç‰‡ï¼ˆç”°å­—å½¢å¸ƒå±€ï¼‰
        // å›¾1-1 (0, 0)
        fourPanelCtx.drawImage(processedCanvases[0], 0, 0);
        // å›¾1-2 (singleWidth, 0)
        fourPanelCtx.drawImage(processedCanvases[1], singleWidth, 0);
        // å›¾2-1 (0, singleHeight)
        fourPanelCtx.drawImage(processedCanvases[2], 0, singleHeight);
        // å›¾2-2 (singleWidth, singleHeight)
        fourPanelCtx.drawImage(processedCanvases[3], singleWidth, singleHeight);
        
        // é™åˆ¶4è”å›¾å°ºå¯¸ï¼Œé¿å…iOSè®¾å¤‡ä¸Šçš„å†…å­˜é—®é¢˜
        // ä½¿ç”¨æ›´ä¸¥æ ¼çš„é™åˆ¶ï¼Œå› ä¸º4è”å›¾æ˜¯4å¼ å›¾ç‰‡æ‹¼æ¥ï¼Œå°ºå¯¸è¾ƒå¤§
        return limitCanvasSize(fourPanelCanvas, 2560, 2560);
    }

    // ä¿å­˜4è”å¯¹æ¯”å›¾
    function saveFourPanelComparison() {
        if (!posterOriginalImg) {
            alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
            return;
        }
        
        // æ˜¾ç¤ºç­‰å¾…æç¤º
        showLoading();
        
        // å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡UI
        setTimeout(() => {
            try {
                const fourPanelCanvas = generateFourPanelComparison();
                if (!fourPanelCanvas) {
                    hideLoading();
                    return;
                }
                
                // ä¿å­˜å›¾ç‰‡ï¼Œä½¿ç”¨å¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
                const link = document.createElement('a');
                link.download = generateTimestampFilename('4è”å¯¹æ¯”å›¾');
                link.href = fourPanelCanvas.toDataURL('image/jpeg', 0.95);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
                console.error(error);
            } finally {
                // éšè—ç­‰å¾…æç¤º
                hideLoading();
            }
        }, 10);
    }

    // === å¾®ä¿¡æµè§ˆå™¨æ£€æµ‹ä¸å¼•å¯¼ ===
    // æ£€æµ‹æ˜¯å¦ä¸ºå¾®ä¿¡æµè§ˆå™¨
    function isWeChatBrowser() {
        const ua = navigator.userAgent.toLowerCase();
        // æ£€æµ‹å¾®ä¿¡æµè§ˆå™¨ï¼Œåªè¦åŒ…å«micromessengerå³å¯
        return ua.includes('micromessenger');
    }
    
    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
    function isMobileDevice() {
        return /android|iphone|ipad|ipod/i.test(navigator.userAgent);
    }
    
    // æ£€æµ‹æ˜¯å¦éœ€è¦æ˜¾ç¤ºå¾®ä¿¡å¼•å¯¼
    function shouldShowWeChatGuide() {
        // åªæ£€æµ‹å¾®ä¿¡æµè§ˆå™¨
        return isWeChatBrowser();
    }
    
    // å¾®ä¿¡å¼•å¯¼æ§åˆ¶å™¨
    const WeChatGuide = {
        init: function() {
            // æ ¹æ®æ£€æµ‹ç»“æœå†³å®šæ˜¯å¦æ˜¾ç¤ºå¼•å¯¼
            if (shouldShowWeChatGuide()) {
                this.showGuide();
            } else {
                this.hideGuide();
            }
        },
        
        showGuide: function() {
            const overlay = document.getElementById('wechatGuide');
            if (overlay) {
                overlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        },
        
        hideGuide: function() {
            const overlay = document.getElementById('wechatGuide');
            if (overlay) {
                overlay.style.display = 'none';
                document.body.style.overflow = '';
            }
        },
        
        copyUrl: function() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
    };
    
    // é¡µé¢åŠ è½½ååˆå§‹åŒ–å¾®ä¿¡å¼•å¯¼
    document.addEventListener('DOMContentLoaded', function() {
        WeChatGuide.init();
    });
</script>

<!-- å¾®ä¿¡å¼•å¯¼å±‚ - é»˜è®¤éšè— -->
<div id="wechatGuide" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; justify-content:center; align-items:center;">
    <div style="background:white; border-radius:12px; padding:25px; max-width:90%; width:350px; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="font-size:32px; margin-bottom:15px; color:#4a90e2;">ğŸ‘§</div>
        <h3 style="margin:0 0 10px 0; color:#333; font-size:18px;">è¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€</h3>
        <p style="color:#666; line-height:1.5; margin-bottom:15px; font-size:14px;">
            å¾®ä¿¡ä¸æ”¯æŒæ­¤ç½‘é¡µä¸­çš„æŠ€æœ¯ã€‚<br>
            å»ºè®®ç‚¹å‡»å³ä¸Šè§’"..."ï¼Œé€‰æ‹©"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"ã€‚
        </p>
        
        <div style="background:#f8f9fa; border-radius:8px; padding:15px; margin-bottom:20px; border:1px solid #e9ecef;">
            <div style="display:flex; align-items:center; margin-bottom:10px;">
                <div style="width:24px; height:24px; background:#4a90e2; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:10px; font-size:12px; font-weight:bold;">1</div>
                <div style="flex:1; text-align:left; font-size:13px;">ç‚¹å‡»å³ä¸Šè§’"..."</div>
            </div>
            <div style="display:flex; align-items:center;">
                <div style="width:24px; height:24px; background:#4a90e2; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:10px; font-size:12px; font-weight:bold;">2</div>
                <div style="flex:1; text-align:left; font-size:13px;">é€‰æ‹©"åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"</div>
            </div>
        </div>
        
        <p style="color:#666; line-height:1.5; margin-bottom:20px; font-size:14px;">
            æˆ–è€…ï¼Œåœ¨è¿™é‡Œ
            <button onclick="WeChatGuide.copyUrl()" style="padding:6px 12px; background:#e8f4ff; border:2px solid #4a90e2; border-radius:6px; color:#4a90e2; cursor:pointer; font-size:13px; font-weight:500; margin:0 4px; transition:all 0.1s;">
                ğŸ“‹ å¤åˆ¶é“¾æ¥
            </button>
            ï¼Œç„¶ååˆ‡æ¢åˆ°æµè§ˆå™¨ï¼Œç²˜è´´åˆ°æµè§ˆå™¨åœ°å€æ æ‰“å¼€ã€‚
        </p>
        
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="WeChatGuide.copyUrl()" style="flex:1; padding:12px; background:#4a90e2; border:none; border-radius:6px; color:white; cursor:pointer; font-size:14px; font-weight:500; transition:all 0.1s;">
                ğŸ“‹ å¤åˆ¶é“¾æ¥
            </button>
            <button onclick="WeChatGuide.hideGuide()" style="flex:1; padding:12px; background:#f0f0f0; border:none; border-radius:6px; color:#666; cursor:pointer; font-size:14px; font-weight:500; transition:all 0.1s;">
                ğŸ¨ ä»è¦å°è¯•
            </button>
        </div>
        
        <div style="color:#999; font-size:12px; line-height:1.4; padding-top:15px; border-top:1px solid #eee;">
            æç¤ºï¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åï¼Œç»˜ç”»è¾…åŠ©å·¥å…·æ‰æ­£å¸¸å·¥ä½œã€‚åœ¨å¾®ä¿¡ä¸­æ‰“å¼€åˆ™ä¸æ”¯æŒã€‚
        </div>
        
        <style>
            /* æŒ‰é’®æŒ‰ä¸‹æ•ˆæœ */
            #wechatGuide button:active {
                transform: translateY(1px);
                box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            }
            #wechatGuide button:nth-of-type(1):active {
                background-color: #d0e4ff !important;
            }
            #wechatGuide button:nth-of-type(2):active {
                background-color: #3a80d2 !important;
            }
            #wechatGuide button:nth-of-type(3):active {
                background-color: #e0e0e0 !important;
            }
        </style>
    </div>
</div>

<!-- PCç«¯éšè—å¾®ä¿¡å¼•å¯¼ -->
<style>
    @media (min-width: 768px) {
        #wechatGuide {
            display: none !important;
        }
    }
</style>

</body>
</html>
