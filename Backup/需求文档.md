# 绘画工作台需求文档

## 项目概述
- **应用名称**：童画师吴晓的绘画工作台
- **版本**：v3.0.0
- **定位**：面向童画师吴晓的学员、粉丝的在线辅助工具，提供网格起型和色阶概括两大核心功能，帮助绘画者进行构图和色彩分析。
- **技术栈**：HTML5、CSS3、JavaScript（原生Canvas API）
- **平台**：移动端（平板、手机）优先的响应式Web应用，支持触摸手势操作。
- **童画师吴晓介绍**：水彩肖像画家，尤其擅长画儿童肖像画，以能画出孩子细腻通透质感的肤质著称。

---

## 核心功能模块

### 1. 网格起型工具
**目标**：辅助绘画者以网格和图片的相对位置作为参考依据来精准起型。

#### 功能点
- **图片上传**：从本地相册选择图片，支持常见图像格式。
- **网格叠加**：在图片上绘制可调整的网格线。
- **网格参数调节**：
  - 网格密度：2~15格可调（默认3格）
  - 网格颜色：通过颜色选择器自定义
  - 网格位置：支持双指拖拽调整网格对齐位置
- **视图操作**：
  - 双指缩放图片（移动视图模式）
  - 双指移动网格位置（网格调整模式）
  - 适应视图、重置网格、缩放控制
- **导出结果**：保存网格图（JPG格式）

#### 交互设计
- 两种操作模式切换：移动视图 vs 调整网格
- 触摸手势：双指缩放、拖拽
- 桌面兼容：鼠标操作支持

### 2. 色阶概括工具
**目标**：将图片色彩简化为有限色阶，帮助分析色彩构成。

#### 功能点
- **图片上传**：从本地相册选择图片
- **色阶参数调节**：
  - 色阶数量：2~20级可调（默认12级）
  - 黑白模式：可切换为灰度处理
- **实时处理**：调整参数后立即重新计算并显示结果
- **视图操作**：
  - 双指缩放和拖拽查看细节
  - 适应视图、缩放控制
- **导出结果**：保存色阶图（JPG格式）

#### 技术实现
- Canvas图像处理：像素级色阶量化
- 实时计算：使用getImageData/putImageData API
- 性能优化：直接操作图像数据，无额外渲染开销

---

## 用户体验特性

### 界面设计
- **响应式布局**：适应不同屏幕尺寸，移动端优先
- **卡片式分区**：清晰的功能区域划分
- **标签页导航**：网格工具与色阶工具快速切换
- **视觉反馈**：按钮状态、激活指示、操作提示

### 操作体验
- **触摸优化**：专门为移动设备设计的触摸交互
- **手势识别**：双指缩放、拖拽的精准控制
- **实时预览**：所有参数调整立即反映在画布上
- **状态保存**：视图状态（缩放、平移）在操作间保持

### 辅助功能
- **占位提示**：未上传图片时的操作引导
- **数值显示**：当前参数值的实时反馈
- **快捷键**：加减按钮辅助精细调整
- **一键适应**：快速将图片调整到最佳查看尺寸

---

## 技术架构

### 前端架构
- **无框架原生实现**：纯HTML/CSS/JavaScript，无外部依赖
- **Canvas为核心**：所有图像处理基于HTML5 Canvas
- **状态管理**：集中式状态对象管理视图参数
- **事件驱动**：触摸/鼠标事件统一处理

### 核心算法
1. **网格生成算法**：
   - 基于图片尺寸和网格密度计算步长
   - 支持网格偏移（对齐调整）
   - 抗锯齿线条绘制

2. **色阶量化算法**：
   - RGB通道独立量化
   - 可选灰度转换（使用亮度公式）
   - 色阶边界计算（等间隔划分）

### 手势处理系统
- **多点触摸检测**：识别双指操作
- **模式区分**：根据当前模式决定手势行为
- **平滑变换**：缩放和平移的流畅动画

### 导出系统
- **所见即所得**：导出当前视图的完整状态
- **画布合成**：将变换后的内容渲染到新画布
- **图片质量**：JPG格式，95%质量

---


## 尺寸限制优化（v2.26-v2.29）

### 问题背景
- **4096×4096问题**：在iPad设备上保存4联对比图时生成85KB全黑图片，尺寸超出设备处理能力
- **1024×1024问题**：文件大小仅800KB，画质不足
- **目标**：在画质与iPad兼容性之间找到最佳平衡点

### 测试历程
1. **初始版本**：4096×4096 → 85KB全黑图片（太大）
2. **第一次优化**：2048×2048 → 800KB正常图片（兼容但画质不足）
3. **尝试提升**：3072×3072 → 85KB全黑图片（仍然太大）
4. **最终方案**：2560×2560 → 800-900KB正常图片（平衡画质与兼容性）

### 技术实现
1. **尺寸限制函数**：
   ```javascript
   function limitCanvasSize(canvas, maxWidth = 2560, maxHeight = 2560)
   ```
   - 单张图片最大尺寸：2560×2560
   - 4联对比图最大尺寸：2560×2560（保持一致）

2. **等比缩放逻辑**：
   - 计算宽高比例，等比例缩放至限制内
   - 保持原图宽高比，避免变形
   - 仅在超出限制时进行缩放

3. **内存管理**：
   - 创建新Canvas进行缩放，避免修改原Canvas
   - 及时释放临时Canvas资源
   - 使用适当的质量参数（0.95）平衡文件大小与画质

### 预期效果
- **文件大小**：4联对比图约800-900KB
- **画质提升**：比2048×2048版本有明显改善
- **兼容性**：在iPad上测试通过，无85KB全黑图片问题
- **用户体验**：保持流畅的保存体验，避免内存溢出

### 兼容性考虑
- **iOS Safari限制**：不同iPad型号有不同的Canvas内存限制
- **渐进式兼容**：从2048测试到3072，最终确定2560为安全上限
- **未来扩展**：可根据设备检测动态调整限制值

## 性能考虑
- **图像处理优化**：仅在必要时重绘
- **事件节流**：避免频繁触发导致卡顿
- **内存管理**：及时释放不再使用的图像资源
- **Canvas重用**：复用Canvas元素减少DOM操作

---

## 兼容性
- **浏览器支持**：现代浏览器（Chrome、Safari、Firefox、Edge）
- **移动设备**：iOS Safari、Android Chrome
- **触摸设备**：支持所有标准触摸事件
- **桌面设备**：鼠标操作完整支持

---

## 扩展性设计
- **模块化结构**：网格和色阶工具独立，易于扩展新功能
- **配置化参数**：颜色、范围等参数可外部配置
- **插件化架构**：可添加新的图像处理工具

---

## 用户场景
1. **绘画教学**：老师使用网格工具帮助学生理解构图比例
2. **色彩学习**：学生使用色阶工具分析大师作品的色彩构成
3. **创作参考**：绘画者上传参考图片进行网格对齐
4. **色彩设计**：设计师使用色阶工具简化复杂图像的色彩

---

## 未来改进方向
- **增加“取色+调色配比”功能**：从图片上取色，然后显示所取颜色用原色色料调配的比例，以唯美的方式显示。


---

## 版本记录
- v3.1.0：UI视觉与交互体验优化 - 由Gemini进行UI视觉升级、交互体验改良和移动端兼容性修复。主要改进：关于弹窗视觉重构（高质感UI、圆角阴影、优化排版）、交互体验升级（自定义Toast提示替代原生alert）、移动端核心修复（剪贴板兼容性优化、防误触缩放）
- v3.0.0：UI全面升级 - 整合新版UI设计，优化视觉体验和交互流程，成为整合UI的基线版本。主要改进：现代化卡片式设计、品牌名片左对齐、控制面板优化、预览模式统一。
- v3.0.1：修复预览图片居中问题，优化分享功能设计（已添加分享模态框CSS，待实现）
- v2.32：按钮文字优化 - 将"双指调整网格"改为"双指移动网格"，将网格工具中的"保存结果图"改为"保存网格图"，将色阶工具中的"保存结果图"改为"保存色阶图"，提高操作描述准确性
- v2.31：画板中心添加"+"图标 - 在网格工具和色阶工具的画板中心添加大号"+"图标，点击可直接调用打开相册图片功能，提高用户操作便捷性
- v2.30：微信引导页面优化 - 更新引导文本内容，将"复制链接"文本改为按钮样式，优化三个按钮的颜色对比度（复制链接按钮显眼，仍要尝试按钮不显眼），使用👧小女孩图标替代🌐图标
- v2.29：微信浏览器检测修复 - 修复检测逻辑只检测微信浏览器，优化引导图标（🌐替代⚠️），已知iPad分屏模式下引导页面显示异常
- v2.28：尺寸限制优化最终方案 - 将Canvas最大尺寸调整为2560×2560，平衡画质与iPad兼容性
- v2.27：尺寸调整 - 尝试3072×3072（导致iPad生成85KB全黑图片）
- v2.26：尺寸调整 - 将Canvas最大尺寸从4096×4096调整为2048×2048，解决iPad兼容性问题
- v2.25：尺寸调整 - 尝试2080×2080中间值（未采纳）
- v2.24：尺寸调整 - 尝试2304×2304中间值（未采纳）
- v2.23：新增"保存4联对比图"功能，在色阶概括工具中提供四种不同色阶值的对比视图
- v2.22：UI优化 - 方格控件改为复选框样式，取色按钮改为正方形并与方格控件同行，百分比调节步长改为10%
- v2.21：UI调整 - 尝试重新布局方格控件和取色按钮（未采纳）
- v2.20：新增"方格"开关功能，支持长方形/正方形网格切换
- v2.19：优化保存逻辑，根据图片覆盖情况智能选择保存策略
- v2.18：优化了手势交互和导出功能
- 持续更新：根据用户反馈不断改进体验

---

## 新增功能：方格开关（v2.20）

### 功能描述
在网格起型工具中添加"方格"开关，支持长方形网格和正方形网格的切换。

### 详细功能
1. **开关位置**：保存按钮上方，缩放百分比下方，居中显示
2. **开关样式**：切换按钮，默认关闭（长方形网格）
3. **切换逻辑**：
   - **开启时**：网格变为正方形网格，网格密度滑块控制正方形短边方向的边长数量
   - **关闭时**：恢复长方形网格，使用当前正方形网格的短边密度作为两个方向的密度
4. **视觉连续性**：
   - 切换时保持短边方向的线条不变
   - 只调整长边方向的线条密度，形成正方形网格
5. **双向切换**：支持长方形↔正方形的完整循环切换

### 技术实现
- 在状态管理中添加 `isSquareGrid` 标志
- 修改 `drawGrid()` 函数支持两种网格模式
- 添加 `toggleSquareGrid()` 函数处理状态切换
- 保持与现有功能的完全兼容

---

## UI优化：v2.22

### 变更内容
1. **"方格"控件样式优化**：
   - 从切换按钮改为复选框样式，与色阶工具的"黑白"控件保持一致
   - 使用相同的尺寸和边框样式（白色背景、圆角边框、复选框+文字标签）

2. **取色按钮优化**：
   - 形状从圆形改为正方形（边框半径8px）
   - 位置移动到与"方格"控件同一行，位于方格左边
   - 与方格控件水平居中显示，形成统一的控制行

3. **百分比调节优化**：
   - 缩放控制步长从20%调整为10%
   - 提供更精细的缩放控制体验
   - 同时应用于网格工具和色阶工具

### 布局调整
- 移除原网格调整区域中的取色按钮
- 创建新的控制行，包含正方形取色按钮和方格复选框
- 保持整体界面的一致性和美观性

### 兼容性
- 所有原有功能保持不变
- 手势操作、网格切换、保存功能均不受影响
- 与现有工作流程完全兼容


## 新增功能：保存4联对比图（v2.23）

### 功能描述
在色阶概括工具中新增"保存4联对比图"按钮，生成田字形布局的4张图片对比图，展示不同色阶值处理效果。

### 详细功能
1. **按钮位置**：位于"保存结果图"按钮左侧，并排显示
2. **图片布局**：2×2田字形拼接，无留白边框
3. **色阶处理**：
   - 图1-1（左上）：原始图片（应用当前黑白模式设置）
   - 图1-2（右上）：色阶值=12的处理
   - 图2-1（左下）：色阶值=9的处理
   - 图2-2（右下）：色阶值=15的处理
4. **尺寸逻辑**：复用现有保存逻辑的判断标准
   - 图片完全覆盖画布范围 → 截取视窗范围内的部分
   - 图片未完全覆盖画布范围 → 使用原图完整尺寸
5. **黑白模式**：所有图片都跟随当前的黑白模式设置
6. **等待提示**：处理过程中显示加载动画，防止用户误操作

### 技术实现
- **可配置色阶处理**：创建`processWithLevel()`函数支持指定色阶值
- **尺寸判断复用**：从现有`downloadCanvas()`逻辑中提取`getExportCanvas()`函数
- **4联图生成**：`generateFourPanelComparison()`函数处理图片生成和拼接
- **异步处理**：使用`setTimeout`避免UI阻塞，配合加载提示提升用户体验
- **CSS动画**：旋转加载图标和半透明遮罩层

### 用户体验
- 直观对比不同色阶处理效果
- 处理过程中明确的视觉反馈
- 与现有工作流程无缝集成
- 保持一致的保存逻辑和图片质量

---

*文档更新日期：2026-01-23*
