<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æˆ‘çˆ±ä½ ä»¬ - ç»˜ç”»è¾…åŠ©</title>
    <style>
        /* === 0. æ ¸å¿ƒé‡ç½® & åŸºç¡€å˜é‡ === */
        :root {
            --primary-blue: #007AFF;
            --primary-blue-soft: #E0F0FF; 
            --primary-orange: #FF9500;
            --primary-orange-soft: #FFF5E5;
            --bg-body: #F0F2F5;
            --bg-shell: #FFFFFF;
            --bg-control: #F7F8FA;
            --text-main: #1D1D1F;
            --text-sub: #86868B;
            --border-color: #E5E5EA;
            --paper-ratio: 0.716;
            
            --shadow-app: 0 12px 40px rgba(0,0,0,0.08); 
            --shadow-card: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-btn-blue: 0 4px 12px rgba(0,122,255,0.3);
            --shadow-btn-orange: 0 4px 12px rgba(255,149,0,0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        img { -webkit-touch-callout: none; }

        html, body {
            margin: 0; padding: 0; width: 100%;
            /* ç§»é™¤ height: 100% é™åˆ¶ï¼Œæ”¹ç”¨ min-heightï¼Œå…è®¸å†…å®¹è‡ªç„¶æ’‘å¼€ï¼Œé˜²ç™½å± */
            min-height: 100vh; 
            background-color: var(--bg-body);
            padding-bottom: env(safe-area-inset-bottom);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-main);
            -webkit-user-select: none; user-select: none;
            
            /* å…³é”®ï¼šPCç«¯ä¸Šä¸‹ç•™ç™½ï¼Œç§»åŠ¨ç«¯åé¢ä¼šè¦†ç›– */
            display: block; /* ç¡®ä¿æµå¼å¸ƒå±€ */
            padding-top: 20px; padding-bottom: 20px;
        }

        /* === 1. App å®¹å™¨å£³ === */
        .app-shell {
            width: 100%; max-width: 1400px; 
            /* å…³é”®ï¼šä½¿ç”¨ margin: auto å±…ä¸­ï¼Œè€Œé Flex */
            margin: 0 auto; 
            background-color: var(--bg-shell);
            position: relative;
            border-radius: 16px;
            box-shadow: var(--shadow-app);
            overflow: hidden; 
            /* ç¡®ä¿æœ€å°é«˜åº¦æ’‘æ»¡è§†å£ */
            min-height: calc(100vh - 40px);
            display: flex; flex-direction: column;
        }

        /* === 2. å¤´éƒ¨ (å·¦å¯¹é½å“ç‰Œ + ä¸‹æ–¹ Tab) === */
        header {
            background: #FFFFFF;
            padding: 12px 24px 0;
            border-bottom: 1px solid var(--border-color);
            position: relative; z-index: 10;
            display: flex; flex-direction: column; /* å‚ç›´æ’åˆ— */
            align-items: flex-start; /* å·¦å¯¹é½ */
        }

        /* å“ç‰Œå¡ç‰‡ (å·¦å¯¹é½) */
        .brand-card {
            display: flex; align-items: center; gap: 10px;
            padding: 6px 0; /* å‡å°‘å†…è¾¹è·ï¼Œä½¿å…¶è´´å·¦ */
            cursor: pointer;
            margin-bottom: 8px;
            width: 100%; /* å æ»¡å®½åº¦ä»¥ä¾¿ç‚¹å‡» */
        }
        .brand-card:active { opacity: 0.7; }

        .brand-avatar {
            width: 40px; height: 40px; border-radius: 50%; 
            background: linear-gradient(135deg, #FF9500, #FF5E3A);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; color: white;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); flex-shrink: 0;
        }

        .brand-info { display: flex; flex-direction: column; justify-content: center; text-align: left; }
        .brand-name { font-size: 17px; font-weight: 700; color: var(--text-main); line-height: 1.2; display: flex; align-items: center; gap: 4px; }
        .brand-arrow { font-size: 12px; color: #ccc; margin-top: 1px; }
        .brand-desc { font-size: 11px; color: var(--text-sub); line-height: 1.2; margin-top: 2px; font-weight: 500; }

        /* Tab å¯¼èˆª (å±…ä¸­) */
        .tabs { display: flex; gap: 30px; justify-content: center; width: 100%; }
        .tab-btn {
            flex: 1; max-width: 200px; padding: 10px 0 14px;
            font-size: 16px; font-weight: 500; color: var(--text-sub);
            background: transparent; border: none; cursor: pointer; position: relative; transition: color 0.2s;
        }
        .tab-btn.active { color: var(--text-main); font-weight: 600; }
        .tab-btn[data-theme="blue"].active { color: var(--primary-blue); }
        .tab-btn[data-theme="orange"].active { color: var(--primary-orange); }
        .tab-btn::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%) scaleX(0);
            width: 30px; height: 3px; background-color: var(--text-main); border-radius: 3px 3px 0 0; transition: transform 0.2s ease-out;
        }
        .tab-btn.active::after { transform: translateX(-50%) scaleX(1); }
        .tab-btn[data-theme="blue"].active::after { background-color: var(--primary-blue); }
        .tab-btn[data-theme="orange"].active::after { background-color: var(--primary-orange); }

        /* === 3. å†…å®¹åŒºåŸŸ === */
        .tab-content { display: none; width: 100%; }
        .tab-content.active { display: block; animation: fadeEffect 0.3s ease; }
        @keyframes fadeEffect { from { opacity: 0; } to { opacity: 1; } }

        /* === 4. æ§åˆ¶é¢æ¿ === */
        .controls-panel {
            background: #FFFFFF; padding: 16px 24px;
            display: flex; flex-direction: column; gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .control-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }

        /* å¤§æŒ‰é’® */
        .btn-upload {
            width: 100%; height: 44px; background-color: var(--primary-blue); color: white; border-radius: 10px; font-size: 15px; font-weight: 600;
            display: flex; align-items: center; justify-content: center; gap: 8px; border: none; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,122,255,0.2); transition: transform 0.1s, opacity 0.2s;
        }
        .btn-upload:active { transform: scale(0.99); opacity: 0.9; }
        .btn-upload.orange { background-color: var(--primary-orange); box-shadow: 0 4px 10px rgba(255,149,0,0.2); }

        /* åˆå¹¶èƒ¶å›Š */
        .merged-capsule {
            display: flex; align-items: center; width: 100%; background: var(--bg-control); border-radius: 12px; height: 44px; padding: 0;
        }
        .capsule-item {
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; height: 100%; cursor: pointer; transition: background 0.2s; position: relative;
        }
        .capsule-item:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        .capsule-item:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
        .capsule-item:only-child { border-radius: 12px; }
        .capsule-item:active { background: rgba(0,0,0,0.05); }
        .capsule-divider { width: 1px; height: 24px; background: rgba(0,0,0,0.08); flex-shrink: 0; }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        .color-wrapper {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15); overflow: hidden; position: relative; cursor: pointer; flex-shrink: 0;
        }
        input[type="color"] { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; padding: 0; border: none; cursor: pointer; }

        input[type=checkbox] { width: 18px; height: 18px; accent-color: var(--primary-blue); margin: 0; cursor: pointer; }
        .orange-accent input[type=checkbox] { accent-color: var(--primary-orange); }
        .label-text { font-size: 14px; font-weight: 500; color: var(--text-main); }

        /* ç‹¬ç«‹æ»‘å—è¡Œ */
        .slider-row {
            display: flex; align-items: center; gap: 12px; width: 100%;
            background: var(--bg-control); padding: 4px; border-radius: 12px;
        }
        .slider-container-transparent {
            flex: 1; height: 40px; display: flex; align-items: center; padding: 0 4px; gap: 8px;
        }
        .btn-micro {
            width: 32px; height: 32px; border-radius: 50%; background: #FFFFFF; border: 1px solid rgba(0,0,0,0.08);
            color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: background 0.1s; flex-shrink: 0;
        }
        .btn-micro:active { background: #E5E5EA; }

        /* Range Input */
        input[type=range] { 
            -webkit-appearance: none; width: 100%; height: 5px; background: #E5E5EA; border-radius: 3px;
            background-image: linear-gradient(var(--track-color, #007AFF), var(--track-color, #007AFF));
            background-size: var(--percent, 0%) 100%; background-repeat: no-repeat; cursor: pointer; border: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #fff;
            border: 0.5px solid rgba(0,0,0,0.1); box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.1); }
        /* Firefox */
        input[type=range]::-moz-range-track { width: 100%; height: 5px; background: #E5E5EA; border-radius: 3px; }
        input[type=range]::-moz-range-progress { background-color: var(--track-color, #007AFF); height: 5px; border-radius: 3px; }
        input[type=range]::-moz-range-thumb { height: 24px; width: 24px; border: none; border-radius: 50%; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.15); cursor: pointer; }

        /* Mode Switch */
        .mode-switch { display: flex; background: var(--bg-control); padding: 4px; border-radius: 12px; width: 100%; }
        .mode-btn {
            flex: 1; padding: 0 8px; font-size: 14px; font-weight: 500; color: var(--text-sub);
            border: none; background: transparent; border-radius: 8px; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s; cursor: pointer; white-space: nowrap; height: 40px;
        }
        .mode-btn.active { background: #fff; color: var(--text-main); font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }
        .mode-btn.active.blue-text { color: var(--primary-blue); }

        /* === 7. ç”»æ¿åŒºåŸŸ (äº¤äº’æ ¸å¿ƒ) === */
        .canvas-area {
            width: 100%;
            height: calc(100vw / var(--paper-ratio));
            max-height: 75vh; 
            min-height: 400px;
            background: #EBEBF0; 
            display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: relative;
            
            /* å…³é”®ç‚¹ï¼šå…è®¸å‚ç›´æ»šåŠ¨(å•æŒ‡)ï¼Œä½†é˜»æ­¢åŒæŒ‡é»˜è®¤è¡Œä¸º(ç¼©æ”¾) */
            touch-action: pan-y;
        }
        
        .empty-placeholder {
            width: 80%; height: 80%;
            background: #fff; border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.06);
            color: #C7C7CC;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.2s; cursor: pointer;
        }
        .empty-placeholder:active { transform: scale(0.98); }
        .plus-icon { font-size: 64px; margin-bottom: 20px; line-height: 1; font-weight: 200; }

        /* === 8. åº•éƒ¨å·¥å…· === */
        .bottom-toolbar {
            background: #FFFFFF; padding: 12px 24px; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; gap: 16px;
        }
        .btn-flat {
            height: 36px; padding: 0 14px; background: var(--bg-control);
            border: none; border-radius: 8px; font-size: 13px; font-weight: 600; color: var(--text-main); cursor: pointer; transition: background 0.1s;
        }
        .btn-flat:active { background: #EFEFF4; }
        .zoom-display { font-size: 13px; font-weight: 600; color: var(--text-sub); width: 40px; text-align: center; }

        /* === 9. åº•éƒ¨æ“ä½œåŒº === */
        .bottom-actions { background: #FFFFFF; padding: 16px 24px 24px; display: flex; gap: 16px; }
        
        .btn-cta {
            flex: 1; height: 50px; background: var(--primary-blue);
            color: white; border-radius: 12px; font-size: 16px; font-weight: 600; 
            border: none; cursor: pointer; box-shadow: var(--shadow-btn-blue);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn-cta:active { transform: scale(0.98); opacity: 0.9; }
        .btn-cta.orange { background: var(--primary-orange); box-shadow: var(--shadow-btn-orange); }

        .btn-secondary {
            flex: 1; height: 50px; background: var(--bg-control);
            color: var(--text-main); border-radius: 12px; font-size: 15px; font-weight: 600;
            border: 1px solid transparent; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-secondary:active { background: #EFEFF4; transform: scale(0.98); }
        .btn-secondary.soft-orange { background: var(--primary-orange-soft); color: #D67E00; }
        .btn-secondary.soft-orange:active { background: #FFECC9; }

        /* === 10. å…³äºæ¨¡æ€æ¡† === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 100; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .about-card {
            width: 90%; max-width: 320px; background: white; border-radius: 20px; padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            text-align: center;
        }
        .modal-overlay.active .about-card { transform: scale(1); }

        .about-avatar-large {
            width: 64px; height: 64px; background: linear-gradient(135deg, #FF9500, #FF5E3A); border-radius: 50%; 
            margin: 0 auto 12px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white;
        }
        .about-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; color: var(--text-main); }
        .about-subtitle { font-size: 13px; color: var(--text-sub); margin-bottom: 20px; font-weight:500; }
        
        .share-btn {
            flex: 1; height: 44px; background: var(--text-main); color: white;
            border-radius: 12px; font-weight: 600; border: none; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        
        .fav-btn {
            flex: 1; height: 44px; background: var(--bg-control); color: var(--text-main);
            border-radius: 12px; font-weight: 600; border: 1px solid transparent; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .fav-btn:active { background: #EFEFF4; }

        .action-row {
            display: flex; gap: 12px; margin-bottom: 16px;
        }
        
        .social-link {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 13px; color: var(--text-main); padding: 8px;
            background: var(--bg-control); border-radius: 8px; margin-bottom: 8px;
            text-decoration: none; cursor: pointer;
        }
        .copy-right {
            margin-top: 20px; font-size: 11px; color: #999; line-height: 1.5; border-top: 1px solid #eee; padding-top: 12px;
        }

        /* å¾®ä¿¡å¼•å¯¼å±‚ */
        .wechat-guide {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); z-index: 99999;
            display: none; flex-direction: column; align-items: flex-end; padding: 20px 30px;
            color: white; text-align: right;
        }
        .wechat-guide .arrow { font-size: 40px; margin-bottom: 10px; animation: bounce 1.5s infinite; color: #fff; }
        .wechat-guide .text { font-size: 16px; line-height: 1.6; font-weight: 500; color: #fff; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
        .preview-img {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            max-height: 60vh;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 16px;
            -webkit-touch-callout: default;
            pointer-events: auto;
        }

        /* åˆ†äº«åŠŸèƒ½æ ·å¼ */
        .share-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 8px;
            background: var(--bg-control);
            border-radius: 12px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .share-option:active {
            background: #EFEFF4;
            transform: scale(0.98);
        }
        .share-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        .share-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-main);
        }
        .qrcode-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: var(--bg-control);
            border-radius: 12px;
        }
        #qrcode {
            width: 150px;
            height: 150px;
            margin: 0 auto 16px;
        }
        .share-link {
            display: flex;
            align-items: center;
            background: var(--bg-control);
            border-radius: 12px;
            padding: 12px 16px;
            margin: 16px 0;
        }
        .share-link input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            color: var(--text-main);
            outline: none;
        }
        .copy-link-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .copy-link-btn:active {
            opacity: 0.8;
        }

        /* === 13. ç§»åŠ¨ç«¯é€‚é… (è¦†ç›–) === */
        @media (max-width: 768px) {
            body { 
                padding: 0; /* ç§»åŠ¨ç«¯è´´è¾¹ */
            }
            .app-shell { 
                max-width: 100%; 
                margin: 0; 
                border-radius: 0; 
                box-shadow: none; 
                min-height: 100vh;
            }
            /* ä¿®æ­£ç§»åŠ¨ç«¯ canvas é«˜åº¦ï¼Œé˜²æ­¢è¢« PC é€»è¾‘è¯¯ä¼¤ */
            .canvas-area {
                height: calc(100vw / var(--paper-ratio));
                max-height: 75vh;
            }
        }
    </style>
    <!-- ç«‹å³æ‰§è¡Œå¾®ä¿¡æ£€æµ‹è„šæœ¬ -->
    <script>
        (function() {
            var ua = navigator.userAgent.toLowerCase();
            if (ua.match(/MicroMessenger/i) == "micromessenger") {
                document.write('<style>.wechat-guide{display:flex !important;}</style>');
            }
        })();
    </script>
</head>
<body>

<!-- å¾®ä¿¡å¼•å¯¼å±‚ -->
<div class="wechat-guide" id="wechatGuide" onclick="this.style.display='none'">
    <div class="arrow">â†—</div>
    <div class="text">
        ä¸ºäº†æ›´å¥½çš„ç”»ç”»ä½“éªŒ<br>
        è¯·ç‚¹å‡»å³ä¸Šè§’èœå•<br>
        é€‰æ‹© <strong>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€</strong> ğŸŒ
    </div>
</div>

<div class="app-shell">
    
    <header>
        <!-- å·¦å¯¹é½å“ç‰Œåç‰‡ -->
        <div class="brand-card" onclick="toggleModal('aboutModal', true)">
            <div class="brand-avatar">ğŸ¨</div> 
            <div class="brand-info">
                <div class="brand-name">
                    æˆ‘çˆ±ä½ ä»¬ 
                    <span class="brand-arrow">â€º</span>
                </div>
                <div class="brand-desc">By ç«¥ç”»å¸ˆå´æ™“</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-theme="blue" onclick="switchTab('grid', this)">ğŸ“ ç½‘æ ¼èµ·å‹</button>
            <button class="tab-btn" data-theme="orange" onclick="switchTab('poster', this)">ğŸ¨ è‰²é˜¶æ¦‚æ‹¬</button>
        </div>
    </header>

    <!-- TAB 1: ç½‘æ ¼èµ·å‹ -->
    <div id="grid-content" class="tab-content active">
        
        <div class="controls-panel">
            <!-- Row 1: æ–‡ä»¶ä¸Šä¼  (è“è‰²å®å¿ƒ) -->
            <div class="control-row">
                <button class="btn-upload">ğŸ“‚ æ‰“å¼€ç›¸å†Œå›¾ç‰‡</button>
            </div>

            <!-- Row 2: é¢œè‰²+æ–¹æ ¼ (åˆå¹¶èƒ¶å›Š) -->
            <div class="control-row">
                 <div class="merged-capsule">
                     <!-- å·¦ä¾§: é¢œè‰² -->
                     <div class="capsule-item" onclick="document.querySelector('#gridColor').click()">
                        <div class="color-wrapper" title="ç½‘æ ¼é¢œè‰²">
                        <input type="color" id="gridColor" value="#FF3B30" oninput="drawGrid()">
                        </div>
                        <span class="label-text">ç½‘æ ¼é¢œè‰²</span>
                     </div>
                     
                     <div class="capsule-divider"></div>
                     
                     <!-- å³ä¾§: æ–¹æ ¼ -->
                     <label class="capsule-item">
                        <input type="checkbox" id="squareGridCheck">
                        <span class="label-text">æ­£æ–¹æ ¼</span>
                    </label>
                 </div>
            </div>

            <!-- Row 3: ç‹¬ç«‹æ»‘å—è¡Œ -->
            <div class="slider-row">
                <div class="slider-container-transparent">
                    <button class="btn-micro" onclick="adjustGridSize(-0.1)">-</button>
                    <input type="range" id="gridSize" min="2" max="15" value="3" step="0.05" oninput="drawGrid()">
                    <button class="btn-micro" onclick="adjustGridSize(0.1)">+</button>
                </div>
                <div style="font-size: 13px; font-weight: 600; color: var(--text-sub); width: 24px; text-align: right; padding-right: 8px;" id="gridSizeVal">3.0</div>
            </div>

            <!-- Row 4: æ¨¡å¼åˆ‡æ¢ -->
            <div class="control-row">
                <div class="mode-switch">
                    <button class="mode-btn active blue-text" id="modeMove" onclick="setGridMode('move')">âœ‹ åŒæŒ‡ç§»åŠ¨è§†å›¾</button>
                    <button class="mode-btn" id="modeGrid" onclick="setGridMode('grid')">ğŸ“ åŒæŒ‡ç§»åŠ¨ç½‘æ ¼</button>
                </div>
            </div>
        </div>

        <!-- ç”»æ¿åŒºåŸŸ -->
        <div class="canvas-area" id="gridWindow">
            <div class="empty-placeholder" id="gridPlaceholder" onclick="document.getElementById('gridImageInput').click()">
                <div class="plus-icon" style="color: #007AFF;">+</div>
                <div style="font-weight: 600; color: #1C1C1E; margin-bottom: 4px;">è¯·é€‰æ‹©å›¾ç‰‡</div>
                <div style="font-size: 13px; color: #8E8E93;">åŒæŒ‡æ“ä½œ</div>
            </div>
            <canvas id="gridCanvas" style="display:none;"></canvas>
        </div>

        <div class="bottom-toolbar">
            <button class="btn-flat" onclick="resetGridOffset()">é‡ç½®ç½‘æ ¼</button>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button class="btn-micro" onclick="updateZoom('grid', -0.1)">-</button>
                <span class="zoom-display" id="gridZoomVal">100%</span>
                <button class="btn-micro" onclick="updateZoom('grid', 0.1)">+</button>
            </div>
            <button class="btn-flat" onclick="fitView('grid')">é€‚åº”</button>
        </div>

        <div class="bottom-actions">
            <!-- ç½‘æ ¼ä¿å­˜ -->
            <button class="btn-cta" onclick="previewCanvas('gridCanvas', 'ç½‘æ ¼å‚è€ƒå›¾.jpg')">â¬‡ï¸ ä¿å­˜ç½‘æ ¼å›¾</button>
        </div>
    </div>


    <!-- TAB 2: è‰²é˜¶æ¦‚æ‹¬ -->
    <div id="poster-content" class="tab-content">
        
        <div class="controls-panel">
            <!-- Row 1: æ–‡ä»¶ä¸Šä¼  (æ©™è‰²å®å¿ƒ) -->
            <div class="control-row">
                <button class="btn-upload orange">ğŸ“‚ æ‰“å¼€ç›¸å†Œå›¾ç‰‡</button>
            </div>

            <!-- Row 2: é»‘ç™½å¼€å…³ (ä¹Ÿæ˜¯åˆå¹¶èƒ¶å›Šé£æ ¼ï¼Œå•é¡¹) -->
            <div class="control-row">
                 <div class="merged-capsule">
                     <label class="capsule-item orange-accent">
                        <input type="checkbox" id="grayscaleCheck" onchange="processPoster()">
                        <span class="label-text">å¼€å¯é»‘ç™½æ¨¡å¼</span>
                    </label>
                 </div>
            </div>

            <!-- Row 3: ç‹¬ç«‹æ»‘å—è¡Œ -->
            <div class="slider-row">
                <div class="slider-container-transparent">
                    <button class="btn-micro" onclick="adjustPosterLevel(-1)">-</button>
                    <input type="range" id="posterLevel" min="2" max="20" value="12" step="1" oninput="handlePosterSliderInput(this)" style="--track-color: var(--primary-orange);">
                    <button class="btn-micro" onclick="adjustPosterLevel(1)">+</button>
                </div>
                <div style="font-size: 13px; font-weight: 600; color: var(--text-sub); width: 24px; text-align: right; padding-right: 8px;" id="posterLevelVal">12</div>
            </div>
        </div>

        <div class="canvas-area" id="posterWindow">
            <div class="empty-placeholder" id="posterPlaceholder" onclick="document.getElementById('posterImageInput').click()">
                <div class="plus-icon" style="color: #FF9500;">+</div>
                <div style="font-weight: 600; color: #1C1C1E;">è¯·é€‰æ‹©å›¾ç‰‡</div>
            </div>
            <canvas id="posterCanvas" style="display:none;"></canvas>
        </div>

        <div class="bottom-toolbar">
            <div style="width: 40px;"></div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button class="btn-micro" onclick="updateZoom('poster', -0.1)">-</button>
                <span class="zoom-display" id="posterZoomVal">100%</span>
                <button class="btn-micro" onclick="updateZoom('poster', 0.1)">+</button>
            </div>
            <button class="btn-flat" onclick="fitView('poster')">é€‚åº”</button>
        </div>

        <div class="bottom-actions">
            <!-- è‰²é˜¶ä¿å­˜ -->
            <button class="btn-secondary soft-orange" onclick="saveFourPanelComparison()">ğŸ“Š ä¿å­˜4è”å¯¹æ¯”å›¾</button>
            <button class="btn-cta orange" onclick="previewCanvas('posterCanvas', 'è‰²å—æ¦‚æ‹¬å›¾.jpg')">â¬‡ï¸ ä¿å­˜è‰²é˜¶å›¾</button>
        </div>

    </div>

</div>

<!-- å…³äºæ¨¡æ€æ¡† (Popup) -->
<div class="modal-overlay" id="aboutModal" onclick="if(event.target === this) toggleModal('aboutModal', false)">
    <div class="about-card">
        <div class="about-avatar-large">ğŸ¨</div>
        <div class="about-title">ç«¥ç”»å¸ˆå´æ™“</div>
        <div class="about-subtitle">è‚–åƒç”»å¸ˆÂ·æ°´å½©Â·æ²¹ç”»<br>æ“…é•¿å„¿ç«¥è‚–åƒç”»</div>
        
        <div style="font-size: 13px; color: var(--text-sub); margin-bottom: 20px; line-height: 1.5; padding: 0 8px;">
            è¿™æ˜¯å´æ™“è€å¸ˆä¸ºå–œæ¬¢ç”»ç”»çš„æœ‹å‹ä»¬å‡†å¤‡çš„ç»˜ç”»å­¦ä¹ è¾…åŠ©å·¥å…·ï¼ŒæŒç»­æ›´æ–°ï¼Œæ°¸ä¹…å…è´¹ã€‚
        </div>
        
        <div class="action-row">
            <button class="share-btn" onclick="shareApp()">
                <span>âœ¨</span> åˆ†äº«æœ¬ç«™ç»™ä½ çš„æœ‹å‹ä»¬
            </button>
            <button class="fav-btn" onclick="addToFavorites()">
                <span>â­</span> æ”¶è—å·¥å…·
            </button>
        </div>
        
        <div style="text-align:left; margin-top:16px;">
            <div class="social-link" onclick="copyText('ç«¥ç”»å¸ˆå´æ™“')">
                ğŸ”´ å°çº¢ä¹¦ï¼šç«¥ç”»å¸ˆå´æ™“ (ç‚¹å‡»å¤åˆ¶)
            </div>
            <div class="social-link" onclick="copyText('wx_id_sample')">
                ğŸŸ¢ å¾®ä¿¡ï¼šwx_id_sample (ç‚¹å‡»å¤åˆ¶)
            </div>
        </div>
        
        <div class="copy-right">
            Â© 2026 ç«¥ç”»å¸ˆå´æ™“. All Rights Reserved.<br>
            æ¬¢è¿åˆ†äº«ï¼Œæœªç»è®¸å¯ç¦æ­¢å•†ä¸šä½¿ç”¨ã€‚
        </div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal-overlay" id="previewModal" onclick="if(event.target === this) toggleModal('previewModal', false)">
    <div class="about-card" style="width:95%; padding:20px 16px;">
        <h3 style="margin-top:0; font-size:16px;">é¢„è§ˆç»“æœ</h3>
        <img id="previewImage" class="preview-img" src="" alt="é¢„è§ˆå›¾ç‰‡" style="max-width:100%; max-height:60vh; border-radius:8px; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:16px; display:none;">
        <div style="background:#eee; height:200px; border-radius:8px; display:flex; align-items:center; justify-content:center; margin-bottom:12px; color:#999; display:none;" class="preview-placeholder">
            [ç”Ÿæˆçš„å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ]
        </div>
        <div id="mobileSaveHint" style="font-size:14px; color:#007AFF; font-weight:600; margin-bottom:16px; display:none;">
            ğŸ‘† è¯·é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ
        </div>
        <div id="pcSaveHint" style="font-size:14px; color:#007AFF; font-weight:600; margin-bottom:16px; display:none;">
            ğŸ‘‡ è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½å›¾ç‰‡
        </div>
        <div style="display:flex; gap:12px;">
            <button id="downloadBtn" class="share-btn" style="background:#007AFF; color:white; flex:1; display:none;" onclick="downloadPreviewImage()">â¬‡ï¸ ä¸‹è½½å›¾ç‰‡</button>
            <button class="share-btn" style="background:#f2f2f7; color:#333; flex:1;" onclick="toggleModal('previewModal', false)">å…³é—­</button>
        </div>
    </div>
</div>

<script>
    // === çŠ¶æ€ç®¡ç† ===
    const state = {
        currentGridMode: 'move', // 'move' (default) or 'grid'
        grid: { scale: 1, panX: 0, panY: 0, isDraggingImg: false, isDraggingGrid: false, startX: 0, startY: 0, minScale: 1, lastDist: 0, lastCenter: {x:0, y:0}, density: 3.0, isSquareGrid: false },
        poster: { scale: 1, panX: 0, panY: 0, isDraggingImg: false, startX: 0, startY: 0, minScale: 1, lastDist: 0, lastCenter: {x:0, y:0} }
    };

    function setGridMode(mode) {
        state.currentGridMode = mode;
        document.getElementById('modeMove').className = mode === 'move' ? 'mode-btn active blue-text' : 'mode-btn';
        document.getElementById('modeGrid').className = mode === 'grid' ? 'mode-btn active blue-text' : 'mode-btn';
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(c => {
            c.style.display = 'none';
            c.classList.remove('active');
        });
        
        const target = document.getElementById(tabId + '-content');
        target.style.display = 'block';
        target.classList.add('active');
    }

    // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
    function generateTimestampFilename(baseName) {
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„.jpgæ‰©å±•å
        if (baseName.endsWith('.jpg')) {
            baseName = baseName.slice(0, -4);
        }
        
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0');      // æœˆä»½ (01-12)
        const day = String(now.getDate()).padStart(2, '0');            // æ—¥æœŸ (01-31)
        const hours = String(now.getHours()).padStart(2, '0');         // å°æ—¶ (00-23)
        const minutes = String(now.getMinutes()).padStart(2, '0');     // åˆ†é’Ÿ (00-59)
        const seconds = String(now.getSeconds()).padStart(2, '0');     // ç§’ (00-59)
        
        // æ ¼å¼ï¼šåŸºç¡€åç§°_æœˆæ—¥_æ—¶_åˆ†_ç§’.jpg
        return `${baseName}_${month}${day}_${hours}_${minutes}_${seconds}.jpg`;
    }

    // é™åˆ¶Canvaså°ºå¯¸ï¼Œé¿å…è¶…å‡ºæµè§ˆå™¨é™åˆ¶ï¼ˆç‰¹åˆ«æ˜¯iOSè®¾å¤‡ï¼‰
    function limitCanvasSize(canvas, maxWidth = 2560, maxHeight = 2560) {
        const width = canvas.width;
        const height = canvas.height;
        
        // å¦‚æœå°ºå¯¸å·²ç»åœ¨é™åˆ¶å†…ï¼Œç›´æ¥è¿”å›
        if (width <= maxWidth && height <= maxHeight) {
            return canvas;
        }
        
        // è®¡ç®—ç­‰æ¯”ä¾‹ç¼©æ”¾å°ºå¯¸
        const ratio = Math.min(maxWidth / width, maxHeight / height);
        const newWidth = Math.floor(width * ratio);
        const newHeight = Math.floor(height * ratio);
        
        // åˆ›å»ºæ–°Canvaså¹¶ç»˜åˆ¶ç¼©æ”¾åçš„å›¾åƒ
        const newCanvas = document.createElement('canvas');
        newCanvas.width = newWidth;
        newCanvas.height = newHeight;
        const ctx = newCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, 0, width, height, 0, 0, newWidth, newHeight);
        
        return newCanvas;
    }

    // === æ–°é€»è¾‘ï¼šé¢„è§ˆåŠŸèƒ½æ›¿ä»£ç›´æ¥ä¸‹è½½ ===
    function previewCanvas(canvasId, baseName) {
        const type = canvasId === 'gridCanvas' ? 'grid' : 'poster';
        // å…³é”®ä¿®å¤ï¼šä»å…¨å±€å˜é‡è·å–æºå›¾ç‰‡ï¼Œè€Œä¸æ˜¯state
        const sourceImg = type === 'grid' ? gridOriginalImg : posterOriginalImg;
        
        if (!sourceImg) { alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼'); return; }
        
        const stage = document.getElementById(type + 'Window');
        const sourceCanvas = document.getElementById(canvasId);
        const s = state[type];
        
        // åˆ¤æ–­å›¾ç‰‡æ˜¯å¦å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´
        const scaledWidth = sourceCanvas.width * s.scale;
        const scaledHeight = sourceCanvas.height * s.scale;
        const imgLeft = (stage.clientWidth / 2) - (scaledWidth / 2) + s.panX;
        const imgTop = (stage.clientHeight / 2) - (scaledHeight / 2) + s.panY;
        
        const isFullyCovered = imgLeft <= 0 && imgTop <= 0 && 
                               imgLeft + scaledWidth >= stage.clientWidth && 
                               imgTop + scaledHeight >= stage.clientHeight;
        
        // åˆ›å»ºå¯¼å‡º Canvas
        const exportCanvas = document.createElement('canvas');
        
        if (isFullyCovered) {
            // å›¾ç‰‡å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜æ‰€è§å³æ‰€å¾—ï¼ˆå½“å‰è§†çª—å†…å®¹ï¼‰
            exportCanvas.width = stage.clientWidth;
            exportCanvas.height = stage.clientHeight;
            const ctx = exportCanvas.getContext('2d');
            
            // å¡«å……ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            ctx.save();
            
            // 1. ç§»åŠ¨åˆ°ä¸­å¿ƒ
            ctx.translate(exportCanvas.width / 2, exportCanvas.height / 2);
            
            // 2. åº”ç”¨å˜æ¢
            ctx.translate(s.panX, s.panY);
            ctx.scale(s.scale, s.scale);
            
            // 3. ç»˜åˆ¶æºå†…å®¹ (å›åˆ°å·¦ä¸Šè§’)
            ctx.translate(-sourceCanvas.width / 2, -sourceCanvas.height / 2);
            ctx.drawImage(sourceCanvas, 0, 0);
            
            ctx.restore();
        } else {
            // å›¾ç‰‡æœªå®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜å®é™…å›¾ç‰‡ï¼ˆä¸è£å‰ªï¼‰
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;
            const ctx = exportCanvas.getContext('2d');
            
            // ç›´æ¥ç»˜åˆ¶æºç”»å¸ƒå†…å®¹ï¼ˆä¸åº”ç”¨å˜æ¢ï¼‰
            ctx.drawImage(sourceCanvas, 0, 0);
        }
        
        // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶åï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼‰
        const filename = generateTimestampFilename(baseName);
        
        // æ˜¾ç¤ºé¢„è§ˆå¼¹çª—
        const previewImage = document.getElementById('previewImage');
        const previewPlaceholder = document.querySelector('.preview-placeholder');
        
        // è®¾ç½®å›¾ç‰‡æº
        previewImage.src = exportCanvas.toDataURL('image/jpeg', 0.95);
        previewImage.alt = filename;
        
        // æ˜¾ç¤ºå›¾ç‰‡ï¼Œéšè—å ä½ç¬¦
        previewImage.style.display = 'block';
        if (previewPlaceholder) previewPlaceholder.style.display = 'none';
        
        // æ‰“å¼€é¢„è§ˆæ¨¡æ€æ¡†
        toggleModal('previewModal', true);
    }

    // === ä¿ç•™åŸæœ‰çš„ä¸‹è½½åŠŸèƒ½ï¼ˆå¤‡ç”¨ï¼‰ ===
    function downloadCanvas(canvasId, baseName) {
        const type = canvasId === 'gridCanvas' ? 'grid' : 'poster';
        // å…³é”®ä¿®å¤ï¼šä»å…¨å±€å˜é‡è·å–æºå›¾ç‰‡ï¼Œè€Œä¸æ˜¯state
        const sourceImg = type === 'grid' ? gridOriginalImg : posterOriginalImg;
        
        if (!sourceImg) { alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼'); return; }
        
        const stage = document.getElementById(type + 'Window');
        const sourceCanvas = document.getElementById(canvasId);
        const s = state[type];
        
        // åˆ¤æ–­å›¾ç‰‡æ˜¯å¦å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´
        const scaledWidth = sourceCanvas.width * s.scale;
        const scaledHeight = sourceCanvas.height * s.scale;
        const imgLeft = (stage.clientWidth / 2) - (scaledWidth / 2) + s.panX;
        const imgTop = (stage.clientHeight / 2) - (scaledHeight / 2) + s.panY;
        
        const isFullyCovered = imgLeft <= 0 && imgTop <= 0 && 
                               imgLeft + scaledWidth >= stage.clientWidth && 
                               imgTop + scaledHeight >= stage.clientHeight;
        
        // åˆ›å»ºå¯¼å‡º Canvas
        const exportCanvas = document.createElement('canvas');
        
        if (isFullyCovered) {
            // å›¾ç‰‡å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜æ‰€è§å³æ‰€å¾—ï¼ˆå½“å‰è§†çª—å†…å®¹ï¼‰
            exportCanvas.width = stage.clientWidth;
            exportCanvas.height = stage.clientHeight;
            const ctx = exportCanvas.getContext('2d');
            
            // å¡«å……ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            ctx.save();
            
            // 1. ç§»åŠ¨åˆ°ä¸­å¿ƒ
            ctx.translate(exportCanvas.width / 2, exportCanvas.height / 2);
            
            // 2. åº”ç”¨å˜æ¢
            ctx.translate(s.panX, s.panY);
            ctx.scale(s.scale, s.scale);
            
            // 3. ç»˜åˆ¶æºå†…å®¹ (å›åˆ°å·¦ä¸Šè§’)
            ctx.translate(-sourceCanvas.width / 2, -sourceCanvas.height / 2);
            ctx.drawImage(sourceCanvas, 0, 0);
            
            ctx.restore();
        } else {
            // å›¾ç‰‡æœªå®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜å®é™…å›¾ç‰‡ï¼ˆä¸è£å‰ªï¼‰
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;
            const ctx = exportCanvas.getContext('2d');
            
            // ç›´æ¥ç»˜åˆ¶æºç”»å¸ƒå†…å®¹ï¼ˆä¸åº”ç”¨å˜æ¢ï¼‰
            ctx.drawImage(sourceCanvas, 0, 0);
        }
        
        // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
        const filename = generateTimestampFilename(baseName);
        
        const link = document.createElement('a');
        link.download = filename;
        link.href = exportCanvas.toDataURL('image/jpeg', 0.95);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // === ç¼©æ”¾ä¸è§†å›¾æ§åˆ¶ç³»ç»Ÿ ===
    function calculateMinScale(type) {
        const win = document.getElementById(type + 'Window');
        const canvas = document.getElementById(type + 'Canvas');
        if(canvas.width === 0) return 1;
        return Math.min(win.clientWidth / canvas.width, win.clientHeight / canvas.height);
    }

    function updateCanvasTransform(type) {
        const s = state[type];
        const canvas = document.getElementById(type + 'Canvas');
        const zoomVal = document.getElementById(type + 'ZoomVal');
        canvas.style.transform = `translate3d(${s.panX}px, ${s.panY}px, 0) scale(${s.scale})`;
        zoomVal.innerText = Math.round(s.scale / s.minScale * 100) + '%';
    }

    function updateZoom(type, delta, isAbsolute = false) {
        const s = state[type];
        if (!s.minScale || s.minScale === 1) s.minScale = calculateMinScale(type);
        
        let newScale;
        if (isAbsolute) newScale = delta;
        else newScale = s.scale + (delta * s.minScale);

        if(newScale < s.minScale) newScale = s.minScale; 
        if(newScale > s.minScale * 10) newScale = s.minScale * 10;
        
        s.scale = newScale;
        if (Math.abs(s.scale - s.minScale) < 0.001) { s.panX = 0; s.panY = 0; }
        updateCanvasTransform(type);
    }

    function fitView(type) {
        const s = state[type];
        s.minScale = calculateMinScale(type);
        s.scale = s.minScale;
        s.panX = 0; s.panY = 0;
        updateCanvasTransform(type);
    }
    
    document.addEventListener('fullscreenchange', handleFsChange);
    document.addEventListener('webkitfullscreenchange', handleFsChange);
    function handleFsChange() {
        setTimeout(() => {
            if(state.grid.minScale) fitView('grid');
            if(state.poster.minScale) fitView('poster');
        }, 200);
    }

    // === æ ¸å¿ƒé€»è¾‘ ===
    // åŠ¨æ€åˆ›å»ºfile inputå…ƒç´ 
    const gridImageInput = document.createElement('input');
    gridImageInput.type = 'file';
    gridImageInput.id = 'gridImageInput';
    gridImageInput.accept = 'image/*';
    gridImageInput.style.display = 'none';
    document.body.appendChild(gridImageInput);

    const posterImageInput = document.createElement('input');
    posterImageInput.type = 'file';
    posterImageInput.id = 'posterImageInput';
    posterImageInput.accept = 'image/*';
    posterImageInput.style.display = 'none';
    document.body.appendChild(posterImageInput);

    // ä¸ºä¸Šä¼ æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
    document.querySelector('.btn-upload:not(.orange)').addEventListener('click', () => gridImageInput.click());
    document.querySelector('.btn-upload.orange').addEventListener('click', () => posterImageInput.click());

    const gridCanvas = document.getElementById('gridCanvas');
    const gridCtx = gridCanvas.getContext('2d');
    let gridOriginalImg = null; let gridOffsetX = 0; let gridOffsetY = 0;

    gridImageInput.addEventListener('change', (e) => handleImageUpload(e, 'grid'));

    function handleImageUpload(e, type) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                if(type === 'grid') {
                    gridOriginalImg = img;
                    document.getElementById('gridPlaceholder').style.display = 'none';
                    gridCanvas.style.display = 'block';
                    // æ–°ç‰ˆæ²¡æœ‰has-imageç±»ï¼Œè·³è¿‡
                    gridOffsetX = 0; gridOffsetY = 0;
                    drawGrid(); setTimeout(() => fitView('grid'), 50); 
                } else {
                    posterOriginalImg = img;
                    document.getElementById('posterPlaceholder').style.display = 'none';
                    posterCanvas.style.display = 'block';
                    // æ–°ç‰ˆæ²¡æœ‰has-imageç±»ï¼Œè·³è¿‡
                    processPoster(); setTimeout(() => fitView('poster'), 50);
                }
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    function adjustGridSize(delta) {
        const slider = document.getElementById('gridSize');
        let newVal = parseFloat(slider.value) + delta;
        if(newVal < 2) newVal = 2; if(newVal > 15) newVal = 15;
        slider.value = newVal; drawGrid();
    }

    function resetGridOffset() { 
        gridOffsetX = 0; gridOffsetY = 0; 
        document.getElementById('gridSize').value = 3;
        drawGrid(); 
    }

    function drawGrid() {
        if (!gridOriginalImg) return;
        const size = parseFloat(document.getElementById('gridSize').value);
        const color = document.getElementById('gridColor').value;
        document.getElementById('gridSizeVal').textContent = size.toFixed(1);
        gridCanvas.width = gridOriginalImg.width;
        gridCanvas.height = gridOriginalImg.height;
        gridCtx.drawImage(gridOriginalImg, 0, 0);
        gridCtx.strokeStyle = color;
        gridCtx.lineWidth = Math.max(1.5, gridOriginalImg.width / 800);
        gridCtx.beginPath();
        
        if (state.grid.isSquareGrid) {
            // æ­£æ–¹å½¢ç½‘æ ¼æ¨¡å¼
            const shortSide = Math.min(gridCanvas.width, gridCanvas.height);
            const squareSize = shortSide / size; // æ­£æ–¹å½¢è¾¹é•¿
            // ç¡®å®šçŸ­è¾¹æ˜¯å®½åº¦è¿˜æ˜¯é«˜åº¦
            const isWidthShort = gridCanvas.width <= gridCanvas.height;
            
            if (isWidthShort) {
                // å®½åº¦æ˜¯çŸ­è¾¹ï¼Œä¿æŒæ¨ªå‘çº¿æ¡æ•°é‡ä¸å˜ï¼Œè°ƒæ•´çºµå‘çº¿æ¡
                const stepX = gridCanvas.width / size;
                const stepY = squareSize; // çºµå‘æ­¥é•¿ä¸ºæ­£æ–¹å½¢è¾¹é•¿
                // æ¨ªå‘çº¿æ¡ï¼ˆçŸ­è¾¹æ–¹å‘ï¼‰
                let startX = gridOffsetX % stepX; if (startX > 0) startX -= stepX;
                for (let x = startX; x < gridCanvas.width; x += stepX) {
                    gridCtx.moveTo(x, 0);
                    gridCtx.lineTo(x, gridCanvas.height);
                }
                // çºµå‘çº¿æ¡ï¼ˆé•¿è¾¹æ–¹å‘ï¼‰
                let startY = gridOffsetY % stepY; if (startY > 0) startY -= stepY;
                for (let y = startY; y < gridCanvas.height; y += stepY) {
                    gridCtx.moveTo(0, y);
                    gridCtx.lineTo(gridCanvas.width, y);
                }
            } else {
                // é«˜åº¦æ˜¯çŸ­è¾¹ï¼Œä¿æŒçºµå‘çº¿æ¡æ•°é‡ä¸å˜ï¼Œè°ƒæ•´æ¨ªå‘çº¿æ¡
                const stepX = squareSize; // æ¨ªå‘æ­¥é•¿ä¸ºæ­£æ–¹å½¢è¾¹é•¿
                const stepY = gridCanvas.height / size;
                // æ¨ªå‘çº¿æ¡ï¼ˆé•¿è¾¹æ–¹å‘ï¼‰
                let startX = gridOffsetX % stepX; if (startX > 0) startX -= stepX;
                for (let x = startX; x < gridCanvas.width; x += stepX) {
                    gridCtx.moveTo(x, 0);
                    gridCtx.lineTo(x, gridCanvas.height);
                }
                // çºµå‘çº¿æ¡ï¼ˆçŸ­è¾¹æ–¹å‘ï¼‰
                let startY = gridOffsetY % stepY; if (startY > 0) startY -= stepY;
                for (let y = startY; y < gridCanvas.height; y += stepY) {
                    gridCtx.moveTo(0, y);
                    gridCtx.lineTo(gridCanvas.width, y);
                }
            }
        } else {
            // é•¿æ–¹å½¢ç½‘æ ¼æ¨¡å¼ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
            const stepX = gridCanvas.width / size;
            const stepY = gridCanvas.height / size;
            let startX = gridOffsetX % stepX; if (startX > 0) startX -= stepX;
            for (let x = startX; x < gridCanvas.width; x += stepX) { gridCtx.moveTo(x, 0); gridCtx.lineTo(x, gridCanvas.height); }
            let startY = gridOffsetY % stepY; if (startY > 0) startY -= stepY;
            for (let y = startY; y < gridCanvas.height; y += stepY) { gridCtx.moveTo(0, y); gridCtx.lineTo(gridCanvas.width, y); }
        }
        gridCtx.stroke();
    }

    function toggleSquareGrid() {
        // åˆ‡æ¢æ­£æ–¹å½¢ç½‘æ ¼çŠ¶æ€
        const checkbox = document.getElementById('squareGridCheck');
        state.grid.isSquareGrid = checkbox.checked;
        // é‡æ–°ç»˜åˆ¶ç½‘æ ¼
        drawGrid();
    }

    // ä¸ºæ–¹æ ¼å¤é€‰æ¡†ç»‘å®šäº‹ä»¶
    document.getElementById('squareGridCheck').addEventListener('change', toggleSquareGrid);

    // === æ‰‹åŠ¿æ§åˆ¶æ ¸å¿ƒ ===
    
    function getCenter(touches) {
        return {
            x: (touches[0].clientX + touches[1].clientX) / 2,
            y: (touches[0].clientY + touches[1].clientY) / 2
        };
    }
    
    function getDistance(touches) {
        return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
    }

    function handleStart(e, type) {
        if (!e.touches) {
            if (type === 'grid' && !gridOriginalImg) return;
            if (type === 'poster' && !posterOriginalImg) return;
            state[type].startX = e.clientX;
            state[type].startY = e.clientY;
            state[type].isDraggingImg = (type === 'poster' || state.currentGridMode === 'move');
            state[type].isDraggingGrid = (type === 'grid' && state.currentGridMode === 'grid');
            return;
        }

        if (e.touches.length === 2) {
            if (type === 'grid' && !gridOriginalImg) return;
            if (type === 'poster' && !posterOriginalImg) return;
            
            const s = state[type];
            s.lastDist = getDistance(e.touches);
            s.lastCenter = getCenter(e.touches);
            
            s.isDraggingImg = (type === 'poster' || state.currentGridMode === 'move');
            s.isDraggingGrid = (type === 'grid' && state.currentGridMode === 'grid');
        }
    }

    function handleMove(e, type) {
        if (!e.touches) {
            const s = state[type];
            if (s.isDraggingGrid) {
                updateGridOffset(e.clientX - s.startX, e.clientY - s.startY);
                s.startX = e.clientX; s.startY = e.clientY;
            } else if (s.isDraggingImg) {
                updateImgPan(type, e.clientX - s.startX, e.clientY - s.startY);
                s.startX = e.clientX; s.startY = e.clientY;
            }
            return;
        }

        if (e.touches.length === 2) {
            // å…³é”®ï¼šæ ¹æ®æŒ‡å—ï¼Œåªåœ¨åŒæŒ‡æ—¶é˜»æ­¢é»˜è®¤è¡Œä¸º
            e.preventDefault(); 
            const s = state[type];
            
            // 1. å¦‚æœæ˜¯ç½‘æ ¼æ¨¡å¼ï¼Œåªç§»åŠ¨ç½‘æ ¼ (ä¿®æ­£: ç¦æ­¢ç¼©æ”¾)
            if (s.isDraggingGrid) {
                const currentCenter = getCenter(e.touches);
                const deltaX = currentCenter.x - s.lastCenter.x;
                const deltaY = currentCenter.y - s.lastCenter.y;
                updateGridOffset(deltaX, deltaY);
                s.lastCenter = currentCenter;
                return; // å…³é”®ï¼šç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œç¼©æ”¾
            }

            // 2. æ­£å¸¸ç§»åŠ¨è§†å›¾æ¨¡å¼ (ç¼©æ”¾+ç§»åŠ¨)
            const currentDist = getDistance(e.touches);
            const scaleRatio = currentDist / s.lastDist;
            const newScale = s.scale * scaleRatio;
            updateZoom(type, newScale, true);
            s.lastDist = currentDist;

            const currentCenter = getCenter(e.touches);
            const deltaX = currentCenter.x - s.lastCenter.x;
            const deltaY = currentCenter.y - s.lastCenter.y;
            
            if (s.isDraggingImg) {
                updateImgPan(type, deltaX, deltaY);
            }
            s.lastCenter = currentCenter;
        }
    }

    function updateGridOffset(dx, dy) {
        const rect = gridCanvas.getBoundingClientRect();
        const scaleX = gridCanvas.width / rect.width;
        const scaleY = gridCanvas.height / rect.height;
        gridOffsetX += dx * scaleX;
        gridOffsetY += dy * scaleY;
        drawGrid();
    }

    function updateImgPan(type, dx, dy) {
        const s = state[type];
        s.panX += dx;
        s.panY += dy;
        updateCanvasTransform(type);
    }

    function handleEnd(e) {
        state.grid.isDraggingImg = false;
        state.grid.isDraggingGrid = false;
        state.poster.isDraggingImg = false;
    }

    // ç»‘å®šäº‹ä»¶ - é€‚é…æ–°ç‰ˆcanvas-area
    const gridWin = document.getElementById('gridWindow');
    const posterWin = document.getElementById('posterWindow');

    // ç§»é™¤æ–°ç‰ˆå·²æœ‰çš„touchmoveäº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…å†²çª
    // æˆ‘ä»¬å°†åœ¨DOMContentLoadedåé‡æ–°ç»‘å®š

    // === è‰²é˜¶å·¥å…·é€»è¾‘ ===
    const posterCanvas = document.getElementById('posterCanvas');
    const posterCtx = posterCanvas.getContext('2d');
    let posterOriginalImg = null;

    posterImageInput.addEventListener('change', (e) => handleImageUpload(e, 'poster'));

    function adjustPosterLevel(delta) {
        const slider = document.getElementById('posterLevel');
        let val = parseInt(slider.value) + delta;
        if(val < 2) val = 2; if(val > 20) val = 20;
        slider.value = val; processPoster();
    }

    // è‰²é˜¶æ»‘å—é˜²æŠ–å¤„ç†å‡½æ•°ï¼ˆç§»é™¤è§†è§‰æ›´æ–°ä»¥ä¼˜åŒ–æ€§èƒ½ï¼‰
    let posterSliderTimeout = null;
    function handlePosterSliderInput(slider) {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (posterSliderTimeout) {
            clearTimeout(posterSliderTimeout);
        }
        
        // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ100msåæ‰§è¡ŒprocessPoster
        posterSliderTimeout = setTimeout(() => {
            processPoster();
        }, 100);
    }

    function processPoster() {
        if (!posterOriginalImg) return;
        const levels = parseInt(document.getElementById('posterLevel').value);
        const isGray = document.getElementById('grayscaleCheck').checked;
        document.getElementById('posterLevelVal').textContent = levels;
        posterCanvas.width = posterOriginalImg.width;
        posterCanvas.height = posterOriginalImg.height;
        posterCtx.drawImage(posterOriginalImg, 0, 0);
        const imageData = posterCtx.getImageData(0, 0, posterCanvas.width, posterCanvas.height);
        const data = imageData.data;
        const step = 255 / (levels - 1);
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i], g = data[i+1], b = data[i+2];
            if (isGray) {
                const avg = 0.299*r + 0.587*g + 0.114*b;
                r=g=b=avg;
            }
            r = Math.floor(r / step) * step;
            g = Math.floor(g / step) * step;
            b = Math.floor(b / step) * step;
            data[i] = r; data[i+1] = g; data[i+2] = b;
        }
        posterCtx.putImageData(imageData, 0, 0);
    }

    // === 4è”å¯¹æ¯”å›¾åŠŸèƒ½ ===
    // åŠ è½½æç¤ºæ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 16px;
            color: #333;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);

    // æ˜¾ç¤º/éšè—åŠ è½½æç¤º
    function showLoading(message = 'æ­£åœ¨ç”Ÿæˆ4è”å¯¹æ¯”å›¾...') {
        let overlay = document.getElementById('loadingOverlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner"></div>
                <div>${message}</div>
            `;
            document.body.appendChild(overlay);
        }
        overlay.style.display = 'flex';
    }

    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.style.display = 'none';
    }

    // å¯æŒ‡å®šè‰²é˜¶å€¼çš„å¤„ç†å‡½æ•°
    function processWithLevel(sourceCanvas, level, isGray) {
        const canvas = document.createElement('canvas');
        canvas.width = sourceCanvas.width;
        canvas.height = sourceCanvas.height;
        const ctx = canvas.getContext('2d');
        
        // ç»˜åˆ¶åŸå§‹å›¾ç‰‡
        ctx.drawImage(sourceCanvas, 0, 0);
        
        // å¦‚æœlevelä¸º0ï¼Œè¡¨ç¤ºä¸è¿›è¡Œè‰²é˜¶å¤„ç†ï¼ˆä½†åº”ç”¨é»‘ç™½æ¨¡å¼ï¼‰
        if (level === 0) {
            if (isGray) {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    const avg = 0.299*r + 0.587*g + 0.114*b;
                    data[i] = data[i+1] = data[i+2] = avg;
                }
                ctx.putImageData(imageData, 0, 0);
            }
            return canvas;
        }
        
        // è‰²é˜¶å¤„ç†
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const step = 255 / (level - 1);
        
        for (let i = 0; i < data.length; i += 4) {
            let r = data[i], g = data[i+1], b = data[i+2];
            if (isGray) {
                const avg = 0.299*r + 0.587*g + 0.114*b;
                r = g = b = avg;
            }
            r = Math.floor(r / step) * step;
            g = Math.floor(g / step) * step;
            b = Math.floor(b / step) * step;
            data[i] = r; data[i+1] = g; data[i+2] = b;
        }
        ctx.putImageData(imageData, 0, 0);
        return canvas;
    }

    // è·å–å¯¼å‡ºCanvasï¼ˆå¤ç”¨downloadCanvasçš„é€»è¾‘ï¼‰
    function getExportCanvas(sourceCanvas, type) {
        const stage = document.getElementById(type + 'Window');
        const s = state[type];
        
        // åˆ¤æ–­å›¾ç‰‡æ˜¯å¦å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´
        const scaledWidth = sourceCanvas.width * s.scale;
        const scaledHeight = sourceCanvas.height * s.scale;
        const imgLeft = (stage.clientWidth / 2) - (scaledWidth / 2) + s.panX;
        const imgTop = (stage.clientHeight / 2) - (scaledHeight / 2) + s.panY;
        
        const isFullyCovered = imgLeft <= 0 && imgTop <= 0 && 
                               imgLeft + scaledWidth >= stage.clientWidth && 
                               imgTop + scaledHeight >= stage.clientHeight;
        
        const exportCanvas = document.createElement('canvas');
        
        if (isFullyCovered) {
            // å›¾ç‰‡å®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜æ‰€è§å³æ‰€å¾—ï¼ˆå½“å‰è§†çª—å†…å®¹ï¼‰
            exportCanvas.width = stage.clientWidth;
            exportCanvas.height = stage.clientHeight;
            const ctx = exportCanvas.getContext('2d');
            
            // å¡«å……ç™½è‰²èƒŒæ™¯
            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            ctx.save();
            
            // 1. ç§»åŠ¨åˆ°ä¸­å¿ƒ
            ctx.translate(exportCanvas.width / 2, exportCanvas.height / 2);
            
            // 2. åº”ç”¨å˜æ¢
            ctx.translate(s.panX, s.panY);
            ctx.scale(s.scale, s.scale);
            
            // 3. ç»˜åˆ¶æºå†…å®¹ (å›åˆ°å·¦ä¸Šè§’)
            ctx.translate(-sourceCanvas.width / 2, -sourceCanvas.height / 2);
            ctx.drawImage(sourceCanvas, 0, 0);
            
            ctx.restore();
        } else {
            // å›¾ç‰‡æœªå®Œå…¨è¦†ç›–å¯è§†èŒƒå›´ï¼šä¿å­˜å®é™…å›¾ç‰‡ï¼ˆä¸è£å‰ªï¼‰
            exportCanvas.width = sourceCanvas.width;
            exportCanvas.height = sourceCanvas.height;
            const ctx = exportCanvas.getContext('2d');
            
            // ç›´æ¥ç»˜åˆ¶æºç”»å¸ƒå†…å®¹ï¼ˆä¸åº”ç”¨å˜æ¢ï¼‰
            ctx.drawImage(sourceCanvas, 0, 0);
        }
        
        // é™åˆ¶Canvaså°ºå¯¸ï¼Œé¿å…iOSè®¾å¤‡ä¸Šçš„å†…å­˜é—®é¢˜
        return limitCanvasSize(exportCanvas);
    }

    // ç”Ÿæˆ4è”å¯¹æ¯”å›¾
    function generateFourPanelComparison() {
        if (!posterOriginalImg) {
            alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
            return null;
        }
        
        // è·å–å½“å‰é»‘ç™½æ¨¡å¼çŠ¶æ€
        const isGray = document.getElementById('grayscaleCheck').checked;
        
        // åˆ›å»ºåŸå§‹Canvas
        const originalCanvas = document.createElement('canvas');
        originalCanvas.width = posterOriginalImg.width;
        originalCanvas.height = posterOriginalImg.height;
        const originalCtx = originalCanvas.getContext('2d');
        originalCtx.drawImage(posterOriginalImg, 0, 0);
        
        // å¤„ç†4ç§è‰²é˜¶
        const levels = [0, 12, 9, 15]; // 0è¡¨ç¤ºåŸå§‹å›¾ç‰‡ï¼ˆä½†åº”ç”¨é»‘ç™½æ¨¡å¼ï¼‰
        const processedCanvases = [];
        
        for (let i = 0; i < 4; i++) {
            const processedCanvas = processWithLevel(originalCanvas, levels[i], isGray);
            const exportCanvas = getExportCanvas(processedCanvas, 'poster');
            processedCanvases.push(exportCanvas);
        }
        
        // ç¡®å®šå•å¼ å›¾ç‰‡å°ºå¯¸ï¼ˆæ‰€æœ‰å›¾ç‰‡ä½¿ç”¨ç›¸åŒçš„å°ºå¯¸åˆ¤æ–­é€»è¾‘ï¼Œæ‰€ä»¥å°ºå¯¸åº”è¯¥ç›¸åŒï¼‰
        const singleWidth = processedCanvases[0].width;
        const singleHeight = processedCanvases[0].height;
        
        // åˆ›å»º4è”å›¾Canvas
        const fourPanelCanvas = document.createElement('canvas');
        fourPanelCanvas.width = singleWidth * 2;
        fourPanelCanvas.height = singleHeight * 2;
        const fourPanelCtx = fourPanelCanvas.getContext('2d');
        
        // å¡«å……ç™½è‰²èƒŒæ™¯
        fourPanelCtx.fillStyle = '#ffffff';
        fourPanelCtx.fillRect(0, 0, fourPanelCanvas.width, fourPanelCanvas.height);
        
        // ç»˜åˆ¶4å¼ å›¾ç‰‡ï¼ˆç”°å­—å½¢å¸ƒå±€ï¼‰
        // å›¾1-1 (0, 0)
        fourPanelCtx.drawImage(processedCanvases[0], 0, 0);
        // å›¾1-2 (singleWidth, 0)
        fourPanelCtx.drawImage(processedCanvases[1], singleWidth, 0);
        // å›¾2-1 (0, singleHeight)
        fourPanelCtx.drawImage(processedCanvases[2], 0, singleHeight);
        // å›¾2-2 (singleWidth, singleHeight)
        fourPanelCtx.drawImage(processedCanvases[3], singleWidth, singleHeight);
        
        // é™åˆ¶4è”å›¾å°ºå¯¸ï¼Œé¿å…iOSè®¾å¤‡ä¸Šçš„å†…å­˜é—®é¢˜
        // ä½¿ç”¨æ›´ä¸¥æ ¼çš„é™åˆ¶ï¼Œå› ä¸º4è”å›¾æ˜¯4å¼ å›¾ç‰‡æ‹¼æ¥ï¼Œå°ºå¯¸è¾ƒå¤§
        return limitCanvasSize(fourPanelCanvas, 2560, 2560);
    }

    // ä¿å­˜4è”å¯¹æ¯”å›¾ï¼ˆæ”¹ä¸ºé¢„è§ˆæ¨¡å¼ï¼‰
    function saveFourPanelComparison() {
        if (!posterOriginalImg) {
            alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼');
            return;
        }
        
        // æ˜¾ç¤ºç­‰å¾…æç¤º
        showLoading();
        
        // å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡UI
        setTimeout(() => {
            try {
                const fourPanelCanvas = generateFourPanelComparison();
                if (!fourPanelCanvas) {
                    hideLoading();
                    return;
                }
                
                // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶åï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼‰
                const filename = generateTimestampFilename('4è”å¯¹æ¯”å›¾');
                
                // è·å–é¢„è§ˆå›¾ç‰‡å…ƒç´ å’Œå ä½ç¬¦
                const previewImage = document.getElementById('previewImage');
                const previewPlaceholder = document.querySelector('.preview-placeholder');
                
                // è®¾ç½®å›¾ç‰‡æº
                previewImage.src = fourPanelCanvas.toDataURL('image/jpeg', 0.95);
                previewImage.alt = filename;
                
                // æ˜¾ç¤ºå›¾ç‰‡ï¼Œéšè—å ä½ç¬¦
                previewImage.style.display = 'block';
                if (previewPlaceholder) previewPlaceholder.style.display = 'none';
                
                // æ‰“å¼€é¢„è§ˆæ¨¡æ€æ¡†
                toggleModal('previewModal', true);
            } catch (error) {
                alert('ç”Ÿæˆå¤±è´¥ï¼š' + error.message);
                console.error(error);
            } finally {
                // éšè—ç­‰å¾…æç¤º
                hideLoading();
            }
        }, 10);
    }

    // === å¾®ä¿¡æµè§ˆå™¨æ£€æµ‹ä¸å¼•å¯¼ ===
    // æ£€æµ‹æ˜¯å¦ä¸ºå¾®ä¿¡æµè§ˆå™¨
    function isWeChatBrowser() {
        const ua = navigator.userAgent.toLowerCase();
        // æ£€æµ‹å¾®ä¿¡æµè§ˆå™¨ï¼Œåªè¦åŒ…å«micromessengerå³å¯
        return ua.includes('micromessenger');
    }
    
    // æ£€æµ‹æ˜¯å¦éœ€è¦æ˜¾ç¤ºå¾®ä¿¡å¼•å¯¼
    function shouldShowWeChatGuide() {
        // åªæ£€æµ‹å¾®ä¿¡æµè§ˆå™¨
        return isWeChatBrowser();
    }
    
    // å¾®ä¿¡å¼•å¯¼æ§åˆ¶å™¨
    const WeChatGuide = {
        init: function() {
            // æ ¹æ®æ£€æµ‹ç»“æœå†³å®šæ˜¯å¦æ˜¾ç¤ºå¼•å¯¼
            if (shouldShowWeChatGuide()) {
                this.showGuide();
            } else {
                this.hideGuide();
            }
        },
        
        showGuide: function() {
            const overlay = document.getElementById('wechatGuide');
            if (overlay) {
                overlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        },
        
        hideGuide: function() {
            const overlay = document.getElementById('wechatGuide');
            if (overlay) {
                overlay.style.display = 'none';
                document.body.style.overflow = '';
            }
        },
        
        copyUrl: function() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }
    };
    
    // é¡µé¢åŠ è½½ååˆå§‹åŒ–å¾®ä¿¡å¼•å¯¼
    document.addEventListener('DOMContentLoaded', function() {
        WeChatGuide.init();
        
        // é‡æ–°ç»‘å®šæ‰‹åŠ¿äº‹ä»¶ï¼Œè¦†ç›–æ–°ç‰ˆçš„é»˜è®¤äº‹ä»¶
        const gridWin = document.getElementById('gridWindow');
        const posterWin = document.getElementById('posterWindow');
        
        // ç§»é™¤æ–°ç‰ˆé»˜è®¤çš„touchmoveäº‹ä»¶ç›‘å¬å™¨
        const oldGridHandler = gridWin._touchmoveHandler;
        const oldPosterHandler = posterWin._touchmoveHandler;
        
        // é‡æ–°ç»‘å®šäº‹ä»¶
        gridWin.addEventListener('mousedown', (e) => handleStart(e, 'grid'));
        gridWin.addEventListener('mousemove', (e) => handleMove(e, 'grid'));
        gridWin.addEventListener('touchstart', (e) => handleStart(e, 'grid'), {passive: false});
        gridWin.addEventListener('touchmove', (e) => handleMove(e, 'grid'), {passive: false});

        posterWin.addEventListener('mousedown', (e) => handleStart(e, 'poster'));
        posterWin.addEventListener('mousemove', (e) => handleMove(e, 'poster'));
        posterWin.addEventListener('touchstart', (e) => handleStart(e, 'poster'), {passive: false});
        posterWin.addEventListener('touchmove', (e) => handleMove(e, 'poster'), {passive: false});

        window.addEventListener('mouseup', handleEnd);
        window.addEventListener('touchend', handleEnd);
    });

    // æ»‘å—è§†è§‰æ›´æ–°å‡½æ•°ï¼ˆé€‚é…æ–°ç‰ˆUIï¼‰
    let ticking = false;
    function onSliderInput(input) {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                updateSliderVisual(input);
                ticking = false;
            });
            ticking = true;
        }
    }

    function updateSliderVisual(input) {
        const min = input.min || 0;
        const max = input.max || 100;
        const val = input.value;
        const percent = (val - min) / (max - min) * 100;
        input.style.setProperty('--percent', percent + '%');
    }
    
    // é€‚é…æ–°ç‰ˆçš„adjustSliderå‡½æ•°
    function adjustSlider(id, delta) {
        const el = document.getElementById(id);
        el.value = parseInt(el.value) + (delta * 10);
        updateSliderVisual(el);
        // è§¦å‘ç›¸åº”çš„å¤„ç†å‡½æ•°
        if (id === 'gridSize') {
            drawGrid();
        } else if (id === 'posterLevel') {
            processPoster();
        }
    }

    // æ›´æ–°ç½‘æ ¼é¢œè‰²é€‰æ‹©å™¨çš„è§†è§‰æ›´æ–°ï¼ˆç§»é™¤éå¿…è¦çš„æ»‘å—è§†è§‰æ›´æ–°ä»¥ä¼˜åŒ–æ€§èƒ½ï¼‰
    document.getElementById('gridColor').addEventListener('input', function() {
        drawGrid();
    });

    // Modal & Share (ä¿ç•™æ–°ç‰ˆåŠŸèƒ½)
    function toggleModal(id, show) {
        const modal = document.getElementById(id);
        if(show) {
            modal.style.display = 'flex';
            void modal.offsetWidth;
            modal.classList.add('active');
        } else {
            modal.classList.remove('active');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }
    }

    function shareApp() {
        const url = window.location.href;
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        navigator.clipboard.writeText(url).then(() => {
            alert('é“¾æ¥å·²å¤åˆ¶ï¼Œåˆ†äº«ç»™ä½ çš„æœ‹å‹ä»¬å§');
        }).catch(err => {
            // é™çº§æ–¹æ¡ˆ
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('é“¾æ¥å·²å¤åˆ¶ï¼Œåˆ†äº«ç»™ä½ çš„æœ‹å‹ä»¬å§');
        });
    }

    function addToFavorites() {
        alert('è¯·ä½¿ç”¨æµè§ˆå™¨çš„"æ·»åŠ ä¹¦ç­¾"æˆ–"æ·»åŠ åˆ°ä¸»å±å¹•"åŠŸèƒ½æ¥æ”¶è—æœ¬å·¥å…· ğŸ¨');
    }

    // è®¾å¤‡æ£€æµ‹å‡½æ•°
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // é¢„è§ˆæ¡†æ˜¾ç¤ºæ—¶è°ƒæ•´ç•Œé¢
    function adjustPreviewInterface() {
        const isMobile = isMobileDevice();
        const mobileHint = document.getElementById('mobileSaveHint');
        const pcHint = document.getElementById('pcSaveHint');
        const downloadBtn = document.getElementById('downloadBtn');
        
        if (isMobile) {
            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºé•¿æŒ‰æç¤ºï¼Œéšè—ä¸‹è½½æŒ‰é’®
            if (mobileHint) mobileHint.style.display = 'block';
            if (pcHint) pcHint.style.display = 'none';
            if (downloadBtn) downloadBtn.style.display = 'none';
        } else {
            // PCç«¯ï¼šæ˜¾ç¤ºä¸‹è½½æŒ‰é’®å’ŒPCæç¤º
            if (mobileHint) mobileHint.style.display = 'none';
            if (pcHint) pcHint.style.display = 'block';
            if (downloadBtn) downloadBtn.style.display = 'flex';
        }
    }

    // ä¸‹è½½é¢„è§ˆå›¾ç‰‡
    function downloadPreviewImage() {
        const previewImage = document.getElementById('previewImage');
        if (!previewImage.src) {
            alert('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡');
            return;
        }
        
        // ä»å›¾ç‰‡URLåˆ›å»ºä¸‹è½½
        const link = document.createElement('a');
        const filename = previewImage.alt || 'ç»˜ç”»å·¥ä½œå°å›¾ç‰‡.jpg';
        link.download = filename;
        link.href = previewImage.src;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ä¿®æ”¹toggleModalå‡½æ•°ä»¥æ”¯æŒé¢„è§ˆæ¡†ç•Œé¢è°ƒæ•´
    const originalToggleModal = toggleModal;
    toggleModal = function(id, show) {
        originalToggleModal(id, show);
        if (id === 'previewModal' && show) {
            // é¢„è§ˆæ¡†æ˜¾ç¤ºæ—¶è°ƒæ•´ç•Œé¢
            setTimeout(adjustPreviewInterface, 50);
        }
    };

    function copyText(text) {
        alert('å·²å¤åˆ¶ï¼š' + text);
    }

    
</script>
</body>
</html>
