<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>æ™“è‰² Â· è°ƒè‰²åŠ©æ‰‹</title>
<script src="https://cdn.jsdelivr.net/npm/culori@3.2.0/bundled/culori.min.js"></script>
<!-- å¼•å…¥ html2canvas ç”¨äºæˆªå›¾ -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
:root {
  --accent-color: #5E5CE6; --bg-body: #F2F2F7; --surface-glass: rgba(255, 255, 255, 0.85);
  --surface-panel: #F7F8FA; --surface-opaque: #FFFFFF; --text-primary: #1C1C1E;
  --text-secondary: #8E8E93; --success: #34C759; --warning: #FF9500; --danger: #FF3B30;
  --border-light: rgba(0,0,0,0.06); --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08); --shadow-lg: 0 12px 32px rgba(0,0,0,0.12);
  --ease-out: cubic-bezier(0.25, 1, 0.5, 1);
}
/* ä¼˜åŒ–ï¼šå¢å¼º iOS ç‚¹å‡»ç¨³å®šæ€§ï¼Œé˜²æ­¢æ–‡å­—ç¼©æ”¾ */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; touch-action: manipulation; }
html { overflow-x: hidden; width: 100vw; -webkit-text-size-adjust: 100%; }
body {
  margin: 0; padding: 0; width: 100%; min-height: 100vh; background-color: var(--bg-body);
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
  color: var(--text-primary); 
  /* ä¼˜åŒ–ï¼šå½»åº•éšè—æ¨ªå‘æ»šåŠ¨æ¡ï¼Œé˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœ */
  overflow-x: hidden; overflow-y: auto; 
  -webkit-user-select: none; user-select: none;
  overscroll-behavior-x: none;
}
body.modal-open { overflow: hidden; }
.app-container { width: 100%; display: flex; flex-direction: column; position: relative; overflow-x: hidden; min-height: 100vh; }
.app-header { width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-body); z-index: 60; }
.header-right { display: flex; align-items: center; gap: 10px; }
.top-open-btn { padding: 8px 16px; background: #FFFFFF; border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--text-primary); border: 1px solid var(--border-light); box-shadow: var(--shadow-sm); cursor: pointer; }
.top-open-btn:active { transform: scale(0.95); background: #f0f0f0; }
.mode-toggle { background: rgba(255,255,255,0.9); padding: 3px; border-radius: 12px; display: flex; gap: 2px; box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); }
.mode-opt { padding: 6px 14px; border-radius: 10px; font-size: 13px; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s var(--ease-out); }
.mode-opt.active { background: var(--surface-opaque); color: var(--text-primary); box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
.palette-stage {
  height: 50vh; min-height: 350px; background: #E5E5EA; position: relative; overflow: hidden;
  display: flex; align-items: center; justify-content: center; z-index: 1; box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
  background-image: radial-gradient(#C7C7CC 1px, transparent 1px); background-size: 20px 20px; touch-action: pan-y;
}
.image-container-wrapper { width: 100%; height: 100%; position: relative; overflow: hidden; }
.upload-trigger-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 160px; z-index: 20; }
.empty-placeholder {
  width: 100%; height: 100%; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
  border-radius: 20px; box-shadow: var(--shadow-md); color: var(--text-secondary);
  display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;
}
.plus-icon { font-size: 32px; color: var(--accent-color); margin-bottom: 8px; }
.placeholder-text { font-size: 14px; font-weight: 600; color: var(--text-primary); }
#paletteImg { display: none; position: absolute; top: 0; left: 0; transform-origin: 0 0; user-select: none; pointer-events: none; border-radius: 8px; }
.crosshair { position: absolute; top: 50%; left: 50%; width: 120px; height: 120px; z-index: 50; display: none; pointer-events: auto; touch-action: none; }
.crosshair-visual { position: absolute; top: 50%; left: 50%; width: 0; height: 0; pointer-events: none; }
.crosshair-circle { position: absolute; width: 12px; height: 12px; transform: translate(-50%, -50%); border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,0.3); border-radius: 50%; background: transparent; }
.crosshair-line { position: absolute; background: #fff; box-shadow: 0 0 2px rgba(0,0,0,0.5); }
.ch-top { width: 1px; height: 14px; top: -20px; left: 0; transform: translateX(-50%); }
.ch-bottom { width: 1px; height: 14px; top: 6px; left: 0; transform: translateX(-50%); }
.ch-left { width: 14px; height: 1px; top: 0; left: -20px; transform: translateY(-50%); }
.ch-right { width: 14px; height: 1px; top: 0; left: 6px; transform: translateY(-50%); }
.crosshair.guide-active .crosshair-circle { animation: crosshair-pulse 1.8s infinite ease-in-out; border-color: var(--accent-color); border-width: 3px; box-shadow: 0 0 15px rgba(94, 92, 230, 0.6); }
@keyframes crosshair-pulse { 
  0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(94, 92, 230, 0.7); } 
  50% { transform: translate(-50%, -50%) scale(1.5); box-shadow: 0 0 0 12px rgba(94, 92, 230, 0); } 
  100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(94, 92, 230, 0); } 
}

.stage-hint { position: absolute; top: 16px; left: 0; right: 0; display: flex; justify-content: center; pointer-events: none; z-index: 40; opacity: 0; transition: opacity 0.5s; }
.stage-hint.visible { opacity: 1; }
.stage-hint-pill { background: rgba(255,255,255,0.6); backdrop-filter: blur(6px); padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 500; color: var(--text-secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid rgba(255,255,255,0.2); }
.palette-tray {
  flex: 1; background: var(--surface-panel); position: relative; display: flex; flex-direction: column; align-items: center;
  margin-top: -24px; border-top-left-radius: 32px; border-top-right-radius: 32px; z-index: 10; padding-bottom: 60px; box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
}
.tray-handle { width: 40px; height: 4px; background: #D1D1D6; border-radius: 2px; margin: 12px auto; opacity: 0.6; }
.tray-header-bar { width: 100%; height: 60px; position: absolute; top: 0; left: 0; z-index: 20; pointer-events: none; }
.info-btn { width: 36px; height: 36px; border-radius: 50%; background: #FFFFFF; box-shadow: var(--shadow-sm); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border-light); }
.info-btn:active { transform: scale(0.92); }
.action-group { position: absolute; top: 20px; right: 16px; display: flex; flex-direction: column; gap: 8px; align-items: flex-end; pointer-events: auto; z-index: 50; }
.pick-btn { height: 36px; padding: 0 16px; border-radius: 18px; background: #FFFFFF; color: #555; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; box-shadow: var(--shadow-sm); cursor: pointer; border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; min-width: 96px; }
.pick-btn.primary { background: var(--text-primary); color: #fff; box-shadow: var(--shadow-md); border: none; }
.pick-btn:active { transform: scale(0.95); }
#focusContainer { width: 100%; min-height: 240px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; margin-top: 20px; }
#trayHint { color: var(--text-secondary); font-size: 13px; font-weight: 500; margin-top: 16px; opacity: 0.8; text-align: center; line-height: 1.5; max-width: 280px; }
.focus-blob-wrapper { position: relative; width: 100%; max-width: 360px; height: 180px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.focus-blob { width: 144px; height: 144px; border-radius: 50%; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15), inset 0 -4px 8px rgba(0,0,0,0.05); border: 4px solid #fff; position: relative; z-index: 20; display: flex; align-items: center; justify-content: center; background-color: var(--sim-color); flex-shrink: 0; cursor: pointer; transition: background-color 0.4s ease-out, box-shadow 0.4s ease-out, border-color 0.4s; }
.focus-blob::after { content: ''; position: absolute; width: 62px; height: 62px; border-radius: 50%; background: var(--target-color); border: 1px solid rgba(255,255,255,0.4); z-index: 21; transition: border-color 0.1s; }
.focus-blob:active::after { border-color: transparent; }
.focus-blob.preview-mode { background-color: transparent; box-shadow: none; border: 4px solid #E5E5EA; }
.status-badge-container { position: absolute; top: 20px; left: 16px; z-index: 50; pointer-events: auto; display: flex; flex-direction: column; align-items: center; gap: 0; }
.status-badge { background: rgba(255,255,255,0.98); color: var(--text-primary); height: 36px; padding: 0 16px; border-radius: 18px; font-family: -apple-system, sans-serif; cursor: pointer; box-shadow: var(--shadow-sm); display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 8px; border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; min-width: 96px; }
.status-badge:active { transform: scale(0.98); background: #f9f9f9; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.status-dot.analyzing { background-color: var(--text-secondary); animation: pulse-dot 1.2s ease-in-out infinite; }
@keyframes pulse-dot { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }
.status-text { font-size: 12px; font-weight: 600; line-height: 1.2; text-align: left; }
.status-text b { font-size: 13px; color: var(--text-primary); }
.status-text small { font-size: 10px; color: var(--text-secondary); font-weight: 400; }
.delta-e-badge { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 400; color: var(--text-secondary); box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; z-index: 55; transition: all 0.2s; }
.delta-e-badge:active { transform: translateX(-50%) scale(0.95); }
.focus-ingredient { position: absolute; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #1D1D1F; font-weight: 700; z-index: 15; transition: all 0.6s var(--ease-out); top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); cursor: pointer; }
.focus-blob-wrapper.active .focus-ingredient { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(1); }
/* é»˜è®¤çŠ¶æ€ï¼šæ•°å­—åœ¨ä¸‹æ–¹ï¼Œå­—å·è¾ƒå¤§ */
.focus-ingredient span { 
    pointer-events: none; line-height: 1; position: absolute; 
    bottom: -16px; top: auto;
    font-size: 12px; 
    color: var(--text-secondary); white-space: nowrap; text-shadow: 0 1px 2px rgba(255,255,255,0.8); 
    transition: all 0.2s;
}
/* ç‚¹å‡»çœ¼ç›åï¼šæ•°å­—è·³åˆ°ä¸Šæ–¹ï¼Œå­—å·ç¼©å°ï¼Œè®©ä½ç»™åç§° */
.focus-blob-wrapper.show-guides .focus-ingredient span {
    top: -11px; bottom: auto;
    font-size: 10px;
}

.ingredient-label { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); padding: 4px 8px; border-radius: 6px; font-size: 11px; color: var(--text-primary); box-shadow: 0 2px 8px rgba(0,0,0,0.15); white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 200; margin-top: 6px; font-weight: 600; border: 1px solid rgba(0,0,0,0.05); }
.focus-blob-wrapper.show-names .ingredient-label { opacity: 1; }

/* è‡ªåŠ¨è°ƒè‰²æŒ‡ç¤ºæ ‡ç­¾æ ·å¼ */
.auto-guide-label { position: absolute; z-index: 300; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
/* ç§»é™¤åŠ¨ç”»ï¼Œæ”¹ä¸ºé™æ€æ˜¾ç¤ºé€»è¾‘ */
.focus-blob-wrapper.show-guides .auto-guide-label { opacity: 1; }
.focus-blob-wrapper.show-guides .ingredient-label { opacity: 1; }

/* ä¿®å¤ï¼šä½¿ç”¨ CSS div ç”»æŠ˜çº¿ï¼Œè§£å†³ html2canvas SVG å…¼å®¹æ€§é—®é¢˜ */
.guide-line-segment { position: absolute; background: rgba(28, 28, 30, 0.6); pointer-events: none; border-radius: 1px; z-index: 290; }
.guide-line-dot { position: absolute; width: 4px; height: 4px; border-radius: 50%; background: rgba(28, 28, 30, 0.6); transform: translate(-50%, -50%); z-index: 291; pointer-events: none; }
.guide-text-pill { background: rgba(28, 28, 30, 0.8); backdrop-filter: blur(8px); color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); }

.practice-hint-overlay { position: absolute; top: 75%; left: 50%; transform: translate(-50%, 0); background: rgba(255,255,255,0.95); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--text-primary); box-shadow: 0 4px 12px rgba(0,0,0,0.1); white-space: nowrap; pointer-events: none; z-index: 30; opacity: 0; animation: fade-in-up 0.5s ease-out 0.2s forwards; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(0,0,0,0.05); }
@keyframes fade-in-up { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
.section-header { width: 100%; max-width: 360px; padding: 0 20px; margin-top: 20px; margin-bottom: 16px; font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; }
.settings-icon-btn { width: 32px; height: 32px; border-radius: 8px; background: rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); flex-shrink: 0; position: relative; overflow: hidden; }
.settings-icon-btn:active { background: rgba(0,0,0,0.08); }
.manual-adjust-bar { width: 100%; max-width: 360px; padding: 0 16px; display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; row-gap: 8px; }
.adjust-chip { width: 44px; height: 36px; background-color: #fff; border-radius: 6px; position: relative; cursor: pointer; box-shadow: inset 0 1px 3px rgba(0,0,0,0.06), 0 2px 4px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.02); transition: transform 0.1s; -webkit-user-select: none; user-select: none; }
.adjust-chip:active { transform: scale(0.95); }
.adjust-chip.disabled { opacity: 0.5; filter: grayscale(100%); }
.adjust-chip.disabled::after { content: ''; position: absolute; top: 50%; left: 50%; width: 24px; height: 2px; background: #FF3B30; transform: translate(-50%, -50%) rotate(-45deg); pointer-events: none; box-shadow: 0 0 2px white; }
.adjust-chip-color { position: absolute; top: 3px; left: 3px; right: 3px; bottom: 3px; border-radius: 3px; background-image: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(0,0,0,0.05) 100%); box-shadow: inset 0 0 2px rgba(0,0,0,0.1); overflow: hidden; }
.adjust-chip.is-water .adjust-chip-color { background: #fff; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; font-size: 14px; }
.adjust-chip-label { font-size: 10px; color: var(--text-secondary); margin-top: 3px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 56px; margin-left: 0; }
.flying-drop { position: fixed; width: 24px; height: 24px; border-radius: 50%; pointer-events: none; z-index: 999; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: none; }
.pigment-modal { position: fixed; bottom: 0; left: 0; right: 0; top: 100px; background: var(--bg-body); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); display: flex; flex-direction: column; }
.pigment-modal.active { transform: translateY(0); }
.modal-header { background: var(--surface-opaque); padding: 20px 24px; border-radius: 24px 24px 0 0; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-light); }
.modal-title { font-size: 18px; font-weight: 700; color: var(--text-primary); }
.close-modal { font-size: 28px; color: var(--text-secondary); cursor: pointer; padding: 4px; line-height: 1; }
.tabs-container { background: var(--surface-opaque); padding: 12px 20px; overflow-x: auto; white-space: nowrap; display: flex; gap: 12px; flex-shrink: 0; border-bottom: 1px solid var(--border-light); -ms-overflow-style: none; scrollbar-width: none; }
.tabs-container::-webkit-scrollbar { display: none; }
.tab-chip { display: inline-block; padding: 8px 16px; border-radius: 18px; font-size: 13px; font-weight: 600; color: var(--text-secondary); background: #F2F2F7; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
.tab-chip.active { background: var(--text-primary); color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
.modal-body { flex: 1; overflow-y: auto; padding: 24px; }
.section-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; padding: 12px; background: #fff; border-radius: 12px; }
.section-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; margin-top: 24px; }
.section-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); letter-spacing: 0.5px; text-transform: uppercase; margin: 0; }
.reset-custom-btn { font-size: 12px; color: #666; cursor: pointer; background: rgba(0,0,0,0.05); padding: 4px 10px; border-radius: 12px; font-weight: 600; display: none; }
.pigment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 8px; row-gap: 20px; }
.pigment-pan-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; position: relative; }
.pigment-pan { width: 48px; height: 40px; border-radius: 8px; background-color: #fff; position: relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1), 0 2px 5px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); overflow: hidden; transition: transform 0.1s; }
.pigment-pan-color { position: absolute; top: 4px; left: 4px; right: 4px; bottom: 4px; border-radius: 4px; background-image: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(0,0,0,0.1) 100%); box-shadow: inset 0 0 2px rgba(0,0,0,0.15); }
.pigment-pan-label { font-size: 10px; color: var(--text-primary); text-align: center; line-height: 1.2; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.pan-delete-user-icon { position: absolute; top: -6px; left: -6px; width: 18px; height: 18px; border-radius: 50%; background: #FF3B30; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid #fff; z-index: 6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.pan-action-icon { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; border-radius: 50%; background: #E5E5EA; color: #1C1C1E; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 2px solid #fff; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.add-new-pigment-pan { width: 48px; height: 40px; border-radius: 8px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; color: var(--accent-color); font-size: 20px; cursor: pointer; background: #fff; }
.pigment-select-item { display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; position: relative; }
.select-check { position: absolute; top: -6px; right: -6px; width: 18px; height: 18px; border-radius: 50%; background: var(--success); color: #fff; display: none; align-items: center; justify-content: center; font-size: 10px; border: 2px solid #fff; z-index: 5; }
.pigment-select-item.selected .select-check { display: flex; }
.modal-footer { padding: 16px 24px; background: var(--surface-opaque); border-top: 1px solid var(--border-light); display: flex; gap: 12px; flex-shrink: 0; }
.btn-footer { flex: 1; padding: 14px; border-radius: 16px; font-size: 15px; font-weight: 600; border: none; cursor: pointer; text-align: center; }
.btn-primary { background: var(--text-primary); color: #fff; }
.btn-outline { background: transparent; border: 1px solid #E5E5EA; color: var(--text-primary); }
.backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
.backdrop.active { opacity: 1; pointer-events: auto; }
.toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 12px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 2000; box-shadow: var(--shadow-lg); backdrop-filter: blur(4px); }
.toast.show { opacity: 1; }
.gamut-popover { position: fixed; bottom: 20%; left: 50%; transform: translateX(-50%) translateY(20px); width: 280px; background: #FFF; border-radius: 20px; padding: 20px; box-shadow: var(--shadow-lg); z-index: 2100; opacity: 0; pointer-events: none; transition: all 0.3s var(--ease-out); border: 1px solid rgba(0,0,0,0.05); }
.gamut-popover.active { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
.gamut-popover h4 { margin: 0 0 10px 0; font-size: 15px; font-weight: 700; color: var(--text-primary); }
.gamut-popover p { margin: 0; font-size: 13px; line-height: 1.6; color: var(--text-secondary); }
.gamut-popover b { color: var(--text-primary); }
.manual-tip { width: 100%; text-align: center; color: var(--text-secondary); font-size: 11px; margin-top: 12px; opacity: 0.6; padding-bottom: 20px; }

/* æ™“è‰²ä¼˜åŒ–ï¼šå†…ç½®å¼¹çª—ï¼Œå½»åº•è§£å†³è‹¹æœæ‰‹æœºæ— æ³•å¼¹å‡ºé¢œè‰²é€‰å–å™¨çš„é—®é¢˜ */
.name-input-overlay {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.95); z-index: 200;
  display: flex; align-items: center; justify-content: center;
  padding: 20px; border-radius: 24px; visibility: hidden; opacity: 0;
  transition: all 0.2s;
}
.name-input-overlay.active { visibility: visible; opacity: 1; }
.name-input-box {
  width: 100%; max-width: 280px; background: #fff; padding: 20px;
  border-radius: 20px; box-shadow: var(--shadow-lg);
  display: flex; flex-direction: column; gap: 12px; border: 1px solid var(--border-light);
}
.name-input-box h3 { margin: 0; font-size: 16px; text-align: center; font-weight: 700; }
.name-input-field {
  width: 100%; padding: 12px; border: 1px solid #E5E5EA;
  border-radius: 12px; font-size: 14px; background: #F2F2F7; color: var(--text-primary);
}
.name-input-error { font-size: 12px; color: var(--danger); min-height: 16px; text-align: center; }
.name-input-btns { display: flex; gap: 10px; }
.name-input-btns button { flex: 1; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; }
.btn-cancel-name { background: #F2F2F7; color: var(--text-primary); }
.btn-confirm-name { background: var(--text-primary); color: #fff; opacity: 0.5; pointer-events: none; }
.btn-confirm-name.active { opacity: 1; pointer-events: auto; }
.color-picker-row { display: flex; align-items: center; gap: 10px; margin: 4px 0; }
.preview-swatch { width: 44px; height: 44px; border-radius: 12px; border: 1px solid #E5E5EA; background: #F2F2F7; flex-shrink: 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }

/* å…¨å±å–è‰²è¦†ç›–å±‚æ ·å¼ */
.picker-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: #000; z-index: 3000;
  display: flex; flex-direction: column;
  visibility: hidden; opacity: 0; transition: all 0.3s;
}
.picker-overlay.active { visibility: visible; opacity: 1; }
.picker-stage-area {
  flex: 1; position: relative; overflow: hidden;
  background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;
}
.picker-controls {
  height: 80px; background: #1C1C1E; padding: 16px 24px;
  display: flex; gap: 16px; align-items: center; justify-content: space-between;
}
.picker-controls button { flex: 1; height: 48px; border-radius: 24px; font-size: 16px; font-weight: 600; border: none; }
#pickerImage { position: absolute; pointer-events: none; user-select: none; transform-origin: 0 0; }

.eye-btn {
    width: 32px; height: 32px; border-radius: 50%;
    background: #FFFFFF; box-shadow: var(--shadow-sm);
    color: var(--text-secondary); border: 1px solid rgba(0,0,0,0.05);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; margin-top: 10px; pointer-events: auto;
}
.eye-btn.active { color: var(--text-primary); border-color: var(--text-primary); background: #f0f0f0; }

/* åˆ†äº«é®ç½©å±‚ */
.share-result-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.85); z-index: 5000;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.share-result-overlay.active { opacity: 1; pointer-events: auto; }
.share-img-wrapper {
  max-width: 85%; max-height: 80vh;
  box-shadow: 0 10px 40px rgba(0,0,0,0.5); border-radius: 12px; overflow: auto;
  -webkit-overflow-scrolling: touch;
}
.share-img-wrapper img { width: 100%; height: auto; display: block; border-radius: 12px; } /* ä¿®æ­£ï¼šè®©é¢„è§ˆå›¾æœ¬èº«æœ‰åœ†è§’ */
.share-hint-text { color: #fff; margin-top: 20px; font-size: 14px; opacity: 0.8; font-weight: 500; }
.share-close-btn { 
  margin-top: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); 
  display: flex; align-items: center; justify-content: center; color: #fff; font-size: 24px; cursor: pointer; 
}

/* æˆªå›¾æ¨¡å¼æ ·å¼è¦†ç›– */
body.capture-mode { overflow: hidden !important; background: #F2F2F7; }
/* ä¿®æ­£ï¼šä¸å†éšè—é¡¶éƒ¨æŒ‰é’®ã€çœ¼ç›æŒ‰é’®ç­‰ï¼Œåªéšè—åˆ†äº«æŒ‰é’®å’Œå¤´éƒ¨æ¡ */
/* body.capture-mode .app-header { display: none !important; }  <-- å·²åˆ é™¤ */
body.capture-mode .share-btn, body.capture-mode .share-close-btn { display: none !important; }

/* æˆªå›¾æ—¶ä¿è¯é¢œæ–™åˆ—è¡¨å®Œæ•´æ˜¾ç¤º */
body.capture-mode .app-container { height: auto !important; overflow: visible !important; }
body.capture-mode .palette-tray { height: auto !important; overflow: visible !important; flex: none; }
body.capture-mode .manual-adjust-bar { overflow: visible; flex-wrap: wrap; padding-bottom: 40px; }

/* é¡µè„šï¼šå¸¸é©»æ˜¾ç¤º */
.app-footer {
  width: 100%; padding: 30px 20px; text-align: center;
  color: #C7C7CC; font-size: 12px; font-weight: 500; letter-spacing: 0.5px;
  background: transparent;
  position: relative;
  top: -20px;
  margin-bottom: -20px;
}

@media (min-width: 768px) { .palette-stage { cursor: grab; } .palette-stage:active { cursor: grabbing; } }
</style>
</head>
<body>
<div class="app-container" id="appContainer">
  <div class="app-header">
    <button class="top-open-btn" onclick="document.getElementById('fileInput').click()">æ‰“å¼€å›¾ç‰‡é€‰è‰²</button>
    <div class="header-right">
      <div class="mode-toggle" ontouchstart="event.stopPropagation()">
        <div class="mode-opt active" id="modeWatercolor" onclick="setMode('watercolor')">æ°´å½©</div>
        <div class="mode-opt" id="modeOil" onclick="setMode('oil')">æ²¹ç”»/ä¸™çƒ¯</div>
      </div>
      <button class="info-btn share-btn" style="margin-right:10px;" onclick="triggerShare()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
      </button>
      <button class="info-btn" onclick="showInfo()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" cy="16" x2="12" y2="12"></line><line x1="12" cy="8" x2="12.01" y2="8"></line></svg></button>
    </div>
  </div>
  <div class="palette-stage" id="stage">
    <div class="image-container-wrapper" id="imgWrapper">
      <div class="upload-trigger-container" id="uploadContainer">
        <div class="empty-placeholder" id="placeholder" onclick="document.getElementById('fileInput').click()">
          <div class="plus-icon">+</div>
          <div class="placeholder-text">æ‰“å¼€å›¾ç‰‡é€‰è‰²</div>
        </div>
      </div>
      <img id="paletteImg" src="">
      <div class="crosshair" id="crosshair"><div class="crosshair-visual"><div class="crosshair-line ch-top"></div><div class="crosshair-line ch-bottom"></div><div class="crosshair-line ch-left"></div><div class="crosshair-line ch-right"></div><div class="crosshair-circle"></div></div></div>
    </div>
    <div id="stageHint" class="stage-hint"><div class="stage-hint-pill">åŒæŒ‡ç§»åŠ¨å›¾ç‰‡ï¼Œå•æŒ‡æ‹–åŠ¨åå­—å‡†å¿ƒ</div></div>
  </div>
  <div class="palette-tray" id="tray">
    <div class="tray-handle"></div>
    <div class="tray-header-bar">
      <div id="statusBadgeContainer" class="status-badge-container"></div>
      <div class="action-group" id="mainActionGroup" style="display: none;"><button class="pick-btn primary" id="pickBtn" onclick="triggerAutoMix()" ontouchstart="event.stopPropagation()">è‡ªåŠ¨è°ƒè‰²</button></div>
    </div>
    <div id="focusContainer"><div id="trayHint">ç‚¹å‡»ä¸Šæ–¹æ‰“å¼€å›¾ç‰‡é€‰è‰²</div></div>
    <div class="section-header" id="manualBarHeader" style="display:none; align-items: center; justify-content: space-between;">
      <div style="display:flex; align-items:center; gap:10px;"><span>æˆ‘çš„é¢œæ–™ç›’</span></div>
      <button class="pick-btn" id="practiceBtn" style="height: 28px; font-size: 12px; padding: 0 12px;" onclick="triggerPractice()">è°ƒè‰²ç»ƒä¹ </button>
    </div>
    <div class="manual-adjust-bar" id="manualBar" style="display:none;"></div>
    <!-- ä¼˜åŒ–ï¼šå¸¸é©»åº•éƒ¨çš„å“ç‰Œæ ‡è¯† -->
    <div class="app-footer">æ™“è‰² Â· è°ƒè‰²åŠ©æ‰‹</div>
  </div>
</div>
<input type="file" id="fileInput" accept="image/*" style="display:none">
<div class="backdrop" id="modalBackdrop" onclick="closePigmentModal()"></div>
<div class="backdrop" id="gamutBackdrop" style="z-index: 2050;" onclick="closeGamutPopover()"></div>
<div class="gamut-popover" id="gamutPopover"><h4 id="gamutTitle">è‰²åŸŸè¯´æ˜</h4><div id="gamutDesc" style="font-size: 13px; line-height: 1.6; color: var(--text-secondary);"></div></div>
<div class="pigment-modal" id="pigmentModal">
  <div class="modal-header"><div class="modal-title">é…ç½®é¢œæ–™ç›’</div><div class="close-modal" onclick="closePigmentModal()">Ã—</div></div>
  <div class="tabs-container" id="modalTabs"></div>
  <div class="modal-body">
    <div id="setDescription" class="section-desc"></div>
    <div class="section-header-row"><div class="section-title" id="currentGroupTitle">å½“å‰ç»„é¢œæ–™</div><div class="reset-custom-btn" id="resetCustomBtn" onclick="resetCustomSet()">é‡ç½®</div></div>
    <div class="pigment-grid" id="currentSetGrid"></div>
    <div id="librarySection" style="display:none;"><div class="section-title" style="margin-top:40px; border-top:1px dashed #eee; padding-top:20px; margin-bottom: 16px;">æ·»åŠ æ›´å¤šé¢œæ–™</div><div class="pigment-grid" id="fullLibraryGrid"></div></div>
    <div class="name-input-overlay" id="nameInputOverlay">
      <div class="name-input-box">
        <h3>æ·»åŠ æ–°é¢œæ–™</h3>
        <input type="text" id="newPigmentNameInput" class="name-input-field" placeholder="è¯·è¾“å…¥é¢œæ–™åç§°(5å­—å†…)" maxlength="5">
        
        <!-- ç§»é™¤æ—§çš„é¢œè‰²é€‰æ‹©å™¨ï¼Œæ”¹ä¸ºæ‹ç…§å–è‰²æŒ‰é’® -->
        <div class="color-picker-row">
           <div id="previewSwatch" class="preview-swatch"></div>
           <button class="btn-outline" style="flex:1; border-radius:12px; padding:12px; font-weight:600; color:var(--text-primary);" onclick="document.getElementById('pickerFileInput').click()">ğŸ“· æ‹ç…§/ä¸Šä¼ å›¾ç‰‡å–è‰²</button>
           <input type="file" id="pickerFileInput" accept="image/*" style="display:none" onchange="handlePickerFile(this)">
        </div>

        <div id="nameInputError" class="name-input-error"></div>
        <div class="name-input-btns">
          <button class="btn-cancel-name" onclick="hideNameInputOverlay()">å–æ¶ˆ</button>
          <button id="confirmAddBtn" class="btn-confirm-name" onclick="finalSubmit()">ç¡®è®¤æ·»åŠ </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer"><button class="btn-footer btn-outline" onclick="closePigmentModal()">å–æ¶ˆ</button><button class="btn-footer btn-primary" onclick="confirmPigmentSet()">ä½¿ç”¨æ­¤æ–¹æ¡ˆ</button></div>
</div>

<!-- å…¨å±æ‹ç…§å–è‰²å±‚ -->
<div id="pickerOverlay" class="picker-overlay">
   <div class="picker-stage-area" id="pickerStageArea">
       <img id="pickerImage" src="">
       <div class="crosshair" id="pickerCrosshair"><div class="crosshair-visual"><div class="crosshair-line ch-top"></div><div class="crosshair-line ch-bottom"></div><div class="crosshair-line ch-left"></div><div class="crosshair-line ch-right"></div><div class="crosshair-circle"></div></div></div>
   </div>
   <div class="picker-controls">
       <button class="btn-cancel-name" onclick="closePickerStage()">å–æ¶ˆ</button>
       <button class="btn-confirm-name active" onclick="confirmPickerColor()">ä½¿ç”¨æ­¤é¢œè‰²</button>
   </div>
</div>

<!-- åˆ†äº«ç»“æœå±‚ -->
<div id="shareResultOverlay" class="share-result-overlay">
  <div class="share-img-wrapper"><img id="shareResultImg"></div>
  <div class="share-hint-text">é•¿æŒ‰å›¾ç‰‡ä¿å­˜æˆ–å‘é€ç»™æœ‹å‹</div>
  <div class="share-close-btn" onclick="closeShareOverlay()">Ã—</div>
</div>

<div id="toast" class="toast"></div>
<script>
const culoriLib = window.culori;
const differenceCiede2000 = culoriLib ? culoriLib.differenceCiede2000() : null;
// ... (ä¿ç•™åŸæœ‰é¢œæ–™æ•°æ®) ...
const ALL_PIGMENTS = [
  { id: 'lemon-yellow', name: 'æŸ æª¬é»„', rgb: [255, 247, 0], hex: '#FFF700' }, 
  { id: 'medium-yellow', name: 'ä¸­é»„', rgb: [255, 230, 0], hex: '#FFD200' },
  { id: 'cadmium-yellow', name: 'é•‰é»„', rgb: [255, 246, 0], hex: '#FFF600' }, 
  { id: 'indian-yellow', name: 'å°åº¦é»„', rgb: [227, 168, 87], hex: '#E3A857' },
  { id: 'naples-yellow', name: 'é‚£ä¸å‹’æ–¯é»„', rgb: [250, 218, 94], hex: '#FADA5E' }, 
  { id: 'jaune-brilliant', name: 'äº®é»„', rgb: [247, 229, 195], hex: '#F7E5C3' },
  { id: 'yellow-ochre', name: 'åœŸé»„', rgb: [204, 150, 30], hex: '#CC961E' }, 
  { id: 'raw-sienna', name: 'ç”Ÿè¤', rgb: [214, 138, 89], hex: '#D68A59' }, 
  { id: 'quinacridone-gold', name: 'æ˜†å£«é…®é‡‘', rgb: [197, 148, 43], hex: '#C5942B' },
  { id: 'buff-titanium', name: 'é’›é»„', rgb: [227, 218, 194], hex: '#E3DAC2' }, 
  { id: 'vermilion', name: 'æœ±çº¢', rgb: [255, 60, 10], hex: '#FF3C0A' }, 
  { id: 'cadmium-red', name: 'é•‰çº¢', rgb: [227, 0, 34], hex: '#E30022' },
  { id: 'scarlet', name: 'çŒ©çº¢', rgb: [255, 36, 0], hex: '#FF2400' }, 
  { id: 'crimson', name: 'å¤§çº¢', rgb: [220, 0, 40], hex: '#DC0028' },
  { id: 'cherry-red', name: 'æ¨±æ¡ƒçº¢', rgb: [210, 4, 45], hex: '#D2042D' }, 
  { id: 'alizarin-crimson', name: 'æ·±çº¢', rgb: [140, 20, 30], hex: '#8C141E' },
  { id: 'permanent-alizarin', name: 'æ°¸å›ºèŒœçº¢', rgb: [220, 20, 60], hex: '#DC143C' }, 
  { id: 'carmine', name: 'èƒ­è„‚çº¢', rgb: [150, 0, 24], hex: '#960018' },
  { id: 'rose-madder', name: 'ç«ç‘°çº¢', rgb: [220, 50, 70], hex: '#DC3246' }, 
  { id: 'quinacridone-rose', name: 'ç«ç‘°èŒœçº¢', rgb: [164, 0, 60], hex: '#A4003C' }, 
  { id: 'potters-pink', name: 'æ³¢ç‰¹ç²‰', rgb: [230, 170, 158], hex: '#E6AA9E' }, 
  { id: 'fluorescent-pink', name: 'è§å…‰ç²‰', rgb: [255, 20, 147], hex: '#FF1493' }, 
  { id: 'lavender', name: 'è–°è¡£è‰ç´«', rgb: [181, 126, 220], hex: '#B57EDC' },
  { id: 'cobalt-violet', name: 'é’´ç´«', rgb: [148, 87, 235], hex: '#9457EB' },
  { id: 'violet', name: 'ç´«ç½—å…°', rgb: [138, 43, 226], hex: '#8A2BE2' }, 
  { id: 'dioxazine-purple', name: 'ç´«çº¢', rgb: [72, 40, 109], hex: '#48286D' }, 
  { id: 'ultramarine', name: 'ç¾¤é’', rgb: [25, 25, 140], hex: '#19198C' },
  { id: 'cobalt-blue', name: 'é’´è“', rgb: [0, 71, 171], hex: '#0047AB' }, 
  { id: 'cerulean-blue', name: 'æ¹–è“', rgb: [42, 82, 190], hex: '#2A52BE' },
  { id: 'phthalo-blue', name: 'é…é’è“', rgb: [0, 15, 137], hex: '#000F89' }, 
  { id: 'prussian-blue', name: 'æ™®è“', rgb: [0, 49, 83], hex: '#003153' },
  { id: 'indanthrone-blue', name: 'é˜´ä¸¹å£«æ—è“', rgb: [0, 46, 99], hex: '#002E63' },
  { id: 'indigo', name: 'é›è“', rgb: [79, 105, 198], hex: '#4F69C6' }, 
  { id: 'cobalt-teal', name: 'é’´ç»¿æ¾çŸ³', rgb: [0, 204, 223], hex: '#00CCDF' }, 
  { id: 'turquoise', name: 'ç»¿æ¾çŸ³', rgb: [64, 224, 208], hex: '#40E0D0' },
  { id: 'viridian', name: 'ç¿ ç»¿', rgb: [64, 130, 109], hex: '#40826D' }, 
  { id: 'emerald-green', name: 'æ°¸å›ºç»¿', rgb: [80, 200, 120], hex: '#50C878' },
  { id: 'permanent-light-green', name: 'æ°¸å›ºæµ…ç»¿', rgb: [139, 195, 74], hex: '#8BC34A' }, 
  { id: 'sap-green', name: 'æ ‘æ±ç»¿', rgb: [80, 125, 42], hex: '#507D2A' },
  { id: 'olive-green', name: 'æ©„æ¦„ç»¿', rgb: [128, 128, 0], hex: '#808000' }, 
  { id: 'hookers-green', name: 'è™å…‹ç»¿', rgb: [73, 121, 107], hex: '#49796B' },
  { id: 'perylene-green', name: 'ä½©é‡Œæ—ç»¿', rgb: [28, 53, 45], hex: '#1C352D' }, 
  { id: 'fluorescent-green', name: 'è§å…‰ç»¿', rgb: [0, 255, 0], hex: '#00FF00' },
  { id: 'burnt-sienna', name: 'ç†Ÿè¤', rgb: [136, 45, 23], hex: '#882D17' },
  { id: 'raw-umber', name: 'ç”Ÿè¤(æ·±)', rgb: [115, 74, 18], hex: '#734A12' }, 
  { id: 'burnt-umber', name: 'ç†Ÿèµ­', rgb: [138, 51, 36], hex: '#8A3324' },
  { id: 'sepia', name: 'ä¹Œè´¼å¢¨', rgb: [112, 66, 20], hex: '#704214' }, 
  { id: 'vandyke-brown', name: 'å‡¡æˆ´å…‹æ£•', rgb: [65, 38, 29], hex: '#41261D' }, 
  { id: 'paynes-grey', name: 'ä½©æ©ç°', rgb: [83, 104, 120], hex: '#536878' },
  { id: 'davys-grey', name: 'æˆ´ç»´æ–¯ç°', rgb: [85, 85, 85], hex: '#555555' }, 
  { id: 'neutral-tint', name: 'ä¸­æ€§ç°', rgb: [79, 79, 85], hex: '#4F4F55' },
  { id: 'ivory-black', name: 'è±¡ç‰™é»‘', rgb: [30, 30, 30], hex: '#1E1E1E' },
  { id: 'mars-black', name: 'é©¬æ–¯é»‘', rgb: [35, 30, 30], hex: '#231E1E' }, 
  { id: 'titanium-white', name: 'é’›ç™½', rgb: [255, 255, 255], hex: '#FFFFFF' }
];
const PRESET_TABS = [
  { id: 'custom', name: 'è‡ªå®šä¹‰è‰²1', desc: 'åŸºäºæ ‡å‡†24è‰²ï¼Œå¯è‡ªç”±å¢åˆ é¢œæ–™ã€‚é…ç½®ä¼šä¿å­˜ã€‚' },
  { id: 'custom2', name: 'è‡ªå®šä¹‰è‰²2', desc: 'åŸºäºæ ‡å‡†12è‰²ï¼Œå¯è‡ªç”±å¢åˆ é¢œæ–™ã€‚é…ç½®ä¼šä¿å­˜ã€‚' },
  { id: 'basic', name: 'åŸºç¡€ä¸‰è‰²', desc: 'çº¢é»„è“ (RYB) ç»å…¸ç»„åˆã€‚', ids: ['medium-yellow', 'crimson', 'ultramarine', 'titanium-white'] },
  { id: 'modern', name: 'ç°ä»£ä¸‰åŸè‰²', desc: 'CMY ä½“ç³»ï¼Œè‰²åŸŸæœ€å¹¿ã€‚', ids: ['lemon-yellow', 'quinacridone-rose', 'phthalo-blue', 'titanium-white'] },
  { id: 'split', name: 'å†·æš–åŒåŸè‰²', desc: '6è‰²ç³»ç»Ÿï¼ŒåŒ…å«å†·æš–å€¾å‘ã€‚', ids: ['lemon-yellow', 'medium-yellow', 'crimson', 'vermilion', 'ultramarine', 'phthalo-blue', 'titanium-white'] },
  { id: 'std12', name: 'æ ‡å‡†12è‰²', desc: 'å†™ç”Ÿå¸¸ç”¨12è‰²ç»„åˆã€‚', ids: ['lemon-yellow', 'medium-yellow', 'yellow-ochre', 'vermilion', 'alizarin-crimson', 'ultramarine', 'cobalt-blue', 'sap-green', 'viridian', 'burnt-sienna', 'burnt-umber', 'titanium-white'] },
  { id: 'std24', name: 'æ ‡å‡†24è‰²', desc: 'å…¨èƒ½24è‰²ä¸“ä¸šé…ç½®ã€‚', ids: ['lemon-yellow', 'medium-yellow', 'naples-yellow', 'yellow-ochre', 'raw-sienna', 'vermilion', 'scarlet', 'crimson', 'alizarin-crimson', 'rose-madder', 'carmine', 'violet', 'ultramarine', 'cobalt-blue', 'cerulean-blue', 'prussian-blue', 'viridian', 'emerald-green', 'sap-green', 'permanent-light-green', 'burnt-sienna', 'burnt-umber', 'raw-umber', 'paynes-grey', 'titanium-white'] },
  { id: 'std48', name: 'æ ‡å‡†48è‰²', desc: 'å¤§å¸ˆçº§å…¨è‰²åŸŸé…ç½®ï¼Œæ¶µç›–å‡ ä¹æ‰€æœ‰å¸¸ç”¨é¢œæ–™ã€‚', ids: ['lemon-yellow', 'medium-yellow', 'cadmium-yellow', 'indian-yellow', 'naples-yellow', 'jaune-brilliant', 'yellow-ochre', 'raw-sienna', 'quinacridone-gold', 'buff-titanium', 'vermilion', 'cadmium-red', 'scarlet', 'crimson', 'alizarin-crimson', 'permanent-alizarin', 'carmine', 'rose-madder', 'quinacridone-rose', 'potters-pink', 'lavender', 'cobalt-violet', 'violet', 'dioxazine-purple', 'ultramarine', 'cobalt-blue', 'cerulean-blue', 'phthalo-blue', 'prussian-blue', 'indanthrone-blue', 'indigo', 'cobalt-teal', 'turquoise', 'viridian', 'emerald-green', 'permanent-light-green', 'sap-green', 'olive-green', 'hookers-green', 'perylene-green', 'burnt-sienna', 'raw-umber', 'burnt-umber', 'sepia', 'vandyke-brown', 'paynes-grey', 'neutral-tint', 'ivory-black', 'titanium-white'] },
  { id: 'portrait', name: 'äººç‰©è‚¤è‰²', desc: 'ç²¾é€‰è‚¤è‰²è°ƒé…ä¸“ç”¨è‰²ã€‚', ids: ['yellow-ochre', 'vermilion', 'rose-madder', 'burnt-sienna', 'titanium-white', 'ultramarine', 'viridian', 'lavender', 'scarlet', 'cherry-red', 'lemon-yellow', 'fluorescent-pink'] },
  { id: 'landscape', name: 'é£æ™¯å†™ç”Ÿ', desc: 'å¼ºåŒ–åœŸè‰²ç³»å’Œç»¿è‰²ç³»ã€‚', ids: ['yellow-ochre', 'sap-green', 'burnt-sienna', 'ultramarine', 'alizarin-crimson', 'titanium-white', 'viridian', 'raw-umber', 'paynes-grey'] },
  { id: 'botanical', name: 'æ¤ç‰©èŠ±å‰', desc: 'ä¸“ä¸ºèŠ±å‰æ¤ç‰©è®¾è®¡ï¼Œä¸°å¯Œçš„çº¢ç´«ç»¿ã€‚', ids: ['lemon-yellow', 'scarlet', 'quinacridone-rose', 'dioxazine-purple', 'sap-green', 'perylene-green', 'cobalt-teal', 'paynes-grey', 'titanium-white', 'indanthrone-blue'] },
  { id: 'urban', name: 'åŸå¸‚é€Ÿå†™', desc: 'å»ºç­‘ä¸è¡—æ™¯å¸¸ç”¨ï¼Œå¼ºè°ƒç°è°ƒä¸é˜´å½±ã€‚', ids: ['burnt-sienna', 'ultramarine', 'yellow-ochre', 'buff-titanium', 'neutral-tint', 'vermilion', 'sap-green', 'cobalt-teal', 'titanium-white'] },
  { id: 'impressionist', name: 'å°è±¡æ´¾', desc: 'é«˜çº¯åº¦å…‰è‰²ï¼Œä¸å«çº¯é»‘ã€‚', ids: ['cadmium-yellow', 'viridian', 'alizarin-crimson', 'cobalt-blue', 'cerulean-blue', 'violet', 'titanium-white', 'cadmium-red', 'emerald-green'] },
  { id: 'zorn', name: 'ä½æ©ç›˜', desc: 'Anders Zorn ç»å…¸é™åˆ¶è‰²ç›˜ï¼Œæ“…é•¿è‚¤è‰²å’Œå†™å®ã€‚', ids: ['yellow-ochre', 'vermilion', 'ivory-black', 'titanium-white'] }
];
const GAMUT_INFO = {
  level1: { title: "è¶…å‡ºé¢œæ–™ç›’è‰²åŸŸ", threshold: "Î”E > 5.0", desc: "æ„å‘³ç€å½“å‰<b>[é¢œæ–™ç›’]</b>ä¸­çš„é¢œæ–™å“ç§è°ƒé…ä¸å‡ºè¿™ç§é¢œè‰²ã€‚<br><br>åœ¨<b>[è‡ªåŠ¨è°ƒè‰²]</b>ä¸­å¯çœ‹åˆ°é¢œæ–™ç›’å­è°ƒå‡ºçš„é¢œè‰²å’Œç›®æ ‡è‰²é—´çš„å¼ºçƒˆåå·®ã€‚" },
  level2: { title: "æ¥è¿‘é¢œæ–™ç›’è‰²åŸŸ", threshold: "2.0 < Î”E â‰¤ 5.0", desc: "è™½ç„¶ç”¨<b>[é¢œæ–™ç›’]</b>ä¸­çš„é¢œæ–™å“ç§èƒ½è°ƒå‡ºå’Œç›®æ ‡è‰²ç±»ä¼¼çš„é¢œè‰²ï¼Œä½†æ˜¯æ„Ÿè§‰æ˜¾è‘—æ–­å±‚ï¼Œäººçœ¼å¯å¯Ÿè§‰æ˜æ˜¾ä¸ä¸€è‡´ã€‚<br><br>åœ¨<b>[è‡ªåŠ¨è°ƒè‰²]</b>ä¸­å¯çœ‹åˆ°é¢œæ–™ç›’å­è°ƒå‡ºçš„é¢œè‰²å’Œç›®æ ‡è‰²é—´çš„æ˜æ˜¾ä¸ä¸€è‡´ã€‚" },
  level3: { title: "å¤§è‡´åŒ¹é…é¢œæ–™ç›’è‰²åŸŸ", threshold: "1.0 < Î”E â‰¤ 2.0", desc: "å¯é€šè¿‡<b>[é¢œæ–™ç›’]</b>ä¸­çš„é¢œæ–™å“ç§è°ƒå‡ºå’Œç›®æ ‡è‰²è¿‘ä¼¼çš„é¢œè‰²ï¼Œç¨æœ‰è‰²å·®ï¼Œä½†äººçœ¼å¯ä»¥æ¥æ”¶ã€‚<br><br>åœ¨<b>[è‡ªåŠ¨è°ƒè‰²]</b>ä¸­å¯è§‚å¯Ÿåˆ°è°ƒåˆè‰²å’Œç›®æ ‡è‰²çš„å¾®å°è‰²å·®ã€‚" },
  level4: { title: "å®Œç¾åŒ¹é…é¢œæ–™ç›’è‰²åŸŸ", threshold: "Î”E â‰¤ 1.0", desc: "å¯é€šè¿‡<b>[é¢œæ–™ç›’]</b>ä¸­çš„é¢œæ–™å“ç§è°ƒå‡ºå’Œç›®æ ‡è‰²å‡ ä¹ç›¸åŒçš„é¢œè‰²ï¼Œå‡†ç¡®åº¦æé«˜ï¼Œè‚‰çœ¼å‡ ä¹æ— æ³•åˆ†è¾¨è‰²å·®ã€‚<br><br>åœ¨<b>[è‡ªåŠ¨è°ƒè‰²]</b>ä¸­å¯è§‚å¯Ÿåˆ°å‡ ä¹ä¸€è‡´çš„è°ƒåˆè‰²å’Œç›®æ ‡è‰²ã€‚" }
};
let appState = { currentTabId: 'custom', customIds: [], customIds2: [], activePigments: [], userAddedPigments: [] }, modalState = { viewingTabId: 'custom', tempCustom1Ids: [], tempCustom2Ids: [] }, currentMode = 'watercolor', globalSession = { targetRGB: null, targetHex: null, currentRecipe: [], activePool: [], minError: null }, disabledPigmentIds = new Set(), moveDebounceTimer = null, gearRotation = 0, autoMixCount = 0;
let isGuideVisible = false;

function showGamutPopover(level) {
  const info = GAMUT_INFO[level]; if(!info) return;
  document.getElementById('gamutTitle').innerText = info.title;
  document.getElementById('gamutDesc').innerHTML = `${info.desc}<div style="margin-top:10px;padding-top:10px;border-top:1px dashed #eee;color:#999;font-size:12px;">è‰²å·®èŒƒå›´ï¼š${info.threshold}</div>`;
  document.getElementById('gamutBackdrop').classList.add('active');
  document.getElementById('gamutPopover').classList.add('active');
}
function showDeltaPopover() {
  document.getElementById('gamutTitle').innerText = "è‰²å·®å€¼ Î”E è¯´æ˜";
  document.getElementById('gamutDesc').innerHTML = `<div style="margin-bottom:6px;"><b>åŒå¿ƒåœ†çš„å†…åœ†ï¼š</b>åå­—å‡†å¿ƒåœ¨å›¾ç‰‡ä¸­å–å¾—çš„é¢œè‰²â€”â€”<b style="color:var(--text-primary)">ç›®æ ‡è‰²</b>ï¼›</div><div style="margin-bottom:6px;"><b>å¤–ç¯ï¼š</b>ç”¨å½“å‰é¢œæ–™ç›’ä¸­çš„é¢œå“ç§è°ƒåˆçš„é¢œè‰²â€”â€”<b style="color:var(--text-primary)">è°ƒåˆè‰²</b>ã€‚</div><div style="margin-bottom:12px;"><b>Î”Eï¼š</b>æ˜¯ä»¥ä¸Šä¸¤ç§é¢œè‰²é—´çš„è‰²å·®å€¼ã€‚è¿™ä¸ªå€¼è¶Šå°ï¼Œé¢œè‰²è¶Šæ¥è¿‘ã€‚</div><div style="font-size:12px; border-top:1px solid var(--border-light); padding-top:8px;">æˆ‘ä»¬è°ƒè‰²çš„ç›®æ ‡æ˜¯å°½é‡å‡å°Î”Eï¼Œä½†åœ¨è°ƒè‰²çš„è¿‡ç¨‹ä¸­ï¼ŒÎ”Eä¼šå—åˆ¶äºé¢œæ–™ç›’ä¸­çš„é¢œæ–™å“ç§è€Œä¸èƒ½ç»§ç»­å˜å°ã€‚</div>`;
  document.getElementById('gamutBackdrop').classList.add('active');
  document.getElementById('gamutPopover').classList.add('active');
}
function closeGamutPopover() { document.getElementById('gamutBackdrop').classList.remove('active'); document.getElementById('gamutPopover').classList.remove('active'); document.body.classList.remove('modal-open'); }
function getGamutLevel(dE) { if (dE <= 1.0) return 'level4'; if (dE <= 2.0) return 'level3'; if (dE <= 5.0) return 'level2'; return 'level1'; }
function getCapsuleHTML(level) {
  const map = { level4: { k: 'å®Œç¾åŒ¹é…', dot: 'var(--success)' }, level3: { k: 'å¤§è‡´åŒ¹é…', dot: 'var(--success)' }, level2: { k: 'æ¥è¿‘', dot: 'var(--warning)' }, level1: { k: 'è¶…å‡º', dot: 'var(--danger)' } };
  const item = map[level]; return `<div class="status-dot" style="background:${item.dot}"></div><span class="status-text"><b>${item.k}</b><br><small>é¢œæ–™ç›’è‰²åŸŸ</small></span>`;
}
function showToast(msg, duration = 2500) {
  const toast = document.getElementById('toast'); if (!toast) return;
  toast.textContent = msg; toast.classList.add('show');
  if (toast.timeoutId) clearTimeout(toast.timeoutId);
  toast.timeoutId = setTimeout(() => toast.classList.remove('show'), duration);
}
function getDeltaE(rgb1, rgb2) {
  if (!culoriLib) { const r = (rgb1[0]-rgb2[0])*0.3, g = (rgb1[1]-rgb2[1])*0.59, b = (rgb1[2]-rgb2[2])*0.11; return Math.sqrt(r*r + g*g + b*b)*0.5; }
  return differenceCiede2000({mode:'rgb', r:rgb1[0]/255, g:rgb1[1]/255, b:rgb1[2]/255}, {mode:'rgb', r:rgb2[0]/255, g:rgb2[1]/255, b:rgb2[2]/255});
}
function initApp() {
  const st = localStorage.getItem('currentTabId'), sc = localStorage.getItem('customIds'), sc2 = localStorage.getItem('customIds2'), su = localStorage.getItem('userAddedPigments');
  appState.currentTabId = st || 'custom';
  appState.customIds = sc ? JSON.parse(sc) : [...PRESET_TABS.find(t=>t.id==='std24').ids];
  appState.customIds2 = sc2 ? JSON.parse(sc2) : [...PRESET_TABS.find(t=>t.id==='std12').ids];
  appState.userAddedPigments = su ? JSON.parse(su) : [];
  updateActivePigments(); updateGlobalSessionPool(); renderManualBar();
  document.getElementById('trayHint').innerHTML = "ç‚¹å‡»ä¸Šæ–¹æ‰“å¼€å›¾ç‰‡é€‰è‰²";
  setInterval(() => {
    gearRotation += 90;
    const btn = document.getElementById('configGearBtn');
    if (btn) btn.style.transform = `rotate(${gearRotation}deg)`;
  }, 15000);
  document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
  // Add double click prevention
  document.addEventListener('dblclick', function(e) { e.preventDefault(); }, { passive: false });
}
function updateGlobalSessionPool() {
  let p = [...appState.activePigments], w = null;
  if (currentMode === 'watercolor') { p = p.filter(x=>x.id!=='titanium-white'); w = { id:'water', name:'æ°´', rgb:[255,255,255], hex:'#FFFFFF', isWater:true }; }
  else { let ew = p.find(x=>x.id==='titanium-white'); if(ew) { w = ew; p = p.filter(x=>x.id!==ew.id); } else w = { id:'titanium-white', name:'é’›ç™½', rgb:[255,255,255], hex:'#FFFFFF' }; }
  globalSession.activePool = [...p]; if(w) globalSession.activePool.push(w);
}
function getAllAvailablePigments() { return [...ALL_PIGMENTS, ...appState.userAddedPigments]; }
function updateActivePigments() {
  let ids; if(appState.currentTabId==='custom') ids=appState.customIds; else if(appState.currentTabId==='custom2') ids=appState.customIds2; else ids=PRESET_TABS.find(t=>t.id===appState.currentTabId).ids;
  const all = getAllAvailablePigments(); appState.activePigments = [];
  ids.forEach(id => { let p = all.find(x=>x.id===id); if(p) { let n = JSON.parse(JSON.stringify(p)); n.cmyk = rgbToCmyk(...n.rgb); appState.activePigments.push(n); } });
  localStorage.setItem('currentTabId', appState.currentTabId); 
  if(appState.currentTabId==='custom') localStorage.setItem('customIds', JSON.stringify(appState.customIds));
  if(appState.currentTabId==='custom2') localStorage.setItem('customIds2', JSON.stringify(appState.customIds2));
}
function openPigmentModal() {
  modalState.viewingTabId = appState.currentTabId; 
  modalState.tempCustom1Ids = [...appState.customIds];
  modalState.tempCustom2Ids = [...appState.customIds2];
  renderModalContent(); document.getElementById('modalBackdrop').classList.add('active');
  document.getElementById('pigmentModal').classList.add('active'); document.body.classList.add('modal-open');
  setTimeout(() => { const a = document.querySelector('.tab-chip.active'); if(a) a.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center'}); }, 100);
}
function closePigmentModal() { document.getElementById('modalBackdrop').classList.remove('active'); document.getElementById('pigmentModal').classList.remove('active'); document.body.classList.remove('modal-open'); }
function confirmPigmentSet() {
  try { 
    appState.currentTabId = modalState.viewingTabId; 
    appState.customIds = [...modalState.tempCustom1Ids];
    appState.customIds2 = [...modalState.tempCustom2Ids];
    updateActivePigments(); updateGlobalSessionPool(); renderManualBar(); showToast("é¢œæ–™ç®±é…ç½®å·²æ›´æ–°"); 
  } catch(e){console.error(e)} finally{closePigmentModal()}
}
function switchModalTab(id) { 
  modalState.viewingTabId = id; 
  renderModalContent(); 
}
function toggleCustomPigment(id) { 
  if(id==='titanium-white')return; 
  const target = (modalState.viewingTabId === 'custom2') ? modalState.tempCustom2Ids : modalState.tempCustom1Ids;
  const i = target.indexOf(id); 
  if(i>-1) target.splice(i,1); else target.push(id); 
  renderModalContent(); 
}
function resetCustomSet() { 
  if(confirm("ç¡®å®šè¦é‡ç½®å—ï¼Ÿ")) { 
    const defaultSetId = modalState.viewingTabId === 'custom2' ? 'std12' : 'std24'; 
    const defaultIds = [...PRESET_TABS.find(t=>t.id===defaultSetId).ids];
    if(modalState.viewingTabId === 'custom2') modalState.tempCustom2Ids = defaultIds; else modalState.tempCustom1Ids = defaultIds;
    renderModalContent(); 
  } 
}

let tempNewPigmentHex = null;

// æ–°çš„ï¼šå…¨å±æ‹ç…§å–è‰²é€»è¾‘
let pickerState = { x:0, y:0, scale:1 };
const pickerImage = document.getElementById('pickerImage');
const pickerStage = document.getElementById('pickerStageArea');
const pickerCrosshair = document.getElementById('pickerCrosshair');
const pickerOffC = document.createElement('canvas');
const pickerOffCtx = pickerOffC.getContext('2d');
let isPD = false, pSX = 0, pSY = 0, pCX = 0, pCY = 0;

function triggerAddUserPigment() {
  const overlay = document.getElementById('nameInputOverlay');
  const input = document.getElementById('newPigmentNameInput');
  const error = document.getElementById('nameInputError');
  const preview = document.getElementById('previewSwatch');
  const confirmBtn = document.getElementById('confirmAddBtn');
  input.value = ""; error.innerText = "";
  tempNewPigmentHex = null;
  preview.style.backgroundColor = '#F2F2F7'; 
  confirmBtn.classList.remove('active'); 
  overlay.classList.add('active');
  setTimeout(() => input.focus(), 150);
}

function hideNameInputOverlay() { document.getElementById('nameInputOverlay').classList.remove('active'); }

function handlePickerFile(input) {
  const f = input.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = (e) => {
    pickerImage.src = e.target.result;
    pickerImage.onload = () => {
      initPickerStage();
      document.getElementById('pickerOverlay').classList.add('active');
    };
  };
  r.readAsDataURL(f);
  input.value = ''; // Reset input
}

function initPickerStage() {
  const r = pickerStage.getBoundingClientRect();
  const ir = pickerImage.naturalWidth / pickerImage.naturalHeight;
  const sr = r.width / r.height;
  pickerState.scale = ir > sr ? (r.width * 0.95) / pickerImage.naturalWidth : (r.height * 0.95) / pickerImage.naturalHeight;
  pickerState.x = (r.width - pickerImage.naturalWidth * pickerState.scale) / 2;
  pickerState.y = (r.height - pickerImage.naturalHeight * pickerState.scale) / 2;
  pCX = 0; pCY = 0; // Reset crosshair to center
  
  pickerOffC.width = pickerImage.naturalWidth;
  pickerOffC.height = pickerImage.naturalHeight;
  pickerOffCtx.drawImage(pickerImage, 0, 0);
  
  // FIX: Explicitly ensure crosshair is visible
  pickerCrosshair.style.display = 'block';

  updatePickerView();
}

function updatePickerView() {
  pickerImage.style.transform = `translate3d(${pickerState.x}px, ${pickerState.y}px, 0) scale(${pickerState.scale})`;
  pickerCrosshair.style.transform = `translate(calc(-50% + ${pCX}px), calc(-50% + ${pCY}px))`;
}

// Picker Events
pickerCrosshair.addEventListener('touchstart', (e) => { e.preventDefault(); isPD=true; pSX=e.touches[0].clientX - pCX; pSY=e.touches[0].clientY - pCY; });
pickerCrosshair.addEventListener('mousedown', (e) => { e.preventDefault(); isPD=true; pSX=e.clientX - pCX; pSY=e.clientY - pCY; });
window.addEventListener('touchmove', (e) => { 
  if(!isPD) return; 
  const touch = e.touches[0];
  const r = pickerStage.getBoundingClientRect();
  const w = r.width/2 - 20, h = r.height/2 - 20;
  pCX = Math.max(-w, Math.min(w, touch.clientX - pSX));
  pCY = Math.max(-h, Math.min(h, touch.clientY - pSY));
  updatePickerView();
}, {passive: false});
window.addEventListener('mousemove', (e) => {
  if(!isPD) return;
  const r = pickerStage.getBoundingClientRect();
  const w = r.width/2 - 20, h = r.height/2 - 20;
  pCX = Math.max(-w, Math.min(w, e.clientX - pSX));
  pCY = Math.max(-h, Math.min(h, e.clientY - pSY));
  updatePickerView();
});
window.addEventListener('touchend', () => isPD=false);
window.addEventListener('mouseup', () => isPD=false);

function closePickerStage() {
  document.getElementById('pickerOverlay').classList.remove('active');
}

function confirmPickerColor() {
  // Calculate color
  const r = pickerStage.getBoundingClientRect();
  // Visual position of crosshair center relative to stage
  const cx = r.left + r.width/2 + pCX;
  const cy = r.top + r.height/2 + pCY;
  
  // Map to image coordinates
  const ix = (cx - r.left - pickerState.x) / pickerState.scale;
  const iy = (cy - r.top - pickerState.y) / pickerState.scale;
  
  // Sampling logic (Average 5x5)
  const rad = 2; 
  const sx = Math.max(0, Math.floor(ix - rad));
  const sy = Math.max(0, Math.floor(iy - rad));
  const w = Math.min(pickerImage.naturalWidth, sx + rad*2 + 1) - sx;
  const h = Math.min(pickerImage.naturalHeight, sy + rad*2 + 1) - sy;
  
  if (w > 0 && h > 0) {
    const data = pickerOffCtx.getImageData(sx, sy, w, h).data;
    let rsum=0, gsum=0, bsum=0, count=0;
    for(let i=0; i<data.length; i+=4) {
      rsum += data[i]; gsum += data[i+1]; bsum += data[i+2]; count++;
    }
    const rFinal = Math.round(rsum/count), gFinal = Math.round(gsum/count), bFinal = Math.round(bsum/count);
    const hex = "#" + ((1 << 24) + (rFinal << 16) + (gFinal << 8) + bFinal).toString(16).slice(1);
    
    // Update preview
    tempNewPigmentHex = hex;
    document.getElementById('previewSwatch').style.backgroundColor = hex;
    document.getElementById('confirmAddBtn').classList.add('active');
    closePickerStage();
  }
}

// æœ€ç»ˆæäº¤ï¼šæ ¡éªŒå¹¶æ·»åŠ 
function finalSubmit() {
  const input = document.getElementById('newPigmentNameInput');
  const error = document.getElementById('nameInputError');
  const n = input.value.trim();
  
  if (!n) { error.innerText = "åç§°ä¸èƒ½ä¸ºç©º"; return; }
  if (n.length > 5) { error.innerText = "åç§°ä¸èƒ½è¶…è¿‡5ä¸ªå­—"; return; }
  if (getAllAvailablePigments().some(x => x.name === n)) { error.innerText = "åç§°å·²å­˜åœ¨"; return; }
  if (!tempNewPigmentHex) { error.innerText = "è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰å–é¢œè‰²"; return; }

  // æ‰€æœ‰æ ¡éªŒé€šè¿‡ï¼Œæ‰§è¡Œæ·»åŠ 
  const r=parseInt(tempNewPigmentHex.substr(1,2),16), g=parseInt(tempNewPigmentHex.substr(3,2),16), b=parseInt(tempNewPigmentHex.substr(5,2),16);
  const np = { id:'u_'+Date.now()+'_'+Math.floor(Math.random()*1000), name:n, hex:tempNewPigmentHex, rgb:[r,g,b], isUserCreated:true };
  
  appState.userAddedPigments.push(np);
  localStorage.setItem('userAddedPigments', JSON.stringify(appState.userAddedPigments));
  
  // æ˜ç¡®çš„éš”ç¦»é€»è¾‘
  if(modalState.viewingTabId === 'custom') {
    modalState.tempCustom1Ids.push(np.id);
  } else if(modalState.viewingTabId === 'custom2') {
    modalState.tempCustom2Ids.push(np.id);
  }
  
  renderModalContent(); 
  showToast("å·²æˆåŠŸæ·»åŠ æ–°é¢œæ–™"); 
  hideNameInputOverlay();
}
function deleteUserPigment(id) {
  if (confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
    appState.userAddedPigments = appState.userAddedPigments.filter(x => x.id !== id);
    localStorage.setItem('userAddedPigments', JSON.stringify(appState.userAddedPigments));
    appState.customIds = appState.customIds.filter(x => x !== id);
    appState.customIds2 = appState.customIds2.filter(x => x !== id);
    if(modalState.tempCustom1Ids) modalState.tempCustom1Ids = modalState.tempCustom1Ids.filter(x => x !== id);
    if(modalState.tempCustom2Ids) modalState.tempCustom2Ids = modalState.tempCustom2Ids.filter(x => x !== id);
    renderModalContent(); showToast("å·²åˆ é™¤è‡ªå®šä¹‰é¢œæ–™");
  }
}
function renderModalContent() {
  const tabs = document.getElementById('modalTabs'); tabs.innerHTML=''; PRESET_TABS.forEach(t=>{ const c=document.createElement('div'); c.className=`tab-chip ${t.id===modalState.viewingTabId?'active':''}`; c.innerText=t.name; c.onclick=()=>switchModalTab(t.id); tabs.appendChild(c); });
  const isC = (modalState.viewingTabId==='custom' || modalState.viewingTabId==='custom2'), curT = PRESET_TABS.find(t=>t.id===modalState.viewingTabId); 
  let ids = (modalState.viewingTabId === 'custom') ? modalState.tempCustom1Ids : (modalState.viewingTabId === 'custom2' ? modalState.tempCustom2Ids : curT.ids);
  document.getElementById('setDescription').innerText=curT.desc; document.getElementById('currentGroupTitle').innerText=isC?"è‡ªå®šä¹‰":"åŒ…å«é¢œæ–™"; document.getElementById('resetCustomBtn').style.display=isC?'block':'none';
  const grid = document.getElementById('currentSetGrid'); grid.innerHTML=''; const all = getAllAvailablePigments();
  all.forEach(p=>{ if(ids.includes(p.id)) grid.appendChild(createPanElement(p, isC?()=>toggleCustomPigment(p.id):()=>{}, isC?'action-remove':'', !isC)); });
  const libS = document.getElementById('librarySection'), libG = document.getElementById('fullLibraryGrid');
  if(isC){ libS.style.display='block'; libG.innerHTML=''; all.forEach(p=>{ if(p.id==='titanium-white')return; libG.appendChild(createSelectablePan(p, ids.includes(p.id), ()=>toggleCustomPigment(p.id), p.isUserCreated?()=>deleteUserPigment(p.id):null)); }); const add = document.createElement('div'); add.className='add-new-pigment-pan'; add.innerText='+'; add.onclick=triggerAddUserPigment; libG.appendChild(add); } else libS.style.display='none';
}
function createPanElement(p, click, icon, read) {
  const i = document.createElement('div'); i.className='pigment-pan-item'; if(read) i.style.cursor='default';
  const pan = document.createElement('div'); pan.className='pigment-pan'; const c = document.createElement('div'); c.className='pigment-pan-color'; c.style.backgroundColor=p.hex; pan.appendChild(c);
  const l = document.createElement('span'); l.className='pigment-pan-label'; l.innerText=p.name; i.appendChild(pan); i.appendChild(l);
  if(!read && icon) { const ic = document.createElement('div'); ic.className=`pan-action-icon ${icon}`; ic.innerText=icon==='action-remove'?'-':'+'; i.appendChild(ic); }
  i.onclick=click; return i;
}
function createSelectablePan(p, sel, click, del) {
  const i = document.createElement('div'); i.className=`pigment-select-item ${sel?'selected':''}`;
  if(del){ const d = document.createElement('div'); d.className='pan-delete-user-icon'; d.innerText='Ã—'; d.onclick=(e)=>{e.stopPropagation();del()}; i.appendChild(d); }
  const pan = document.createElement('div'); pan.className='pigment-pan'; const c = document.createElement('div'); c.className='pigment-pan-color'; c.style.backgroundColor=p.hex; pan.appendChild(c);
  const ch = document.createElement('div'); ch.className='select-check'; ch.innerText='âœ“'; i.appendChild(ch);
  const l = document.createElement('span'); l.className='pigment-pan-label'; l.innerText=p.name; i.appendChild(pan); i.appendChild(l); i.onclick=click; return i;
}
function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min)h=s=0;else{const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h*=360}return {h,s,l}}
function rgbToCmyk(r,g,b){let c=1-(r/255),m=1-(g/255),y=1-(b/255),k=Math.min(c,m,y);return k===1?[0,0,0,1]:[(c-k)/(1-k)/(1-k),(m-k)/(1-k)/(1-k),(y-k)/(1-k)/(1-k),k]}
function cmykToRgb(c,m,y,k){return [Math.round(255*(1-c)*(1-k)),Math.round(255*(1-m)*(1-k)),Math.round(255*(1-y)*(1-k))]}
function mixPigments(ing){let C=0,M=0,Y=0,K=0,W=0;ing.forEach(x=>{if(!x.pigment._cmyk)x.pigment._cmyk=rgbToCmyk(...x.pigment.rgb);C+=x.pigment._cmyk[0]*x.amount;M+=x.pigment._cmyk[1]*x.amount;Y+=x.pigment._cmyk[2]*x.amount;K+=x.pigment._cmyk[3]*x.amount;W+=x.amount});return W===0?[255,255,255]:cmykToRgb(C/W,M/W,Y/W,K/W)}
function solveRecipe(tr, tg, tb, dry = false) {
  const tRGB = [tr, tg, tb], tHex = `rgb(${tr},${tg},${tb})`; if (!globalSession.activePool.length) updateGlobalSessionPool();
  let pool = [...globalSession.activePool]; pool = pool.filter(x => !disabledPigmentIds.has(x.id));
  let white = pool.find(x => x.isWater || x.id === 'titanium-white'); if (white) pool = pool.filter(x => x.id !== white.id);
  let candidates = []; const keep = 5;
  const addCand = (r, score) => { if (candidates.length >= keep && score >= candidates[candidates.length - 1].score) return; const rec = r.map(x => ({ ...x })); candidates.push({ recipe: rec, score: score }); candidates.sort((a, b) => a.score - b.score); if (candidates.length > keep) candidates.pop(); };
  const ev = (r) => { let m = mixPigments(r), e = getDeltaE(tRGB, m), p = e > 5.0 ? 0.02 : (e > 2.0 ? 0.05 : 0.1), t = e + (r.length - 1) * p; addCand(r, t); };
  pool.forEach(p => { ev([{ pigment: p, amount: 100 }]); if (white) { for (let w = 5; w <= 95; w += 5) { ev([{ pigment: p, amount: 100 - w }, { pigment: white, amount: w, isWater: (white.id === 'water' || white.isWater) }]); } } });
  for (let i = 0; i < pool.length; i++) { for (let j = i + 1; j < pool.length; j++) { for (let r = 10; r <= 90; r += 10) { ev([{ pigment: pool[i], amount: r }, { pigment: pool[j], amount: 100 - r }]); if (white) { for (let w = 10; w <= 60; w += 10) { const rem = 100 - w; let a1 = Math.round(rem * (r / 100)), a2 = rem - a1; if (a1 > 1 && a2 > 1) { ev([{ pigment: pool[i], amount: a1 }, { pigment: pool[j], amount: a2 }, { pigment: white, amount: w, isWater: (white.id === 'water' || white.isWater) }]); } } } } } }
  let fullPool = [...pool]; if (white) fullPool.push(white); let globalBest = [], globalMinE = Infinity;
  candidates.forEach(cand => {
    let currentRecipe = cand.recipe.map(x => ({ ...x })), currentScore = cand.score, improved = true, rounds = 0;
    while(improved && rounds < 2) { improved = false; rounds++; for(let p of fullPool) { if(!currentRecipe.find(r => r.pigment.id === p.id)) { if(currentRecipe.length >= 5) continue; [2, 5, 8].forEach(addAmt => { let factor = (100 - addAmt) / 100, newRec = currentRecipe.map(x => ({...x, amount: x.amount * factor})); newRec.push({ pigment: p, amount: addAmt, isWater: (p.id==='water'||p.isWater) }); let m = mixPigments(newRec), e = getDeltaE(tRGB, m), pen = (newRec.length - 1) * (e > 2 ? 0.05 : 0.1), score = e + pen; if(score < currentScore) { currentScore = score; currentRecipe = newRec; improved = true; } }); } } }
    let changed = true, iter = 0;
    while(changed && iter < 100) { changed = false; iter++; let sum = currentRecipe.reduce((a,b)=>a+b.amount,0); if(Math.abs(sum-100) > 0.01) currentRecipe.forEach(x => x.amount = x.amount/sum*100); for(let i=0; i<currentRecipe.length; i++) { for(let j=0; j<currentRecipe.length; j++) { if(i===j) continue; if(currentRecipe[i].amount > 1) { currentRecipe[i].amount -= 1; currentRecipe[j].amount += 1; let m = mixPigments(currentRecipe), e = getDeltaE(tRGB, m), pen = (currentRecipe.length - 1) * (e > 2 ? 0.05 : 0.1), score = e + pen; if(score < currentScore) { currentScore = score; changed = true; } else { currentRecipe[i].amount += 1; currentRecipe[j].amount -= 1; } } } } }
    currentRecipe = currentRecipe.filter(x => x.amount > 0.5); if(currentScore < globalMinE) { globalMinE = currentScore; globalBest = currentRecipe; }
  });
  const mergedMap = new Map(); globalBest.forEach(item => { const pid = item.pigment.id; if (mergedMap.has(pid)) mergedMap.get(pid).amount += item.amount; else mergedMap.set(pid, { ...item }); });
  globalBest = Array.from(mergedMap.values()); globalBest.sort((a,b)=>b.amount-a.amount);
  if (dry) return { minError: globalMinE };
  globalSession.targetRGB = tRGB; globalSession.targetHex = tHex; globalSession.currentRecipe = globalBest.map(x => ({ ...x }));
  globalSession.currentRecipe.forEach(x => { document.querySelectorAll('.adjust-chip').forEach(c => { if (c.parentElement.querySelector('.adjust-chip-label').innerText === x.pigment.name) { const r = c.getBoundingClientRect(); flyPigmentToMix(r.left + r.width / 2, r.top + r.height / 2, x.pigment.hex === '#ffffff' ? '#e0e0e0' : x.pigment.hex); } }); });
  setTimeout(() => { recalculateAndShow(true); document.getElementById('manualBar').style.display = 'flex'; document.getElementById('manualBarHeader').style.display = 'flex'; }, 500);
}
function triggerAutoMix(){ if(!globalSession.targetRGB)showToast('è¯·å…ˆå–è‰²');else { autoMixCount++; solveRecipe(...globalSession.targetRGB); } }
function triggerPractice(){ 
  if(!globalSession.targetRGB) { showToast('è¯·å…ˆå–è‰²'); return; }
  const wrapper = document.querySelector('.focus-blob-wrapper');
  if (wrapper && wrapper.classList.contains('active')) {
    wrapper.classList.remove('active'); 
    wrapper.classList.remove('show-names');
    const blob = wrapper.querySelector('.focus-blob');
    if(blob) { blob.style.backgroundColor = 'transparent'; blob.style.boxShadow = 'none'; blob.style.borderColor = '#E5E5EA'; }
    setTimeout(() => startPracticeSession(), 500); 
  } else startPracticeSession();
}
function startPracticeSession() {
  globalSession.currentRecipe=[]; renderPM(globalSession.targetHex,null);
  const wrapper = document.querySelector('.focus-blob-wrapper');
  if(wrapper) { const hint = document.createElement('div'); hint.className = 'practice-hint-overlay'; hint.innerHTML = 'ğŸ‘‡ ç‚¹å‡»ä¸‹æ–¹é¢œæ–™è°ƒé…æ­¤é¢œè‰²'; wrapper.appendChild(hint); }
  setTimeout(() => { const mb = document.getElementById('manualBar'); if (mb) { const rect = mb.getBoundingClientRect(); if (rect.top > window.innerHeight * 0.8) window.scrollBy({ top: 150, behavior: 'smooth' }); } }, 100);
}
function togglePigmentDisable(id) { if (disabledPigmentIds.has(id)) { disabledPigmentIds.delete(id); showToast('é¢œæ–™å·²æ¢å¤'); } else { disabledPigmentIds.add(id); showToast('é¢œæ–™å·²æš‚åœä½¿ç”¨'); } renderManualBar(); }

function renderManualBar(){
  const b=document.getElementById('manualBar');b.innerHTML=''; if(!globalSession.activePool.length)return;
  globalSession.activePool.forEach(p=>{
    const w=document.createElement('div');w.style.display='flex';w.style.flexDirection='column';w.style.alignItems='center'; 
    const c=document.createElement('div');c.className='adjust-chip'; 
    if(disabledPigmentIds.has(p.id)) c.classList.add('disabled'); 
    if(p.isWater||p.id==='water'){
      c.classList.add('is-water');
      const i=document.createElement('div');i.className='adjust-chip-color';i.innerText='ğŸ’§';c.appendChild(i);
    } else {
      const i=document.createElement('div');i.className='adjust-chip-color';i.style.backgroundColor=p.hex;c.appendChild(i);
    }
    let pressTimer = null, isLongPress = false, startX = 0, startY = 0;
    const startPress = (e) => { if(e.type==='mousedown' && e.button!==0) return; const touch = e.touches ? e.touches[0] : e; startX = touch.clientX; startY = touch.clientY; isLongPress = false; pressTimer = setTimeout(() => { isLongPress = true; pressTimer = null; togglePigmentDisable(p.id); if(navigator.vibrate) navigator.vibrate(50); }, 600); };
    const movePress = (e) => { if (!pressTimer) return; const touch = e.touches ? e.touches[0] : e; if (Math.hypot(touch.clientX - startX, touch.clientY - startY) > 10) cancelPress(); };
    const cancelPress = () => { if (pressTimer) { clearTimeout(pressTimer); pressTimer = null; } };
    const handleClick = (e) => { if(isLongPress) { e.preventDefault(); e.stopPropagation(); isLongPress = false; return; } if (!disabledPigmentIds.has(p.id)) { const r=c.getBoundingClientRect();flyPigmentToMix(r.left+r.width/2,r.top+r.height/2,p.hex==='#ffffff'?'#e0e0e0':p.hex); } manualAddPigment(p); };
    c.addEventListener('touchstart', startPress, {passive: true}); c.addEventListener('touchmove', movePress, {passive: true}); c.addEventListener('touchend', cancelPress); c.addEventListener('mousedown', startPress); c.addEventListener('mousemove', movePress); c.addEventListener('mouseup', cancelPress); c.addEventListener('mouseleave', cancelPress); c.onclick = handleClick;
    const l=document.createElement('span');l.className='adjust-chip-label';l.innerText=p.name;w.appendChild(c);w.appendChild(l);b.appendChild(w);
  });
  const configRow = document.createElement('div'); configRow.style.width = '100%'; configRow.style.display = 'flex'; configRow.style.justifyContent = 'center'; configRow.style.marginTop = '8px'; configRow.style.marginBottom = '4px';
  const configBtn = document.createElement('div'); configBtn.id = 'configGearBtn'; configBtn.className = 'settings-icon-btn'; configBtn.style.width = '36px'; configBtn.style.height = '36px'; configBtn.style.background = '#FFFFFF'; configBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.05)'; configBtn.style.border = '1px solid rgba(0,0,0,0.05)'; configBtn.style.transform = `rotate(${gearRotation}deg)`; configBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path></svg>'; configBtn.onclick = openPigmentModal;
  configRow.appendChild(configBtn); b.appendChild(configRow);
  const tip = document.createElement('div'); tip.className = 'manual-tip'; tip.innerHTML = 'é•¿æŒ‰é¢œæ–™å¯ <b style="color:var(--text-primary)">æš‚åœ/æ¢å¤</b> ä½¿ç”¨'; b.appendChild(tip);
}

function flyPigmentToMix(sx,sy,c){
  const t=document.querySelector('.focus-blob'); if(!t)return; const r=t.getBoundingClientRect(), tx=r.left+r.width/2, ty=r.top+r.height/2, a=Math.random()*2*Math.PI, rad=35+Math.random()*30, lx=tx+rad*Math.cos(a), ly=ty+rad*Math.sin(a);
  const d=document.createElement('div');d.className='flying-drop';d.style.background=c;d.style.left=sx+'px';d.style.top=sy+'px';d.style.transform='translate(-50%,-50%)';document.body.appendChild(d);
  d.animate([{transform:'translate(-50%,-50%) scale(1)',opacity:1},{transform:`translate(${lx-sx}px,${ly-sy}px) scale(0)`,opacity:0}],{duration:500+Math.random()*200,easing:'cubic-bezier(0.2,0.8,0.2,1)'}).onfinish=()=>d.remove();
}
function manualAddPigment(p){ if(disabledPigmentIds.has(p.id)) { showToast("è¯¥é¢œæ–™å·²æš‚åœï¼Œé•¿æŒ‰æ¢å¤"); return; } if(!globalSession.targetRGB)return;let t=globalSession.currentRecipe.reduce((s,i)=>s+i.amount,0), a=t===0?50:Math.max(1,Math.round(t*0.02)), e=globalSession.currentRecipe.find(x=>x.pigment.id===p.id); if(e)e.amount+=a;else globalSession.currentRecipe.push({pigment:p,amount:a,isWater:p.id==='water'||p.isWater});recalculateAndShow(false) }
function recalculateAndShow(animate = false){
  let d=globalSession.currentRecipe.map(x=>({...x})), t=d.reduce((s,i)=>s+i.amount,0); d.forEach(x=>x.amount=(x.amount/t)*100); d.sort((a,b)=>b.amount-a.amount);
  let m=mixPigments(d), del=globalSession.targetRGB?getDeltaE(globalSession.targetRGB,m):0;
  showFocusBlob(globalSession.targetHex,{ingredients:d.map(x=>({hex:x.pigment.hex,amount:x.amount,isWater:x.isWater,name:x.pigment.name})),simHex:`rgb(${m[0]},${m[1]},${m[2]})`,deviation:del,targetRGB:globalSession.targetRGB,mixRGB:m}, animate);
}
function updateStatusBadge(minE) {
  if (minE === null || minE === undefined) return;
  const container = document.getElementById('statusBadgeContainer'); if(!container) return; container.innerHTML = ''; const bad = document.createElement('div'); bad.className = 'status-badge'; const lv = getGamutLevel(minE); bad.innerHTML = getCapsuleHTML(lv); bad.onclick = (e) => { e.stopPropagation(); showGamutPopover(lv); }; container.appendChild(bad);
  
  // Add Eye Button
  const eye = document.createElement('div');
  eye.className = `eye-btn ${isGuideVisible ? 'active' : ''}`;
  eye.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
  eye.onclick = (e) => { e.stopPropagation(); toggleGuides(); };
  container.appendChild(eye);
}
function toggleGuides() {
  isGuideVisible = !isGuideVisible;
  const w = document.querySelector('.focus-blob-wrapper');
  if (w) w.classList.toggle('show-guides', isGuideVisible);
  const eyeBtn = document.querySelector('.eye-btn');
  if (eyeBtn) {
    if (isGuideVisible) eyeBtn.classList.add('active');
    else eyeBtn.classList.remove('active');
  }
}
function showAnalyzingState() {
  const container = document.getElementById('statusBadgeContainer'); if (container && !container.querySelector('.status-dot.analyzing')) container.innerHTML = `<div class="status-badge" style="cursor:default"><div class="status-dot analyzing"></div><span class="status-text"><b>åˆ†æä¸­</b><br><small>è®¡ç®—é…æ–¹...</small></span></div>`;
  const deltaBadge = document.querySelector('.delta-e-badge'); if (deltaBadge && deltaBadge.innerText !== '...') { deltaBadge.innerText = '...'; deltaBadge.style.opacity = '0.7'; }
}
function createGuideLabel(text, ax, ay, lx, ly, wrapper, isStraight = false) {
  const label = document.createElement('div');
  label.className = 'auto-guide-label';
  // æ ‡ç­¾åŸºå‡†ç‚¹
  label.style.left = `calc(50% + ${ax}px)`;
  label.style.top = `calc(50% + ${ay}px)`;
  
  const dx = lx - ax;
  const dy = ly - ay;
  
  // --- é¢œè‰²å®šä¹‰ ---
  const lineColor = "rgba(28, 28, 30, 0.6)";

  if (isStraight) {
    // === ç›´çº¿æ¨¡å¼ (ç”¨äºé…æ–¹è‰²) ===
    const len = Math.hypot(dx, dy);
    const ang = Math.atan2(dy, dx) * 180 / Math.PI;
    
    const line = document.createElement('div');
    line.className = 'guide-line-segment';
    line.style.width = `${len}px`;
    line.style.height = '1.5px';
    line.style.backgroundColor = lineColor; // æ˜¾å¼è®¾ç½®é¢œè‰²
    line.style.left = '0';
    line.style.top = '0';
    line.style.transformOrigin = '0 50%';
    line.style.transform = `rotate(${ang}deg)`;
    label.appendChild(line);

  } else {
    // === é’è§’æŠ˜çº¿æ¨¡å¼ (ç”¨äºç›®æ ‡è‰²/è°ƒåˆè‰²) ===
    // é€»è¾‘ï¼šå…ˆæ–œç€èµ°(A->B)ï¼Œå†æ°´å¹³èµ°(B->C)
    // è¿™æ ·å½¢æˆçš„è½¬è§’æ˜¯é’è§’ï¼Œæ¯”ç›´è§’(Lå‹)æ›´ç¾è§‚
    
    const tailLength = (dx > 0) ? 20 : -20; // æ°´å¹³å°¾å·´é•¿åº¦
    
    // Aç‚¹: (0,0) èµ·ç‚¹
    // Bç‚¹: (dx - tailLength, dy) è½¬æŠ˜ç‚¹
    // Cç‚¹: (dx, dy) ç»ˆç‚¹(æ–‡å­—å¤„)
    
    const bx = dx - tailLength;
    const by = dy;
    
    // ç¬¬ä¸€æ®µï¼šæ–œçº¿ (A -> B)
    const len1 = Math.hypot(bx, by);
    const ang1 = Math.atan2(by, bx) * 180 / Math.PI;
    
    const seg1 = document.createElement('div');
    seg1.className = 'guide-line-segment';
    seg1.style.width = `${len1}px`;
    seg1.style.height = '1.5px';
    seg1.style.backgroundColor = lineColor;
    seg1.style.left = '0';
    seg1.style.top = '0';
    seg1.style.transformOrigin = '0 50%';
    seg1.style.transform = `rotate(${ang1}deg)`;
    
    // ç¬¬äºŒæ®µï¼šæ°´å¹³çº¿ (B -> C)
    const seg2 = document.createElement('div');
    seg2.className = 'guide-line-segment';
    seg2.style.width = `${Math.abs(tailLength)}px`;
    seg2.style.height = '1.5px';
    seg2.style.backgroundColor = lineColor;
    
    // å®šä½ç¬¬äºŒæ®µ
    seg2.style.top = `${by}px`;
    if (tailLength > 0) {
        seg2.style.left = `${bx}px`; // å‘å³å»¶ä¼¸
    } else {
        seg2.style.left = `${dx}px`; // å‘å·¦å»¶ä¼¸ (èµ·ç‚¹å®é™…ä¸Šæ˜¯C)
    }

    label.appendChild(seg1);
    label.appendChild(seg2);
  }

  // ä¸­å¿ƒåœ†ç‚¹
  const dot = document.createElement('div');
  dot.className = 'guide-line-dot';
  dot.style.left = '0';
  dot.style.top = '0';
  dot.style.backgroundColor = lineColor;
  
  // æ–‡å­—èƒ¶å›Š
  const pill = document.createElement('div');
  pill.className = 'guide-text-pill';
  pill.innerText = text;
  pill.style.position = 'absolute';
  pill.style.left = `${dx}px`;
  pill.style.top = `${dy}px`;
  // å‚ç›´å±…ä¸­ï¼Œæ°´å¹³æ ¹æ®æ–¹å‘åç§»
  pill.style.transform = `translate(${dx > 0 ? '0' : '-100%'}, -50%)`;
  
  label.appendChild(dot);
  label.appendChild(pill);
  wrapper.appendChild(label);
}
function showFocusBlob(tCol, res, animate = false) {
  const con = document.getElementById('focusContainer');
  con.innerHTML = '';
  const w = document.createElement('div');
  w.className = animate ? 'focus-blob-wrapper' : 'focus-blob-wrapper active';
  
  if (isGuideVisible) {
      w.classList.add('show-guides');
  }
  
  if (globalSession.minError !== null) updateStatusBadge(globalSession.minError);
  const deltaBadge = document.createElement('div');
  deltaBadge.className = 'delta-e-badge';
  deltaBadge.innerText = 'Î”E: ' + res.deviation.toFixed(2);
  deltaBadge.onclick = (e) => { e.stopPropagation(); showDeltaPopover(); };
  w.appendChild(deltaBadge);
  const blo = document.createElement('div');
  blo.className = 'focus-blob';
  blo.style.backgroundColor = res.simHex;
  blo.style.setProperty('--target-color', tCol);
  w.appendChild(blo);
  
  // ALWAYS create guides so they exist in DOM for toggling
  createGuideLabel("ç›®æ ‡(å›¾ç‰‡)è‰²", -10, 0, -100, -35, w);
  createGuideLabel("è°ƒåˆè‰²", 45, -28, 130, -75, w);
  
  res.ingredients.forEach((x, i) => {
    const s = document.createElement('div');
    s.className = 'focus-ingredient';
    s.style.backgroundColor = x.hex;
    const fS = Math.max(9, Math.sqrt(x.amount) * 6.0 + 4);
    s.style.width = fS + 'px';
    s.style.height = fS + 'px';
    if (x.isWater) {
      s.style.border = '1px solid #ddd';
      s.style.background = '#F0F8FF';
      const wi = document.createElement('div');
      wi.innerText = 'ğŸ’§';
      wi.style.fontSize = (fS * 0.55) + 'px';
      s.appendChild(wi);
    }
    const txt = document.createElement('span');
    txt.innerText = Math.round(x.amount) + '%';
    if (fS >= 1) s.appendChild(txt);
    const lbl = document.createElement('div');
    lbl.className = 'ingredient-label';
    lbl.innerText = x.name;
    s.appendChild(lbl);
    
    // Start: 10 deg (PI/18), End: 170 deg (17PI/18), Span: 160 deg
    let a = res.ingredients.length === 1 ? Math.PI / 2 : (Math.PI / 18 + i * ((16 * Math.PI / 18) / (res.ingredients.length - 1)));
    const dist = 72 + 12 + fS / 2;
    const tx = Math.cos(a) * dist;
    const ty = Math.sin(a) * dist;
    s.style.setProperty('--tx', `${tx}px`);
    s.style.setProperty('--ty', `${ty}px`);
    w.appendChild(s);
    
    // ALWAYS create recipe label
    if (i === 0) {
      createGuideLabel("é…æ–¹è‰²", tx, ty-15, tx + 25, ty - 45, w);
    }
  });
  con.appendChild(w);
  if (animate) requestAnimationFrame(() => setTimeout(() => w.classList.add('active'), 50));
}
// ... (rest of the file remains same, keeping helper functions)
const fileInput=document.getElementById('fileInput'), imgElement=document.getElementById('paletteImg'), imgWrapper=document.getElementById('imgWrapper'), crosshair=document.getElementById('crosshair'), offC=document.createElement('canvas'), offCtx=offC.getContext('2d');
// ... (rest of the file remains same)
let state={x:0,y:0,scale:1}, crossPos={x:0,y:0}, isM=/Android|iPhone|iPad/i.test(navigator.userAgent);
function setMode(m){currentMode=m;document.getElementById('modeWatercolor').className=m==='watercolor'?'mode-opt active':'mode-opt';document.getElementById('modeOil').className=m==='oil'?'mode-opt active':'mode-opt';showToast(`åˆ‡è‡³${m==='watercolor'?'æ°´å½©':'æ²¹ç”»/ä¸™çƒ¯'}`);updateActivePigments();updateGlobalSessionPool();renderManualBar()}
fileInput.onchange=(e)=>{
  const f=e.target.files[0]; if(!f)return; globalSession.targetRGB = null; globalSession.targetHex = null; globalSession.currentRecipe = [];
  const r=new FileReader(); r.onload=(ev)=>{
    imgElement.onload=()=>{
      document.getElementById('uploadContainer').style.display='none'; imgElement.style.display='block';
      const trayContainer = document.getElementById('focusContainer'); trayContainer.innerHTML = '<div id=\"trayHint\" style=\"color:var(--text-secondary);font-size:13px;font-weight:500;margin-top:16px;opacity:0.8;text-align:center;line-height:1.5;max-width:280px;\">æ‹–åŠ¨å‡†å¿ƒæˆ–åŒæŒ‡ç§»åŠ¨å–è‰²</div>';
      document.getElementById('mainActionGroup').style.display='flex'; document.getElementById('stageHint').classList.add('visible');
      offC.width=imgElement.naturalWidth; offC.height=imgElement.naturalHeight; offCtx.clearRect(0,0,offC.width,offC.height); offCtx.drawImage(imgElement,0,0);
      state = {x:0, y:0, scale:1}; crossPos = {x:0, y:0}; setTimeout(()=>resetV(),50); 
      crosshair.style.display='block'; document.getElementById('pickBtn').style.display='flex';
      setTimeout(() => crosshair.classList.add('guide-active'), 100);
    }; imgElement.src=ev.target.result;
  }; r.readAsDataURL(f); e.target.value = '';
};
function resetV(){const r=imgWrapper.getBoundingClientRect();if(r.width===0)return;const ir=imgElement.naturalWidth/imgElement.naturalHeight,sr=r.width/r.height;state.scale=ir>sr?(r.width*0.9)/imgElement.naturalWidth:(r.height*0.9)/imgElement.naturalHeight;state.x=(r.width-imgElement.naturalWidth*state.scale)/2;state.y=(r.height-imgElement.naturalHeight*state.scale)/2;crossPos={x:0,y:0};upC();upT()}
function upT(){imgElement.style.transform=`translate3d(${state.x}px,${state.y}px,0) scale(${state.scale})`}
function upC(){crosshair.style.transform=`translate(calc(-50% + ${crossPos.x}px),calc(-50% + ${crossPos.y}px))`}
let isD=false,sX=0,sY=0,iX=0,iY=0,iDist=0,iScale=1,pX=0,pY=0,isDC=false;
crosshair.ontouchstart=(e)=>{ e.preventDefault(); crosshair.classList.remove('guide-active'); if(e.touches.length===1){isDC=true;isD=false;sX=e.touches[0].clientX;sY=e.touches[0].clientY;iX=crossPos.x;iY=crossPos.y;e.stopPropagation()} };
crosshair.onmousedown=(e)=>{ e.preventDefault(); crosshair.classList.remove('guide-active'); isDC=true;isD=false;sX=e.clientX;sY=e.clientY;iX=crossPos.x;iY=crossPos.y;e.stopPropagation() };
function hGM(cx,cy){if(isDC){const r=imgWrapper.getBoundingClientRect(),w=r.width/2-20,h=r.height/2-20;let nx=iX+(cx-sX),ny=iY+(cy-sY);crossPos.x=Math.max(-w,Math.min(w,nx));crossPos.y=Math.max(-h,Math.min(h,ny));upC();return true}return false}
imgWrapper.ontouchstart=(e)=>{if(e.touches.length===2){isDC=false;e.preventDefault();iDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);iScale=state.scale;const r=imgWrapper.getBoundingClientRect(),cx=(e.touches[0].clientX+e.touches[1].clientX)/2-r.left,cy=(e.touches[0].clientY+e.touches[1].clientY)/2-r.top;pX=(cx-state.x)/state.scale;pY=(cy-state.y)/state.scale;iX=state.x;iY=state.y}};
imgWrapper.ontouchmove=(e)=>{if(isDC){hGM(e.touches[0].clientX,e.touches[0].clientY);upRP();return}if(e.touches.length===2){e.preventDefault();const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);if(iDist>0){state.scale=iScale*(d/iDist);const r=imgWrapper.getBoundingClientRect(),cx=(e.touches[0].clientX+e.touches[1].clientX)/2-r.left,cy=(e.touches[0].clientY+e.touches[1].clientY)/2-r.top;state.x=cx-pX*state.scale;state.y=cy-pY*state.scale;upT();upRP()}}};
imgWrapper.onmousedown=(e)=>{if(imgElement.style.display==='none')return;isD=true;sX=e.clientX;sY=e.clientY;iX=state.x;iY=state.y};
window.onmousemove=(e)=>{if(isDC){hGM(e.clientX,e.clientY);upRP()}else if(isD){state.x=iX+(e.clientX-sX);state.y=iY+(e.clientY-sY);upT();upRP()}};
window.onmouseup=()=>{isDC=isD=false}; window.ontouchend=()=>{isDC=isD=false}; window.ontouchcancel=()=>isDC=isD=false;
imgWrapper.onwheel=(e)=>{e.preventDefault();const d=e.deltaY>0?0.9:1.1;state.scale*=d;const r=imgWrapper.getBoundingClientRect(),mx=e.clientX-r.left,my=e.clientY-r.top;state.x=mx-(mx-state.x)*d;state.y=my-(my-state.y)*d;upT();upRP()};
function upRP(){
  if(!imgElement.src||imgElement.style.display==='none')return;
  const r=imgWrapper.getBoundingClientRect(),cx=r.left+r.width/2+crossPos.x,cy=r.top+r.height/2+crossPos.y;
  const c=getGAC(cx,cy);
  if(c){
    const col=getAvgC(c);
    if(col){
      globalSession.targetRGB=[col.r,col.g,col.b]; globalSession.targetHex=`rgb(${col.r},${col.g},${col.b})`; globalSession.currentRecipe=[];
      const existingBlob = document.querySelector('.focus-blob');
      if(existingBlob) existingBlob.style.setProperty('--target-color', globalSession.targetHex); else renderPM(globalSession.targetHex, null);
      showAnalyzingState();
      if(moveDebounceTimer) clearTimeout(moveDebounceTimer);
      moveDebounceTimer = setTimeout(()=>{ const lim=solveRecipe(col.r,col.g,col.b,true); globalSession.minError = lim.minError; renderPM(globalSession.targetHex,lim.minError); }, 20);
    }
  }
}
function getGAC(sx,sy){const r=imgElement.getBoundingClientRect();if(sx<r.left||sx>r.right||sy<r.top||sy>r.bottom)return null;return {x:Math.floor((sx-r.left)*(imgElement.naturalWidth/r.width)),y:Math.floor((sy-r.top)*(imgElement.naturalHeight/r.height))}}
function getAvgC(c){
  const r=imgElement.getBoundingClientRect(),sf=imgElement.naturalWidth/r.width,rad=Math.max(0.5,6*sf),rng=Math.ceil(rad),sx=Math.max(0,c.x-rng),sy=Math.max(0,c.y-rng),ex=Math.min(imgElement.naturalWidth,c.x+rng),ey=Math.min(imgElement.naturalHeight,c.y+rng),w=ex-sx,h=ey-sy; if(w<=0||h<=0)return null;const dat=offCtx.getImageData(sx,sy,w,h).data;let rsum=0,gsum=0,bsum=0,cnt=0;
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){if(Math.pow((sx+x)-c.x,2)+Math.pow((sy+y)-c.y,2)<=rad*rad){const i=(y*w+x)*4;rsum+=dat[i];gsum+=dat[i+1];bsum+=dat[i+2];cnt++}}
  return cnt===0?null:{r:Math.round(rsum/cnt),g:Math.round(gsum/cnt),b:Math.round(bsum/cnt)};
}
function renderPM(tCol,minE){
  const con=document.getElementById('focusContainer');con.innerHTML=''; const w=document.createElement('div');w.className='focus-blob-wrapper active'; updateStatusBadge(minE);
  const b=document.createElement('div');b.className='focus-blob preview-mode';b.style.setProperty('--target-color',tCol);w.appendChild(b);con.appendChild(w);
  document.getElementById('manualBar').style.display='flex';document.getElementById('manualBarHeader').style.display='flex';
}
function showInfo(){showToast("æ¬¢è¿ä½¿ç”¨æ™“è‰² Â· è°ƒè‰²åŠ©æ‰‹ã€‚å–è‰²åç‚¹å‡»â€œè‡ªåŠ¨è°ƒè‰²â€å³å¯è·å–é…æ–¹ã€‚")}
// SHARE FUNCTIONALITY - ç»ˆæä¿®å¤ç‰ˆï¼šå½»åº•ç§»é™¤ä¸Šæ–¹å¹²æ‰°å…ƒç´ 
// SHARE FUNCTIONALITY - ä¿®å¤æ ‡ç­¾æº¢å‡ºã€è´¨é‡ä¸é˜´å½±ä¸¢å¤±çš„ç»ˆæç‰ˆæœ¬
function triggerShare() {
  document.body.classList.add('capture-mode');
  showToast("æ­£åœ¨ç”Ÿæˆé«˜æ¸…è°ƒè‰²å¡...");
  
  const scrollY = window.scrollY;
  window.scrollTo(0, 0);

  // æˆªå›¾é…ç½®ï¼šå¼ºåˆ¶ä¸€ä¸ªè¶³å¤Ÿå®½çš„è§†å£ï¼Œä¿è¯æ ‡ç­¾æœ‰ç©ºé—´æ‘†æ”¾
  const options = {
    useCORS: true,
    scale: 3,             // 3å€é‡‡æ ·ä¿è¯æ–‡å­—å’Œé˜´å½±è¾¹ç¼˜ç»†è…»
    backgroundColor: null, // é€æ˜èƒŒæ™¯ä»¥å®ç°åœ†è§’
    logging: false,
    width: 480,           // å¼ºåˆ¶ç”»å¸ƒå®½åº¦ä¸º 480px
    windowWidth: 480,     // æ¨¡æ‹Ÿ 480px å®½çš„æµè§ˆå™¨çª—å£è¿›è¡Œå¸ƒå±€
    onclone: (clonedDoc) => {
        const clonedBody = clonedDoc.body;
        const tray = clonedDoc.getElementById('tray');
        const footer = clonedDoc.querySelector('.app-footer');
        const manualBar = clonedDoc.querySelector('.manual-adjust-bar');
        
        // 1. ã€ç¯å¢ƒé‡ç½®ã€‘
        // å¼ºåˆ¶å…‹éš†åçš„ body å®½åº¦ï¼Œé˜²æ­¢å®ƒç»§æ‰¿æ‰‹æœºçª„å±å¸ƒå±€
        clonedBody.style.width = '480px';
        clonedBody.style.height = 'auto';
        clonedBody.style.display = 'flex';
        clonedBody.style.flexDirection = 'column';
        clonedBody.style.alignItems = 'center';
        clonedBody.style.background = 'transparent';
        
        // 2. ã€æ„å»ºç‹¬ç«‹å¡ç‰‡ã€‘
        // æ¸…ç©ºåŸæœ‰çš„æ‰€æœ‰å¹²æ‰°å…ƒç´ ï¼Œåªä¿ç•™æˆ‘ä»¬è¦æˆªå–çš„å¡ç‰‡ç»“æ„
        clonedBody.innerHTML = '';
        
        // å¤–å±‚åŒ…è£…ï¼šæä¾› 40px ç•™ç™½ä»¥å®Œæ•´æ˜¾ç¤ºå¡ç‰‡çš„æŠ•å½±å’Œæº¢å‡ºçš„æ ‡ç­¾
        const outerSpace = clonedDoc.createElement('div');
        outerSpace.style.padding = '40px';
        outerSpace.style.width = '100%';
        outerSpace.style.boxSizing = 'border-box';
        outerSpace.style.display = 'flex';
        outerSpace.style.justifyContent = 'center';

        // å¡ç‰‡æœ¬ä½“
        const card = clonedDoc.createElement('div');
        card.style.width = '400px'; 
        card.style.backgroundColor = '#F7F8FA';
        card.style.borderRadius = '32px';
        // å¼ºåŒ–é˜´å½±ï¼šhtml2canvas å¯¹é€æ˜åº¦é˜´å½±æ”¯æŒæœ‰é™ï¼Œæˆ‘ä»¬ç¨å¾®åŠ é‡ä¸€ç‚¹
        card.style.boxShadow = '0 30px 80px rgba(0,0,0,0.18)'; 
        card.style.position = 'relative';
        card.style.overflow = 'visible'; // æå…¶å…³é”®ï¼šè®¾ä¸º visible æ ‡ç­¾æ‰èƒ½é£å‡ºå¡ç‰‡å¤–æ˜¾ç¤º
        
        // 3. ã€æ¬è¿å†…å®¹ã€‘
        card.appendChild(tray);
        if (footer) card.appendChild(footer);
        outerSpace.appendChild(card);
        clonedBody.appendChild(outerSpace);
        
        // 4. ã€å†…å®¹æ ·å¼ä¿®æ­£ã€‘
        // å¼ºåˆ¶ tray æ’‘æ»¡å¡ç‰‡ï¼Œå¹¶å»æ‰å®ƒåœ¨ç½‘é¡µä¸Šçš„å®šä½åå·®
        tray.style.width = '100%';
        tray.style.marginTop = '0';
        tray.style.paddingBottom = '0';
        tray.style.background = 'transparent';
        tray.style.boxShadow = 'none';
        tray.style.borderRadius = '0';
        tray.style.flex = 'none';
        
        if (manualBar) {
            manualBar.style.paddingBottom = '10px';
            manualBar.style.marginBottom = '0';
        }

        if (footer) {
            footer.style.display = 'block';
            footer.style.position = 'static'; 
            footer.style.transform = 'none';
            footer.style.margin = '0'; 
            footer.style.marginTop = '0px'; 
            footer.style.padding = '10px 20px 30px 20px'; // åº•éƒ¨ç•™ç™½
            footer.style.background = 'transparent';
            footer.style.opacity = '0.8';
        }
    }
  };

  html2canvas(document.body, options).then(canvas => {
    document.body.classList.remove('capture-mode');
    window.scrollTo(0, scrollY);
    
    // å¯¼å‡ºä¸ºé«˜æ¸… PNG
    const imgData = canvas.toDataURL("image/png", 1.0);
    const resultImg = document.getElementById('shareResultImg');
    resultImg.src = imgData;
    document.getElementById('shareResultOverlay').classList.add('active');
  }).catch(err => {
    document.body.classList.remove('capture-mode');
    window.scrollTo(0, scrollY);
    showToast("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•");
    console.error("Screenshot error:", err);
  });
}
function closeShareOverlay() {
  document.getElementById('shareResultOverlay').classList.remove('active');
}
window.addEventListener('DOMContentLoaded', () => initApp());
document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
document.addEventListener('dblclick', function(e) { e.preventDefault(); }, { passive: false });
</script>
</body>
</html>