<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR ææ‘¹åŠ©æ‰‹ | è§†è§‰ç»´åº¦</title>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #000; }
        
        /* === æ–°å¢ï¼šå±å¹•è°ƒè¯•æ—¥å¿—å° === */
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0, 0, 0, 0.5); 
            color: #0f0; 
            font-family: monospace; 
            font-size: 9px;
            overflow-y: auto; 
            z-index: 10000;
            padding: 5px;
            pointer-events: none;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* === å…¨å±€è§†å£å®¹å™¨ === */
        #global-viewport {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            transform-origin: center center;
            will-change: transform;
            z-index: 0;
        }

        #bg-video {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; 
        }

        #screen-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: auto; overflow: hidden;
            display: none; cursor: grab;
            perspective: 1000px; 
            perspective-origin: center center;
        }
        #screen-layer:active { cursor: grabbing; }
        
        #screen-img {
            position: absolute;
            top: 50%; left: 50%;
            max-width: 80%; 
            max-height: 80%;
            pointer-events: none; 
            /* ä¿®æ”¹æ ¸å¿ƒï¼šé”šç‚¹æ”¹ä¸ºåº•éƒ¨ä¸­å¿ƒï¼Œç¬¦åˆææ‘¹ä¹ æƒ¯ */
            transform-origin: center bottom;
            transform: translate(-50%, -50%);
            transform-style: preserve-3d; 
            will-change: transform, opacity;
        }

        /* === UI æ§åˆ¶å±‚ (æ·±åº¦ç˜¦èº«ç‰ˆ) === */
        .ui-layer {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 320px; 
            background: rgba(10, 10, 12, 0.7); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px; 
            padding: 10px 12px; 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            display: flex; flex-direction: column; 
            gap: 2px; 
            color: white; z-index: 100;
            transition: height 0.3s ease;
        }

        .btn-minimize {
            position: absolute; top: 5px; right: 5px;
            width: 20px; height: 20px; padding: 0;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; border: none; cursor: pointer; color: #ccc;
        }
        
        #restore-btn {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 44px; height: 44px; border-radius: 22px;
            background: rgba(20, 20, 22, 0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white; font-size: 20px; 
            display: none; 
            align-items: center; justify-content: center;
            z-index: 99; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        #btn-focus {
            position: fixed; top: 20px; right: 20px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            display: none; 
            align-items: center; gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
        }

        .row { 
            display: flex; align-items: center; justify-content: space-between; gap: 8px; 
            height: 32px; 
        }
        
        .label { 
            font-size: 11px; 
            min-width: 42px; 
            color: #ccc; 
            text-align: right; 
            line-height: 1;
        }
        
        /* === æ»‘å—æ ·å¼ === */
        input[type=range] { 
            -webkit-appearance: none; 
            flex: 1; 
            background: transparent;
            height: 40px; 
            margin: 0;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px; 
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            border: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px; 
            width: 24px; 
            border-radius: 50%;
            background: #fff;
            box-shadow: 0 1px 5px rgba(0,0,0,0.5);
            margin-top: -10px; 
            position: relative;
            z-index: 10;
        }

        button.panel-btn {
            flex: 1; 
            padding: 6px 0; 
            border-radius: 6px; 
            border: none;
            background: rgba(255,255,255,0.1); 
            color: white;
            font-size: 12px; 
            font-weight: 500; 
            cursor: pointer; 
            transition: 0.2s;
        }
        button.active { background: #007AFF; color: white; }

        /* æ–°å¢ï¼šæ›´å¤šè®¾ç½®å®¹å™¨ */
        #more-controls {
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            gap: 2px;
        }
        
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        #file-input { display: none; }
    </style>
</head>
<body>

    <!-- å±å¹•æ—¥å¿—çª—å£ -->
    <div id="debug-console">æ—¥å¿—çª—å£ (ç­‰å¾…æ“ä½œ)...</div>

    <div id="start-screen">
        <h1 style="margin-bottom: 10px;">ğŸ¨ ææ‘¹åŠ©æ‰‹</h1>
        <p style="opacity: 0.6; margin-bottom: 40px; font-size: 14px;">é€è§†å åŠ  Â· æç®€ç‰ˆ</p>
        <div style="display: flex; flex-direction: column; gap: 15px; width: 200px;">
            <button onclick="document.getElementById('file-input').click()" style="background: #333; border: 1px solid #555; padding: 12px; border-radius: 8px; color:white;">
                1. é€‰æ‹©å›¾ç‰‡
            </button>
            <button id="btn-start-cam" onclick="startApp()" class="active" style="display: none; padding: 12px; border-radius: 8px; border:none; background:#007AFF; color:white;">
                2. å¯åŠ¨æ‘„åƒå¤´
            </button>
        </div>
        <input type="file" id="file-input" accept="image/*">
        <p id="file-name" style="margin-top: 20px; font-size: 12px; color: #007AFF;"></p>
    </div>

    <!-- å…¨å±€è§†å£ -->
    <div id="global-viewport">
        <video id="bg-video" autoplay playsinline muted></video>
        <div id="screen-layer">
            <img id="screen-img" src="" alt="Overlay">
        </div>
    </div>

    <button onclick="toggleFocus()" id="btn-focus">ğŸ¯ é”å®šå¯¹ç„¦</button>
    <button id="restore-btn" onclick="toggleUI(true)">ğŸ› ï¸</button>

    <div class="ui-layer" id="controls" style="display: none;">
        <button class="btn-minimize" onclick="toggleUI(false)">ğŸ”½</button>

        <!-- å·¥å…·æ  -->
        <div style="display: flex; justify-content: space-between; gap: 8px; margin-bottom: 4px;">
             <!-- æ›´æ¢å›¾ç‰‡ -->
             <button class="panel-btn" onclick="document.getElementById('file-input').click()" style="background: rgba(0,122,255,0.25); color: #4facfe;">ğŸ“‚ æ¢å›¾</button>
             <!-- æ–°å¢ï¼šæ‰‹åŠ¨åˆ‡æ¢é•œå¤´ (é»˜è®¤éšè—) -->
             <button class="panel-btn" id="btn-switch-cam" onclick="switchCamera()" style="display:none; background: rgba(255,255,255,0.15);">ğŸ”„ åˆ‡æ¢é•œå¤´</button>
        </div>

        <!-- å¸¸ç”¨è®¾ç½® (å¸¸é©») -->
        <div class="row">
            <span class="label">é€æ˜</span>
            <input type="range" id="opacity" min="0" max="1" step="0.001" value="0.5" oninput="updateVisuals()">
        </div>
        <div class="row">
            <span class="label">ç¼©æ”¾</span>
            <input type="range" id="scale" min="0.1" max="5.7" step="0.001" value="1" oninput="updateVisuals()">
        </div>

        <!-- æ›´å¤šè®¾ç½®æŒ‰é’® -->
        <button class="panel-btn" id="btn-more" onclick="toggleMore()" style="background: rgba(255,255,255,0.05); color: #aaa; margin: 4px 0; font-size: 11px; padding: 4px 0;">ï¹€ æ›´å¤šè®¾ç½® (æ—‹è½¬/è§†è§’)</button>

        <!-- æŠ˜å åŒºåŸŸ -->
        <div id="more-controls">
            <div class="row">
                <span class="label">æ—‹è½¬</span>
                <input type="range" id="rotateZ" min="-180" max="180" step="1" value="0" oninput="updateVisuals()">
            </div>
            <div class="row">
                <span class="label">ä¿¯ä»°</span>
                <input type="range" id="rotateX" min="-60" max="60" step="1" value="0" oninput="updateVisuals()">
            </div>
            <div class="row">
                <span class="label">è§†è·</span>
                <input type="range" id="perspective" min="200" max="1800" step="10" value="1000" oninput="updateVisuals()">
            </div>
        </div>
        
        <div style="display: flex; gap: 8px; margin-top: 6px;">
            <button class="panel-btn" onclick="toggleLock()" id="btn-lock">ğŸ”“ é”å®šç”»é¢</button>
            <button class="panel-btn" onclick="resetParams()">é‡ç½®</button>
        </div>
    </div>

    <script>
        // æ—¥å¿—è¾…åŠ©å‡½æ•°
        function log(msg) {
            const consoleDiv = document.getElementById('debug-console');
            if (consoleDiv) {
                consoleDiv.innerHTML += `<div>> ${msg}</div>`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
            console.log(msg);
        }

        const state = {
            imageLoaded: false,
            locked: false,
            focusLocked: false, 
            videoTrack: null,   
            videoDevices: [], // å­˜å‚¨æ‰€æœ‰è§†é¢‘è®¾å¤‡
            currentDeviceIndex: 0,
            opacity: 0.5,
            scale: 1, 
            rotateZ: 0,
            perspective: 1000, 
            rotateX: 0,
            screenX: 0,
            screenY: 0
        };

        const els = {
            startScreen: document.getElementById('start-screen'),
            fileInput: document.getElementById('file-input'),
            btnStartCam: document.getElementById('btn-start-cam'),
            fileName: document.getElementById('file-name'),
            screenLayer: document.getElementById('screen-layer'), 
            screenImg: document.getElementById('screen-img'),
            controls: document.getElementById('controls'),
            restoreBtn: document.getElementById('restore-btn'),
            bgVideo: document.getElementById('bg-video'),
            btnLock: document.getElementById('btn-lock'),
            viewport: document.getElementById('global-viewport'),
            btnSwitch: document.getElementById('btn-switch-cam'), // æ–°å¢
            inputs: {
                opacity: document.getElementById('opacity'),
                scale: document.getElementById('scale'),
                rotateZ: document.getElementById('rotateZ'),
                perspective: document.getElementById('perspective'),
                rotateX: document.getElementById('rotateX')
            }
        };

        function toggleUI(show) {
            els.controls.style.display = show ? 'flex' : 'none';
            els.restoreBtn.style.display = show ? 'none' : 'flex';
        }

        // æ–°å¢ï¼šåˆ‡æ¢æ›´å¤šè®¾ç½®æ˜¾ç¤º
        function toggleMore() {
            const moreDiv = document.getElementById('more-controls');
            const btn = document.getElementById('btn-more');
            if (moreDiv.style.display === 'none' || moreDiv.style.display === '') {
                moreDiv.style.display = 'flex';
                btn.innerText = "ï¸¿ æ”¶èµ·è®¾ç½®";
            } else {
                moreDiv.style.display = 'none';
                btn.innerText = "ï¹€ æ›´å¤šè®¾ç½® (æ—‹è½¬/è§†è§’)";
            }
        }

        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const imgUrl = URL.createObjectURL(file);
            els.screenImg.src = imgUrl;
            els.screenImg.onload = () => {
                state.imageLoaded = true;
                els.fileName.innerText = `âœ… å·²é€‰: ${file.name}`;
                els.btnStartCam.style.display = 'block'; 
            };
        });

        // æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨ startApp ä¸­åŠ å…¥è‡ªåŠ¨å¯»æ‰¾å¹¿è§’é•œå¤´çš„é€»è¾‘
        async function startApp() {
            if (!state.imageLoaded) return;
            try {
                log("æ­£åœ¨è¯·æ±‚é»˜è®¤åç½®æ‘„åƒå¤´...");
                
                // 1. è·å–è®¾å¤‡åˆ—è¡¨ä¾›æ‰‹åŠ¨åˆ‡æ¢
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    state.videoDevices = devices.filter(d => d.kind === 'videoinput');
                    log(`å…±å‘ç° ${state.videoDevices.length} ä¸ªè§†é¢‘è®¾å¤‡`);
                    state.videoDevices.forEach((d, i) => log(`[${i}] ${d.label || 'Unknown Camera'}`));
                    
                    // å¦‚æœå¤šäº1ä¸ªè®¾å¤‡ï¼Œæ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
                    if (state.videoDevices.length > 1) {
                        els.btnSwitch.style.display = 'block';
                    }
                } catch (e) {
                    log("æ— æ³•åˆ—ä¸¾è®¾å¤‡: " + e.message);
                }

                // 2. å°è¯•æ™ºèƒ½é€‰æ‹©ï¼ˆä¹‹å‰é€»è¾‘ä¿ç•™ï¼Œä½†å¢åŠ æ‰‹åŠ¨å›é€€ï¼‰
                let constraints = { 
                    audio: false, 
                    video: { facingMode: 'environment', width: { ideal: 3840 }, height: { ideal: 2160 } } 
                };

                // å°è¯•æŸ¥æ‰¾å¹¿è§’
                const wideDevice = state.videoDevices.find(d => {
                    const l = d.label.toLowerCase();
                    return (l.includes('back') || l.includes('rear') || l.includes('environment')) && 
                           (l.includes('wide') || l.includes('0.5') || l.includes('ultra') || l.includes('å¹¿è§’'));
                });

                if (wideDevice) {
                    log(`æ™ºèƒ½åŒ¹é…åˆ°å¹¿è§’: ${wideDevice.label}`);
                    constraints.video = { 
                        deviceId: { exact: wideDevice.deviceId },
                        width: { ideal: 3840 }, 
                        height: { ideal: 2160 } 
                    };
                    // æ›´æ–°å½“å‰ç´¢å¼•
                    state.currentDeviceIndex = state.videoDevices.indexOf(wideDevice);
                }

                await initStream(constraints);

            } catch (err) {
                log(`å¯åŠ¨é”™è¯¯: ${err.name}`);
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–HTTPSã€‚\n" + err);
            }
            els.startScreen.style.display = 'none';
            els.screenLayer.style.display = 'block'; 
            els.screenImg.style.display = 'block';
            els.controls.style.display = 'flex';
            updateVisuals();
        }

        // å°è£…æµåˆå§‹åŒ–
        async function initStream(constraints) {
            if (state.videoTrack) {
                state.videoTrack.stop();
            }
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            els.bgVideo.srcObject = stream;
            state.videoTrack = stream.getVideoTracks()[0];
            
            // æ£€æŸ¥å¯¹ç„¦èƒ½åŠ›
            const capabilities = state.videoTrack.getCapabilities ? state.videoTrack.getCapabilities() : {};
            if (capabilities.focusMode) {
                document.getElementById('btn-focus').style.display = 'flex';
                log("è®¾å¤‡æ”¯æŒå¯¹ç„¦æ§åˆ¶");
            }
        }

        // æ–°å¢ï¼šæ‰‹åŠ¨åˆ‡æ¢æ‘„åƒå¤´é€»è¾‘
        async function switchCamera() {
            if (state.videoDevices.length < 2) return;
            
            // å¾ªç¯ç´¢å¼•
            state.currentDeviceIndex = (state.currentDeviceIndex + 1) % state.videoDevices.length;
            const device = state.videoDevices[state.currentDeviceIndex];
            
            log(`åˆ‡æ¢è‡³: ${device.label || 'Camera ' + state.currentDeviceIndex}`);
            
            const constraints = {
                audio: false,
                video: { 
                    deviceId: { exact: device.deviceId },
                    width: { ideal: 3840 }, 
                    height: { ideal: 2160 } 
                }
            };
            
            try {
                await initStream(constraints);
            } catch (e) {
                log("åˆ‡æ¢å¤±è´¥: " + e.message);
            }
        }

        async function toggleFocus() {
            if (!state.videoTrack) return;
            const btn = document.getElementById('btn-focus');
            state.focusLocked = !state.focusLocked;
            try {
                const mode = state.focusLocked ? 'manual' : 'continuous';
                // ä¿®å¤ï¼šç§»é™¤ focusDistanceï¼Œä»…åˆ‡æ¢æ¨¡å¼ï¼Œé¿å… out of range é”™è¯¯
                const constraints = { advanced: [{ focusMode: mode }] };
                
                await state.videoTrack.applyConstraints(constraints);
                
                btn.innerHTML = state.focusLocked ? "ğŸ¯ å·²é”å¯¹ç„¦" : "ğŸ¯ é”å®šå¯¹ç„¦";
                btn.style.background = state.focusLocked ? "rgba(255, 59, 48, 0.8)" : "rgba(0, 0, 0, 0.5)";
                btn.style.borderColor = state.focusLocked ? "transparent" : "rgba(255,255,255,0.2)";
                log(`å¯¹ç„¦æ¨¡å¼: ${mode}`);
            } catch (err) {
                state.focusLocked = !state.focusLocked; // å›æ»šçŠ¶æ€
                log(`å¯¹ç„¦æ“ä½œè¢«æ‹’ç»: ${err.message}`); // ä»…è®°å½•æ—¥å¿—ï¼Œä¸å†å¼¹çª—æ‰“æ‰°
            }
        }

        function updateVisuals() {
            state.opacity = els.inputs.opacity.value;
            state.scale = els.inputs.scale.value;
            state.rotateZ = els.inputs.rotateZ.value;
            state.perspective = els.inputs.perspective.value;
            state.rotateX = els.inputs.rotateX.value;

            els.screenLayer.style.perspective = `${state.perspective}px`;
            els.screenImg.style.opacity = state.opacity;
            
            // ä¿æŒ transform-origin ä¸º center bottom
            const transform = `
                translate(calc(-50% + ${state.screenX}px), calc(-50% + ${state.screenY}px)) 
                rotateX(${state.rotateX}deg) 
                rotateZ(${state.rotateZ}deg) 
                scale(${state.scale})
            `;
            els.screenImg.style.transform = transform;
        }

        let isDragging = false;
        let startX = 0, startY = 0;
        let initialScreenX = 0, initialScreenY = 0;
        let globalScale = 1, globalTx = 0, globalTy = 0;
        let startDist = 0;
        let startCenter = {x:0, y:0};
        let startGlobal = {s:1, x:0, y:0};

        const getDist = (t1, t2) => Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        const getCenter = (t1, t2) => ({ x: (t1.clientX + t2.clientX)/2, y: (t1.clientY + t2.clientY)/2 });

        const onDown = (clientX, clientY) => {
            if (state.locked) return;
            isDragging = true;
            startX = clientX;
            startY = clientY;
            initialScreenX = state.screenX;
            initialScreenY = state.screenY;
            els.screenLayer.style.cursor = 'grabbing';
        };

        const onMove = (clientX, clientY) => {
            if (!isDragging) return;
            const dx = clientX - startX;
            const dy = clientY - startY;
            state.screenX = initialScreenX + dx;
            state.screenY = initialScreenY + dy;
            updateVisuals();
        };

        const onUp = () => { isDragging = false; els.screenLayer.style.cursor = 'grab'; };

        els.screenLayer.addEventListener('touchstart', e => {
            if (e.touches.length === 2) {
                isDragging = false;
                startDist = getDist(e.touches[0], e.touches[1]);
                startCenter = getCenter(e.touches[0], e.touches[1]);
                startGlobal = { s: globalScale, x: globalTx, y: globalTy };
                e.preventDefault();
            } else if (e.touches.length === 1) {
                onDown(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, {passive:false});

        window.addEventListener('touchmove', e => {
            if (e.touches.length === 2) {
                const currDist = getDist(e.touches[0], e.touches[1]);
                const currCenter = getCenter(e.touches[0], e.touches[1]);
                const scaleRatio = currDist / startDist;
                globalScale = Math.max(1, Math.min(startGlobal.s * scaleRatio, 5));
                const dx = currCenter.x - startCenter.x;
                const dy = currCenter.y - startCenter.y;
                globalTx = startGlobal.x + dx;
                globalTy = startGlobal.y + dy;
                els.viewport.style.transform = `translate(${globalTx}px, ${globalTy}px) scale(${globalScale})`;
                e.preventDefault();
            } else if (e.touches.length === 1 && isDragging) {
                e.preventDefault();
                onMove(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, {passive:false});

        window.addEventListener('touchend', e => {
            if (e.touches.length === 0) onUp();
        });
        
        els.screenLayer.addEventListener('mousedown', e => { e.preventDefault(); onDown(e.clientX, e.clientY); });
        window.addEventListener('mousemove', e => { if (isDragging) { e.preventDefault(); onMove(e.clientX, e.clientY); } });
        window.addEventListener('mouseup', onUp);

        function resetParams() {
            state.screenX = 0; state.screenY = 0;
            els.inputs.scale.value = 1; 
            els.inputs.rotateZ.value = 0;
            els.inputs.perspective.value = 1000; 
            els.inputs.rotateX.value = 0;
            globalScale = 1; globalTx = 0; globalTy = 0;
            els.viewport.style.transform = `translate(0px, 0px) scale(1)`;
            updateVisuals();
        }

        function toggleLock() {
            state.locked = !state.locked;
            els.btnLock.innerText = state.locked ? "ğŸ”’ å·²é”å®š" : "ğŸ”“ é”å®šç”»é¢";
            els.btnLock.style.background = state.locked ? "#FF3B30" : "rgba(255,255,255,0.15)";
            els.inputs.scale.disabled = state.locked;
            els.inputs.rotateZ.disabled = state.locked;
            els.inputs.perspective.disabled = state.locked;
            els.inputs.rotateX.disabled = state.locked;
        }

        document.body.addEventListener('click', () => { if(els.bgVideo.paused) els.bgVideo.play(); }, {once:true});
    </script>
</body>
</html>