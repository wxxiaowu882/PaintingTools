<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR ææ‘¹åŠ©æ‰‹ | è§†è§‰ç»´åº¦</title>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #000; }
        
        /* === èƒŒæ™¯è§†é¢‘å±‚ === */
        #bg-video {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 1; 
            /* é•œåƒç¿»è½¬é€šå¸¸ä¸éœ€è¦ï¼Œé™¤éæ˜¯å‰ç½®æ‘„åƒå¤´ï¼Œè¿™é‡Œé»˜è®¤åç½® */
        }

        /* === å±å¹•é™æ€å±‚ === */
        #screen-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: auto; overflow: hidden;
            display: none; cursor: grab;
            /* 3D é€è§†å®¹å™¨è®¾ç½® - åˆå§‹å€¼ï¼Œä¼šè¢«JSè¦†ç›– */
            perspective: 1000px; 
            perspective-origin: center center;
        }
        #screen-layer:active { cursor: grabbing; }
        
        #screen-img {
            position: absolute;
            top: 50%; left: 50%;
            /* å…³é”®ï¼šé™åˆ¶æœ€å¤§å°ºå¯¸ */
            max-width: 80%; 
            max-height: 80%;
            pointer-events: none; 
            /* é”šç‚¹è®¾ä¸ºä¸­å¿ƒ */
            transform-origin: center center;
            /* åˆå§‹å±…ä¸­ */
            transform: translate(-50%, -50%);
            /* å¼€å¯3Då˜æ¢æ”¯æŒ */
            transform-style: preserve-3d; 
            will-change: transform, opacity;
        }

        /* === UI æ§åˆ¶å±‚ === */
        .ui-layer {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 12px; /* ç¨å¾®ç´§å‡‘ä¸€ç‚¹ */
            color: white; z-index: 100;
        }

        /* æ”¶èµ·æŒ‰é’®æ ·å¼ */
        .btn-minimize {
            position: absolute; top: 10px; right: 10px;
            width: 30px; height: 30px; padding: 0;
            background: rgba(255,255,255,0.1); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; border: none; cursor: pointer; color: #ccc;
        }
        
        /* æ¢å¤æŒ‰é’®æ ·å¼ */
        #restore-btn {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 48px; height: 48px; border-radius: 24px;
            background: rgba(28, 28, 30, 0.9); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white; font-size: 20px; 
            display: none; /* é»˜è®¤éšè— */
            align-items: center; justify-content: center;
            z-index: 99; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .label { font-size: 13px; min-width: 55px; color: #ccc; text-align: right; }
        input[type=range] { flex: 1; accent-color: #007AFF; height: 4px; border-radius: 2px; }
        
        button {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            background: rgba(255,255,255,0.15); color: white;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        button.active { background: #007AFF; color: white; }
        
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }
        #file-input { display: none; }
        
        .section-title {
            font-size: 12px; color: #666; margin-top: 5px; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="margin-bottom: 10px;">ğŸ¨ ææ‘¹åŠ©æ‰‹ (é€è§†ç‰ˆ)</h1>
        <p style="opacity: 0.6; margin-bottom: 40px; font-size: 14px;">æ›´ç¨³ã€æ›´å‡†çš„é€è§†å åŠ æ–¹æ¡ˆ</p>
        <div style="display: flex; flex-direction: column; gap: 15px; width: 200px;">
            <button onclick="document.getElementById('file-input').click()" style="background: #333; border: 1px solid #555;">
                1. é€‰æ‹©å›¾ç‰‡
            </button>
            <button id="btn-start-cam" onclick="startApp()" class="active" style="display: none;">
                2. å¯åŠ¨æ‘„åƒå¤´
            </button>
        </div>
        <input type="file" id="file-input" accept="image/*">
        <p id="file-name" style="margin-top: 20px; font-size: 12px; color: #007AFF;"></p>
    </div>

    <!-- èƒŒæ™¯è§†é¢‘æµ -->
    <video id="bg-video" autoplay playsinline muted></video>

    <div id="screen-layer">
        <img id="screen-img" src="" alt="Overlay">
    </div>

    <!-- æ¢å¤æŒ‰é’® (åˆå§‹éšè—) -->
    <button id="restore-btn" onclick="toggleUI(true)">ğŸ› ï¸</button>

    <div class="ui-layer" id="controls" style="display: none;">
        <button class="btn-minimize" onclick="toggleUI(false)">ğŸ”½</button>

        <!-- æ–°å¢ï¼šæ›´æ¢å›¾ç‰‡æŒ‰é’® -->
        <button onclick="document.getElementById('file-input').click()" style="background: rgba(0,122,255,0.2); color: #007AFF; margin-right: 30px;">ğŸ“‚ æ›´æ¢å›¾ç‰‡</button>

        <div class="section-title">åŸºç¡€è°ƒæ•´</div>
        <div class="row">
            <span class="label">é€æ˜åº¦</span>
            <!-- ä¼˜åŒ–ï¼šstep æ”¹ä¸º 0.001 ä»¥å®ç°æ›´å¹³æ»‘çš„æ»‘åŠ¨ -->
            <input type="range" id="opacity" min="0" max="1" step="0.001" value="0.5" oninput="updateVisuals()">
        </div>
        <div class="row">
            <span class="label">ç¼©æ”¾</span>
            <!-- ä¿®æ”¹èŒƒå›´ 0.1 ~ 5.7 (åŸæœ€å¤§å€¼çš„3å€)ï¼Œstep æ›´ç»†è‡´ -->
            <input type="range" id="scale" min="0.1" max="5.7" step="0.001" value="1" oninput="updateVisuals()">
        </div>
        <div class="row">
            <span class="label">å¹³é¢æ—‹è½¬</span>
            <!-- ä¿®æ”¹èŒƒå›´ -180 ~ 180ï¼Œé»˜è®¤ 0 åœ¨æ­£ä¸­é—´ -->
            <input type="range" id="rotateZ" min="-180" max="180" step="1" value="0" oninput="updateVisuals()">
        </div>

        <div class="section-title">3D é€è§†çŸ«æ­£ (è§£å†³æ–œæ‹å˜å½¢)</div>
        <div class="row">
            <span class="label">ä¿¯ä»°è§†è§’</span> <!-- Rotate X -->
            <input type="range" id="rotateX" min="-60" max="60" step="1" value="0" oninput="updateVisuals()">
        </div>
        <div class="row">
            <span class="label">è§†è·(ç„¦è·)</span> <!-- Moved here -->
            <!-- ä¿®æ”¹èŒƒå›´ 200 ~ 1800ï¼Œé»˜è®¤ 1000 åœ¨æ­£ä¸­é—´ -->
            <input type="range" id="perspective" min="200" max="1800" step="10" value="1000" oninput="updateVisuals()">
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button onclick="toggleLock()" id="btn-lock">ğŸ”“ é”å®šç”»é¢</button>
            <button onclick="resetParams()">é‡ç½®å‚æ•°</button>
        </div>
    </div>

    <script>
        const state = {
            imageLoaded: false,
            locked: false,
            // åŸºç¡€å‚æ•°
            opacity: 0.5,
            scale: 1, 
            rotateZ: 0,
            // é€è§†å‚æ•°
            perspective: 1000, 
            rotateX: 0,
            rotateY: 0, // ä¿ç•™å˜é‡ä½†é»˜è®¤0
            // ä½ç§»
            screenX: 0,
            screenY: 0
        };

        const els = {
            startScreen: document.getElementById('start-screen'),
            fileInput: document.getElementById('file-input'),
            btnStartCam: document.getElementById('btn-start-cam'),
            fileName: document.getElementById('file-name'),
            screenLayer: document.getElementById('screen-layer'), 
            screenImg: document.getElementById('screen-img'),
            controls: document.getElementById('controls'),
            restoreBtn: document.getElementById('restore-btn'),
            bgVideo: document.getElementById('bg-video'),
            btnLock: document.getElementById('btn-lock'),
            inputs: {
                opacity: document.getElementById('opacity'),
                scale: document.getElementById('scale'),
                rotateZ: document.getElementById('rotateZ'),
                perspective: document.getElementById('perspective'),
                rotateX: document.getElementById('rotateX')
                // rotateY removed
            }
        };

        // UI åˆ‡æ¢
        function toggleUI(show) {
            els.controls.style.display = show ? 'flex' : 'none';
            els.restoreBtn.style.display = show ? 'none' : 'flex';
        }

        // 1. ä¸Šä¼ å›¾ç‰‡
        els.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                els.screenImg.src = event.target.result;
                state.imageLoaded = true;
                els.fileName.innerText = `âœ… å·²é€‰: ${file.name}`;
                els.btnStartCam.style.display = 'block'; 
            };
            reader.readAsDataURL(file);
        });

        // 2. å¯åŠ¨æ‘„åƒå¤´å’Œåº”ç”¨
        async function startApp() {
            if (!state.imageLoaded) return;
            
            // å°è¯•å¯åŠ¨åç½®æ‘„åƒå¤´
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: { 
                        facingMode: 'environment', // ä¼˜å…ˆåç½®
                        // ä¼˜åŒ–ï¼šå°è¯•è¯·æ±‚ 4K åˆ†è¾¨ç‡ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å›é€€åˆ°è®¾å¤‡æ”¯æŒçš„æœ€é«˜åˆ†è¾¨ç‡
                        width: { ideal: 3840 },    
                        height: { ideal: 2160 } 
                    }
                });
                els.bgVideo.srcObject = stream;
            } catch (err) {
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¡®ä¿å…è®¸è®¿é—®æˆ–ä½¿ç”¨HTTPSç¯å¢ƒã€‚\né”™è¯¯: " + err);
                // å³ä½¿æ‘„åƒå¤´å¤±è´¥ï¼Œä¹Ÿå…è®¸è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼ˆå¯èƒ½ç”¨æˆ·åªæƒ³çœ‹å›¾ï¼‰
            }

            els.startScreen.style.display = 'none';
            els.screenLayer.style.display = 'block'; 
            els.screenImg.style.display = 'block';
            els.controls.style.display = 'flex';
            
            updateVisuals();
        }

        // 3. æ ¸å¿ƒè§†è§‰æ›´æ–° (CSS 3D Transform)
        function updateVisuals() {
            state.opacity = els.inputs.opacity.value;
            state.scale = els.inputs.scale.value;
            state.rotateZ = els.inputs.rotateZ.value;
            // è·å–é€è§†å€¼
            state.perspective = els.inputs.perspective.value;
            state.rotateX = els.inputs.rotateX.value;
            // state.rotateY = els.inputs.rotateY.value; // Removed

            // åº”ç”¨é€è§†åˆ°çˆ¶å®¹å™¨
            els.screenLayer.style.perspective = `${state.perspective}px`;

            els.screenImg.style.opacity = state.opacity;
            
            // CSS å˜æ¢é¡ºåºï¼šä½ç§» -> é€è§† -> 3Dæ—‹è½¬ -> å¹³é¢æ—‹è½¬ -> ç¼©æ”¾
            // æ³¨æ„ï¼štranslate(-50%, -50%) ç”¨äºå°†å›¾ç‰‡ä¸­å¿ƒå¯¹é½åˆ° (0,0) ç‚¹ï¼Œæ˜¯å¸ƒå±€åŸºå‡†
            // é¢å¤–çš„ translate(${state.screenX}px, ...) æ˜¯ç”¨æˆ·çš„æ‹–æ‹½ä½ç§»
            
            const transform = `
                translate(calc(-50% + ${state.screenX}px), calc(-50% + ${state.screenY}px))
                rotateX(${state.rotateX}deg)
                rotateY(${state.rotateY}deg)
                rotateZ(${state.rotateZ}deg)
                scale(${state.scale})
            `;
            
            els.screenImg.style.transform = transform;
        }

        // 4. æ‹–æ‹½é€»è¾‘ (æ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸)
        let isDragging = false;
        let startX = 0, startY = 0;
        let initialScreenX = 0, initialScreenY = 0;

        const onDown = (clientX, clientY) => {
            if (state.locked) return;
            isDragging = true;
            startX = clientX;
            startY = clientY;
            initialScreenX = state.screenX;
            initialScreenY = state.screenY;
            els.screenLayer.style.cursor = 'grabbing';
        };

        const onMove = (clientX, clientY) => {
            if (!isDragging) return;
            const dx = clientX - startX;
            const dy = clientY - startY;
            state.screenX = initialScreenX + dx;
            state.screenY = initialScreenY + dy;
            updateVisuals();
        };

        const onUp = () => { isDragging = false; els.screenLayer.style.cursor = 'grab'; };

        // ç»‘å®šäº‹ä»¶
        els.screenLayer.addEventListener('mousedown', e => { e.preventDefault(); onDown(e.clientX, e.clientY); });
        window.addEventListener('mousemove', e => { if (isDragging) { e.preventDefault(); onMove(e.clientX, e.clientY); } });
        window.addEventListener('mouseup', onUp);
        
        els.screenLayer.addEventListener('touchstart', e => { 
            if (e.touches.length === 1) { 
                e.preventDefault(); 
                onDown(e.touches[0].clientX, e.touches[0].clientY); 
            }
        }, {passive:false});
        
        window.addEventListener('touchmove', e => { 
            if (isDragging && e.touches.length === 1) { 
                e.preventDefault(); 
                onMove(e.touches[0].clientX, e.touches[0].clientY); 
            }
        }, {passive:false});
        
        window.addEventListener('touchend', onUp);

        // è¾…åŠ©åŠŸèƒ½
        function resetParams() {
            state.screenX = 0; state.screenY = 0;
            els.inputs.scale.value = 1; 
            els.inputs.rotateZ.value = 0;
            els.inputs.perspective.value = 1000; // é‡ç½®é€è§†
            els.inputs.rotateX.value = 0;
            // els.inputs.rotateY.value = 0; // Removed
            updateVisuals();
        }

        function toggleLock() {
            state.locked = !state.locked;
            els.btnLock.innerText = state.locked ? "ğŸ”’ å·²é”å®š" : "ğŸ”“ é”å®šç”»é¢";
            els.btnLock.style.background = state.locked ? "#FF3B30" : "rgba(255,255,255,0.15)";
            
            // é”å®š UI é¢æ¿ä¸­å½±å“ä½ç½®çš„æ§ä»¶ (å¯é€‰)
            els.inputs.scale.disabled = state.locked;
            els.inputs.rotateZ.disabled = state.locked;
            els.inputs.perspective.disabled = state.locked;
            els.inputs.rotateX.disabled = state.locked;
            // els.inputs.rotateY.disabled = state.locked; // Removed
        }

        // è§£å†³ iOS Safari è§†é¢‘è‡ªåŠ¨æ’­æ”¾é—®é¢˜
        document.body.addEventListener('click', () => {
            if(els.bgVideo.paused) els.bgVideo.play();
        }, {once:true});

    </script>
</body>
</html>